---
import Icon from '@components/ui/Icon.astro';

const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];

const days = ['日', '一', '二', '三', '四', '五', '六'];

const today = new Date();
const currentYear = today.getFullYear();
const startDate = new Date(today);
startDate.setFullYear(startDate.getFullYear() - 1);
startDate.setDate(startDate.getDate() - startDate.getDay());

function getMonthPositions() {
  const positions: { month: number; week: number }[] = [];
  let lastMonth = -1;
  
  const currentDate = new Date(startDate);
  let dayIndex = 0;
  
  while (currentDate <= today) {
    const week = Math.floor(dayIndex / 7);
    const month = currentDate.getMonth();
    if (month !== lastMonth) {
      positions.push({ month, week });
      lastMonth = month;
    }
    currentDate.setDate(currentDate.getDate() + 1);
    dayIndex++;
  }
  
  return positions;
}

const monthPositions = getMonthPositions();
const totalDays = Math.ceil((today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
const totalWeeks = Math.ceil(totalDays / 7);
---

<section class="contribution">
  <div class="contribution-container">
    <div class="contribution-card">
      <div class="contribution-header">
        <h2 class="contribution-title">
          访问活动
        </h2>
        <p class="contribution-subtitle">{currentYear}</p>
      </div>
      
      <div class="contribution-graph-wrapper">
        <div class="contribution-graph" id="contribution-graph" data-year={currentYear}>
          <div class="contribution-months">
            {monthPositions.map(({ month, week }) => (
              <span 
                class="contribution-month" 
                style={`--week: ${week}`}
              >
                {months[month]}
              </span>
            ))}
          </div>
          
          <div class="contribution-body">
            <div class="contribution-days">
              {days.map((day, i) => (
                <span class="contribution-day">{i % 2 === 0 ? day : ''}</span>
              ))}
            </div>
            
            <div class="contribution-grid" id="contribution-grid">
              {Array.from({ length: totalWeeks }).map((_, weekIndex) => (
                <div class="contribution-week">
                  {Array.from({ length: 7 }).map((_, dayIndex) => {
                    const dayOffset = weekIndex * 7 + dayIndex;
                    const cellDate = new Date(startDate);
                    cellDate.setDate(cellDate.getDate() + dayOffset);
                    
                    if (cellDate > today) return null;
                    
                    const dateStr = cellDate.toISOString().split('T')[0];
                    const displayDateStr = cellDate.toLocaleDateString(
                      'zh-CN',
                      { month: 'short', day: 'numeric', year: 'numeric' }
                    );
                    
                    return (
                      <div 
                        class="contribution-cell"
                        data-date={dateStr}
                        data-level="0"
                        title={displayDateStr}
                      />
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
      
      <div class="contribution-legend">
        <span class="contribution-legend-text">
          少
        </span>
        <div class="contribution-legend-cells">
          {[0, 1, 2, 3, 4, 5].map((level) => (
            <div class="contribution-cell" data-level={level} />
          ))}
        </div>
        <span class="contribution-legend-text">
          多
        </span>
      </div>
    </div>
  </div>
</section>

<style>
  .contribution {
    padding: var(--space-8) var(--space-4);
  }
  
  @media (min-width: 768px) {
    .contribution {
      padding: var(--space-12) var(--space-4);
    }
  }
  
  .contribution-container {
    max-width: var(--container-lg);
    margin: 0 auto;
  }
  
  .contribution-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    box-shadow: var(--card-shadow);
  }
  
  @media (min-width: 768px) {
    .contribution-card {
      padding: var(--space-8);
    }
  }
  
  .contribution-header {
    text-align: center;
    margin-bottom: var(--space-6);
  }
  
  .contribution-title {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: var(--font-medium);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }
  
  @media (min-width: 768px) {
    .contribution-title {
      font-size: var(--text-2xl);
    }
  }
  
  .contribution-subtitle {
    font-family: var(--font-number);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    letter-spacing: 0.05em;
  }
  
  .contribution-graph-wrapper {
    display: flex;
    justify-content: center;
    overflow-x: auto;
    padding: var(--space-2) 0;
  }
  
  .contribution-graph {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: fit-content;
  }
  
  .contribution-months {
    display: flex;
    margin-left: 40px;
    margin-bottom: var(--space-3);
    position: relative;
    height: 20px;
  }
  
  .contribution-month {
    position: absolute;
    left: calc(var(--week) * 15px);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-weight: var(--font-medium);
  }
  
  .contribution-body {
    display: flex;
    gap: var(--space-3);
  }
  
  .contribution-days {
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding-top: 2px;
  }
  
  .contribution-day {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    height: 12px;
    line-height: 12px;
  }
  
  .contribution-grid {
    display: flex;
    gap: 3px;
  }
  
  .contribution-week {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }
  
  .contribution-cell {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-sm);
    background-color: var(--contribution-0);
    transition: transform var(--duration-fast) var(--ease-default);
  }
  
  .contribution-cell[data-level="1"] {
    background-color: var(--contribution-1);
  }
  
  .contribution-cell[data-level="2"] {
    background-color: var(--contribution-2);
  }
  
  .contribution-cell[data-level="3"] {
    background-color: var(--contribution-3);
  }
  
  .contribution-cell[data-level="4"] {
    background-color: var(--contribution-4);
  }
  
  .contribution-cell[data-level="5"] {
    background-color: var(--contribution-5);
  }
  
  .contribution-cell:hover {
    transform: scale(1.3);
  }
  
  .contribution-legend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-5);
  }
  
  .contribution-legend-text {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }
  
  .contribution-legend-cells {
    display: flex;
    gap: 3px;
  }
</style>

<script>
  const API_BASE = 'https://api.ustc.dev';
  const REFRESH_INTERVAL = 60000;
  
  async function fetchHeatmapData() {
    try {
      const graph = document.getElementById('contribution-graph');
      const year = graph?.getAttribute('data-year') || 2026;
      
      const response = await fetch(`${API_BASE}/stats/heatmap?year=${year}`);
      const result = await response.json();
      
      if (result.success && result.data) {
        updateHeatmap(result.data, result.maxCount);
      }
    } catch (error) {
      console.warn('Failed to fetch heatmap data:', error);
    }
  }
  
  function updateHeatmap(data: Record<string, number>, maxCount: number) {
    const cells = document.querySelectorAll('.contribution-cell[data-date]');
    
    cells.forEach(cell => {
      const date = cell.getAttribute('data-date');
      if (date && data[date]) {
        const count = data[date];
        const level = calculateLevel(count, maxCount);
        cell.setAttribute('data-level', String(level));
        
        const existingTitle = cell.getAttribute('title') || '';
        const baseTitle = existingTitle.split(' - ')[0];
        const countText = count === 1 ? '1 次访问' : `${count} 次访问`;
        cell.setAttribute('title', `${baseTitle} - ${countText}`);
      }
    });
  }
  
  function calculateLevel(count: number, maxCount: number): number {
    if (count === 0) return 0;
    if (count <= 10) return 1;
    if (count <= 20) return 2;
    if (count <= 30) return 3;
    if (count <= 40) return 4;
    return 5;
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    fetchHeatmapData();
    setInterval(fetchHeatmapData, REFRESH_INTERVAL);
  });
</script>
