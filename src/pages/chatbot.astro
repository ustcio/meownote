---
import '@styles/global.css';
import { getLangFromUrl } from '@i18n';

const lang = getLangFromUrl(Astro.url);
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    
    <title>{lang === 'zh' ? 'AI 助手 - Meow Note' : 'AI Assistant - Meow Note'}</title>
    <meta name="title" content={lang === 'zh' ? 'AI 助手 - Meow Note' : 'AI Assistant - Meow Note'} />
    <meta name="description" content={lang === 'zh' ? '智能 AI 对话助手，支持通义千问、豆包 2.0 Pro、豆包 2.0 Code 多模型' : 'Intelligent AI chat assistant with Qwen and Doubao models support'} />
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <meta name="theme-color" content="#ffffff" />
    <meta name="color-scheme" content="light dark" />
    
    <script is:inline>
      (function() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
  </head>
  <body>
    <div class="chat-app" data-lang={lang} role="application" aria-label={lang === 'zh' ? 'AI 对话助手' : 'AI Chat Assistant'}>
    
    <!-- Sidebar - Claude Style -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label={lang === 'zh' ? '对话历史' : 'Chat history'}>
      <div class="sidebar-header">
        <a href="/" class="sidebar-brand" aria-label={lang === 'zh' ? '返回首页' : 'Go to homepage'}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span class="brand-text">Meow Note</span>
        </a>
        <button class="close-sidebar" id="close-sidebar" type="button" aria-label={lang === 'zh' ? '关闭侧边栏' : 'Close sidebar'}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <!-- Navigation Links -->
      <nav class="sidebar-nav" aria-label={lang === 'zh' ? '主导航' : 'Main navigation'}>
        <a href="/" class="nav-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span>{lang === 'zh' ? '首页' : 'Home'}</span>
        </a>
        <button class="nav-item active" id="nav-chatbot" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>{lang === 'zh' ? 'AI 对话' : 'AI Chat'}</span>
        </button>
        <a href="/kit" class="nav-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          <span>{lang === 'zh' ? '工具箱' : 'Toolkit'}</span>
        </a>
      </nav>
      
      <button class="new-chat-btn" id="new-chat-btn" type="button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>{lang === 'zh' ? '新对话' : 'New Chat'}</span>
      </button>
      
      <div class="sidebar-search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="search" class="search-input" id="search-input" placeholder={lang === 'zh' ? '搜索对话...' : 'Search chats...'} aria-label={lang === 'zh' ? '搜索对话历史' : 'Search chat history'} />
      </div>
      
      <div class="sidebar-content" id="sidebar-content" role="list">
        <div class="sidebar-section" data-section="today">
          <button class="section-header" data-toggle="today" aria-expanded="true" aria-controls="history-today" type="button">
            <svg class="section-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>{lang === 'zh' ? '今天' : 'Today'}</span>
            <span class="section-count" id="count-today">0</span>
          </button>
          <div class="history-list" id="history-today" role="list"></div>
        </div>
        
        <div class="sidebar-section" data-section="week">
          <button class="section-header" data-toggle="week" aria-expanded="true" aria-controls="history-week" type="button">
            <svg class="section-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>{lang === 'zh' ? '过去 7 天' : 'Last 7 days'}</span>
            <span class="section-count" id="count-week">0</span>
          </button>
          <div class="history-list" id="history-week" role="list"></div>
        </div>
        
        <div class="sidebar-section" data-section="older">
          <button class="section-header" data-toggle="older" aria-expanded="true" aria-controls="history-older" type="button">
            <svg class="section-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>{lang === 'zh' ? '更早' : 'Earlier'}</span>
            <span class="section-count" id="count-older">0</span>
          </button>
          <div class="history-list" id="history-older" role="list"></div>
        </div>
      </div>
      
      <div class="sidebar-footer">
        <button class="sidebar-action" id="settings-btn" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
          <span>{lang === 'zh' ? '设置' : 'Settings'}</span>
        </button>
        <button class="sidebar-action danger" id="clear-all-btn" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          <span>{lang === 'zh' ? '清空对话' : 'Clear chats'}</span>
        </button>
      </div>
    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" aria-hidden="true"></div>

    <!-- Main Content - Claude Style Layout -->
    <main class="main-content">
      <!-- Header -->
      <header class="chat-header">
        <button class="menu-toggle" id="menu-toggle" type="button" aria-label={lang === 'zh' ? '打开菜单' : 'Open menu'} aria-expanded="false" aria-controls="sidebar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        
        <div class="header-actions">
          <button class="header-action" id="theme-toggle" title={lang === 'zh' ? '切换主题' : 'Toggle theme'} type="button" aria-label={lang === 'zh' ? '切换主题' : 'Toggle theme'}>
            <svg class="theme-icon-light" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <svg class="theme-icon-dark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" style="display: none;">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
          <button class="header-action" id="export-btn" title={lang === 'zh' ? '导出对话' : 'Export chat'} type="button" aria-label={lang === 'zh' ? '导出对话' : 'Export chat'}>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>
        </div>
      </header>

      <!-- Chat Area -->
      <div class="chat-area" id="chat-area" role="log" aria-live="polite" aria-label={lang === 'zh' ? '对话区域' : 'Chat area'}>
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcome-screen">
          <div class="welcome-content">
            <div class="welcome-brand">
              <video class="welcome-logo" autoplay loop muted playsinline preload="auto" aria-hidden="true">
                <source src="/logo.mp4" type="video/mp4" />
              </video>
              <h1 class="welcome-title">{lang === 'zh' ? '你好，我是 Meow' : 'Hello, I\'m Meow'}</h1>
              <p class="welcome-subtitle">{lang === 'zh' ? '你的智能 AI 助手，支持通义千问和豆包 2.0 系列模型' : 'Your intelligent AI assistant with Qwen and Doubao 2.0 models'}</p>
            </div>
            
            <div class="quick-actions">
              <div class="quick-actions-title">{lang === 'zh' ? '快速开始' : 'Quick start'}</div>
              <div class="quick-actions-grid">
                <button class="quick-action" data-prompt={lang === 'zh' ? '帮我写一段 Python 代码，实现快速排序算法' : 'Write a Python function for quick sort algorithm'} type="button">
                  <div class="quick-action-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="16 18 22 12 16 6"></polyline>
                      <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                  </div>
                  <span>{lang === 'zh' ? '编写代码' : 'Write code'}</span>
                </button>
                <button class="quick-action" data-prompt={lang === 'zh' ? '帮我解释一下量子计算的基本原理' : 'Explain the basic principles of quantum computing'} type="button">
                  <div class="quick-action-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 16v-4"></path>
                      <path d="M12 8h.01"></path>
                    </svg>
                  </div>
                  <span>{lang === 'zh' ? '解答问题' : 'Answer question'}</span>
                </button>
                <button class="quick-action" data-prompt={lang === 'zh' ? '帮我写一封商务邮件，主题是项目进度汇报' : 'Write a business email about project progress report'} type="button">
                  <div class="quick-action-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                      <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                  </div>
                  <span>{lang === 'zh' ? '撰写文档' : 'Write document'}</span>
                </button>
                <button class="quick-action" data-prompt={lang === 'zh' ? '帮我想一些创意，关于如何提升团队效率' : 'Give me some ideas on how to improve team efficiency'} type="button">
                  <div class="quick-action-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"></path>
                      <path d="M9 21h6"></path>
                    </svg>
                  </div>
                  <span>{lang === 'zh' ? '头脑风暴' : 'Brainstorm'}</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messages-container" aria-label={lang === 'zh' ? '消息列表' : 'Messages list'}></div>
      </div>

      <!-- Input Area - Claude Style -->
      <div class="input-area" id="input-area">
        <div class="input-container">
          <!-- Model Selector - In Input Area -->
          <div class="model-selector-inline" id="model-selector">
            <button class="model-btn-inline" id="model-btn" type="button" aria-haspopup="listbox" aria-expanded="false" aria-label={lang === 'zh' ? '选择模型' : 'Select model'}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
              </svg>
              <span class="model-name-inline" id="model-name">Doubao 2.0 Pro</span>
              <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="model-dropdown-inline" id="model-dropdown" role="listbox" aria-label={lang === 'zh' ? '模型列表' : 'Model list'}>
              <div class="model-group">
                <div class="model-group-label">Doubao</div>
                <button class="model-option active" data-model="doubao-2.0-pro" data-name="Doubao 2.0 Pro" role="option" aria-selected="true" type="button">
                  <span class="model-option-name">Doubao 2.0 Pro</span>
                  <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button class="model-option" data-model="doubao-2.0-code" data-name="Doubao 2.0 Code" role="option" aria-selected="false" type="button">
                  <span class="model-option-name">Doubao 2.0 Code</span>
                  <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
              </div>
              <div class="model-group">
                <div class="model-group-label">Qwen</div>
                <button class="model-option" data-model="qwen-turbo" data-name="Qwen Turbo" role="option" aria-selected="false" type="button">
                  <span class="model-option-name">Qwen Turbo</span>
                  <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button class="model-option" data-model="qwen-plus" data-name="Qwen Plus" role="option" aria-selected="false" type="button">
                  <span class="model-option-name">Qwen Plus</span>
                  <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <div class="input-wrapper">
            <textarea 
              id="chat-input" 
              class="chat-input" 
              placeholder={lang === 'zh' ? '输入消息...（Shift+Enter 换行）' : 'Type a message... (Shift+Enter for new line)'}
              rows="1"
              aria-label={lang === 'zh' ? '聊天输入框' : 'Chat input'}
              aria-describedby="input-hint"
            ></textarea>
            <div class="input-actions">
              <button class="send-btn" id="send-btn" type="button" disabled aria-label={lang === 'zh' ? '发送消息' : 'Send message'}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <button class="stop-btn" id="stop-btn" type="button" style="display: none;" aria-label={lang === 'zh' ? '停止生成' : 'Stop generation'}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div class="input-hint" id="input-hint">
          <span>{lang === 'zh' ? 'AI 生成内容可能不准确，请核实重要信息' : 'AI may produce inaccurate information, please verify important details'}</span>
        </div>
      </div>
    </main>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite"></div>
  </div>

  <style>
    /* ================================================================================
       Claude Design System - Strict Implementation
       Based on official Claude UI specifications
       ================================================================================ */
    
    /* ================================================================================
       CSS Reset - Minimal & Clean
       ================================================================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: var(--leading-normal);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* ================================================================================
       Design Tokens - Claude Strict Specification
       All values based on 4px grid system
       ================================================================================ */
    :root {
      /* Colors - Light Theme (Exact Claude values) */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F7;
      --bg-tertiary: #E8E8ED;
      --bg-elevated: #FFFFFF;
      --bg-overlay: rgba(0, 0, 0, 0.5);
      
      --text-primary: #1A1A1A;
      --text-secondary: #6B6B6B;
      --text-tertiary: #9A9A9A;
      --text-inverse: #FFFFFF;
      
      --border-color: #E5E5E5;
      --border-light: rgba(0, 0, 0, 0.06);
      --border-focus: #D45D00;
      
      /* Claude Brand Color - Orange */
      --accent-primary: #D45D00;
      --accent-hover: #E86A00;
      --accent-active: #C24E00;
      --accent-light: rgba(212, 93, 0, 0.08);
      --accent-lighter: rgba(212, 93, 0, 0.04);
      --accent-gradient: linear-gradient(135deg, #D45D00 0%, #FF8C47 100%);
      
      /* Semantic Colors */
      --success: #10B981;
      --success-light: rgba(16, 185, 129, 0.08);
      --error: #EF4444;
      --error-light: rgba(239, 68, 68, 0.08);
      --warning: #F59E0B;
      --warning-light: rgba(245, 158, 11, 0.08);
      --info: #3B82F6;
      --info-light: rgba(59, 130, 242, 0.08);
      
      /* Spacing - Strict 4px Grid System */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;
      --space-20: 80px;
      --space-24: 96px;
      
      /* Typography - System Font Stack */
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', Consolas, monospace;
      
      /* Font Sizes - Precise Scale */
      --font-size-xs: 12px;
      --font-size-sm: 13px;
      --font-size-base: 15px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;
      --font-size-3xl: 32px;
      
      /* Font Weights */
      --font-regular: 400;
      --font-medium: 500;
      --font-semibold: 600;
      --font-bold: 700;
      
      /* Line Heights */
      --leading-none: 1;
      --leading-tight: 1.3;
      --leading-snug: 1.4;
      --leading-normal: 1.5;
      --leading-relaxed: 1.6;
      
      /* Border Radius - Consistent Scale */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 20px;
      --radius-full: 9999px;
      
      /* Shadows - Subtle Depth */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.15);
      --shadow-2xl: 0 24px 64px rgba(0, 0, 0, 0.18);
      
      /* Transitions - Claude's Signature Smooth Feel */
      --duration-instant: 0ms;
      --duration-fast: 150ms;
      --duration-normal: 200ms;
      --duration-slow: 300ms;
      --duration-slower: 500ms;
      
      /* Easing - cubic-bezier for natural motion */
      --ease-default: cubic-bezier(0.4, 0, 0.2, 1);
      --ease-in: cubic-bezier(0.4, 0, 1, 1);
      --ease-out: cubic-bezier(0, 0, 0.2, 1);
      --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Z-index Scale */
      --z-base: 0;
      --z-dropdown: 10;
      --z-sticky: 20;
      --z-sidebar: 30;
      --z-modal-overlay: 40;
      --z-modal: 50;
      --z-popover: 60;
      --z-toast: 70;
      
      /* Layout Dimensions */
      --sidebar-width: 260px;
      --header-height: 64px;
      --input-max-width: 800px;
      --message-max-width: 70%;
    }
    
    /* Dark Theme - Exact Claude Dark Values */
    [data-theme="dark"] {
      --bg-primary: #1A1A1A;
      --bg-secondary: #0F0F0F;
      --bg-tertiary: #2A2A2A;
      --bg-elevated: #1C1C1E;
      --bg-overlay: rgba(0, 0, 0, 0.7);
      
      --text-primary: #F5F5F5;
      --text-secondary: #9A9A9A;
      --text-tertiary: #6B6B6B;
      
      --border-color: #3A3A3A;
      --border-light: rgba(255, 255, 255, 0.06);
      --border-focus: #FF8C47;
      
      --accent-primary: #FF8C47;
      --accent-hover: #FFA06A;
      --accent-active: #FF7830;
      --accent-light: rgba(255, 140, 71, 0.12);
      --accent-lighter: rgba(255, 140, 71, 0.06);
      
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
    }
    
    /* ================================================================================
       Layout Structure - Clean & Minimal
       ================================================================================ */
    .chat-app {
      display: flex;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      position: relative;
    }
    
    /* ================================================================================
       Sidebar - Minimalist Claude Design
       Clean, focused, distraction-free
       ================================================================================ */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      z-index: var(--z-sidebar);
      transition: transform var(--duration-slow) var(--ease-default);
      will-change: transform;
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      padding: 0 var(--space-4);
      border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      text-decoration: none;
      color: var(--text-primary);
      font-weight: var(--font-semibold);
      font-size: var(--font-size-lg);
      transition: color var(--duration-fast) var(--ease-default);
    }
    
    .sidebar-brand:hover {
      color: var(--accent-primary);
    }
    
    .brand-text {
      font-family: var(--font-sans);
    }
    
    .close-sidebar {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .close-sidebar:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .new-chat-btn {
      margin: var(--space-4);
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .new-chat-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
      box-shadow: var(--shadow-sm);
    }
    
    /* Sidebar Navigation */
    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      padding: 0 var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      text-decoration: none;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
      width: 100%;
      text-align: left;
    }
    
    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .nav-item.active {
      background: var(--accent-light);
      color: var(--accent-color);
    }
    
    .nav-item svg {
      flex-shrink: 0;
    }
    
    .sidebar-search {
      position: relative;
      margin: 0 var(--space-4) var(--space-4);
    }
    
    .sidebar-search svg {
      position: absolute;
      left: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
    }
    
    .search-input {
      width: 100%;
      height: 40px;
      padding: 0 var(--space-4) 0 var(--space-10);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 0 var(--space-4);
    }
    
    .sidebar-section {
      margin-bottom: var(--space-6);
    }
    
    .section-header {
      width: 100%;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) 0;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: var(--font-size-xs);
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: color var(--duration-fast) var(--ease-default);
    }
    
    .section-header:hover {
      color: var(--text-primary);
    }
    
    .section-chevron {
      transition: transform var(--duration-fast) var(--ease-default);
    }
    
    .section-header[aria-expanded="false"] .section-chevron {
      transform: rotate(-90deg);
    }
    
    .section-count {
      margin-left: auto;
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 11px;
    }
    
    .history-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      margin-top: var(--space-2);
    }
    
    .history-item {
      padding: var(--space-3);
      background: transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .history-item:hover {
      background: var(--bg-tertiary);
    }
    
    .history-item.active {
      background: var(--accent-light);
    }
    
    .history-item-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .history-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .history-date {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }
    
    .sidebar-footer {
      padding: var(--space-4);
      border-top: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .sidebar-action {
      width: 100%;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .sidebar-action:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    .sidebar-action.danger:hover {
      background: var(--error-light);
      color: var(--error-color);
      border-color: var(--error-color);
    }
    
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      opacity: 0;
      visibility: hidden;
      transition: all var(--duration-slow) var(--ease-default);
      z-index: calc(var(--z-sidebar) - 1);
    }
    
    .sidebar-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    
    /* ================================================================================
       Main Content Area
       ================================================================================ */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: margin-left var(--duration-slow) var(--ease-default);
    }
    
    /* Header */
    .chat-header {
      position: sticky;
      top: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-6);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      z-index: var(--z-dropdown);
    }
    
    .menu-toggle {
      display: none;
      width: 40px;
      height: 40px;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .menu-toggle:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .header-action {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .header-action:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    /* Model Selector */
    .model-selector {
      position: relative;
    }
    
    .model-btn {
      height: 40px;
      padding: 0 var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .model-btn:hover {
      background: var(--bg-tertiary);
    }
    
    .model-btn[aria-expanded="true"] {
      background: var(--bg-tertiary);
    }
    
    .model-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-light);
      border-radius: var(--radius-sm);
      color: var(--accent-color);
    }
    
    .model-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }
    
    .chevron {
      color: var(--text-tertiary);
      transition: transform var(--duration-fast) var(--ease-default);
    }
    
    .model-btn[aria-expanded="true"] .chevron {
      transform: rotate(180deg);
    }
    
    .model-dropdown {
      position: absolute;
      top: calc(100% + var(--space-2));
      left: 0;
      width: 320px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-2);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all var(--duration-fast) var(--ease-default);
      z-index: var(--z-modal);
    }
    
    .model-dropdown.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .model-group {
      margin-bottom: var(--space-2);
    }
    
    .model-group:last-child {
      margin-bottom: 0;
    }
    
    .model-group-label {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
      font-weight: var(--font-semibold);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    
    .model-option {
      width: 100%;
      padding: var(--space-3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
      text-align: left;
    }
    
    .model-option:hover {
      background: var(--bg-tertiary);
    }
    
    .model-option.active {
      background: var(--accent-light);
    }
    
    .model-option-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .model-option-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }
    
    .model-option-desc {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }
    
    .check-icon {
      color: var(--accent-color);
      opacity: 0;
      transition: opacity var(--duration-fast) var(--ease-default);
    }
    
    .model-option.active .check-icon {
      opacity: 1;
    }
    
    /* ================================================================================
       Chat Area
       ================================================================================ */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .welcome-screen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-10);
    }
    
    .welcome-screen.hidden {
      display: none;
    }
    
    .welcome-content {
      max-width: 800px;
      text-align: center;
    }
    
    .welcome-brand {
      margin-bottom: var(--space-10);
    }
    
    .welcome-logo {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
    }
    
    .welcome-title {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin-bottom: var(--space-3);
    }
    
    .welcome-subtitle {
      font-size: var(--font-size-lg);
      color: var(--text-secondary);
    }
    
    .quick-actions {
      margin-top: var(--space-8);
    }
    
    .quick-actions-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-semibold);
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
    }
    
    .quick-action {
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .quick-action:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .quick-action-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-light);
      border-radius: var(--radius-md);
      color: var(--accent-color);
    }
    
    .quick-action span {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }
    
    .messages-container {
      flex: 1;
      padding: var(--space-6);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .message {
      display: flex;
      gap: var(--space-4);
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      animation: messageEnter var(--duration-slow) var(--ease-out);
    }
    
    @keyframes messageEnter {
      from {
        opacity: 0;
        transform: translateY(var(--space-4));
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .user-message {
      justify-content: flex-end;
    }
    
    .message-bubble {
      max-width: 70%;
      padding: var(--space-4) var(--space-5);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-sm);
    }
    
    .message-bubble p {
      font-size: var(--font-size-base);
      line-height: var(--leading-relaxed);
      color: var(--text-primary);
      margin: 0;
    }
    
    .assistant-message {
      justify-content: flex-start;
    }
    
    .assistant-avatar {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--claude-gradient);
      border-radius: var(--radius-full);
      color: white;
    }
    
    .message-content {
      flex: 1;
      max-width: calc(100% - 48px);
    }
    
    .message-content p {
      font-size: var(--font-size-base);
      line-height: var(--leading-relaxed);
      color: var(--text-primary);
      margin: 0;
    }
    
    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      gap: var(--space-1);
      padding: var(--space-3) var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      width: fit-content;
      margin-left: calc(var(--space-4) + 32px + var(--space-4));
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-tertiary);
      border-radius: var(--radius-full);
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }
    
    /* ================================================================================
       Input Area
       ================================================================================ */
    .input-area {
      padding: var(--space-4) var(--space-6);
      background: var(--bg-primary);
      border-top: 1px solid var(--border-color);
    }
    
    .input-container {
      max-width: var(--input-max-width);
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
      gap: var(--space-3);
    }
    
    /* Model Selector Inline - In Input Area */
    .model-selector-inline {
      position: relative;
      flex-shrink: 0;
    }
    
    .model-btn-inline {
      height: 44px;
      padding: 0 var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
      color: var(--text-primary);
    }
    
    .model-btn-inline:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
    }
    
    .model-btn-inline[aria-expanded="true"] {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
    }
    
    .model-name-inline {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .model-dropdown-inline {
      position: absolute;
      bottom: calc(100% + var(--space-2));
      left: 0;
      width: 220px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-2);
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all var(--duration-fast) var(--ease-default);
      z-index: var(--z-modal);
    }
    
    .model-dropdown-inline.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .model-dropdown-inline .model-group {
      margin-bottom: var(--space-2);
    }
    
    .model-dropdown-inline .model-group:last-child {
      margin-bottom: 0;
    }
    
    .model-dropdown-inline .model-group-label {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
      font-weight: var(--font-semibold);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    
    .model-dropdown-inline .model-option {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
      text-align: left;
    }
    
    .model-dropdown-inline .model-option:hover {
      background: var(--bg-tertiary);
    }
    
    .model-dropdown-inline .model-option.active {
      background: var(--accent-light);
    }
    
    .model-dropdown-inline .model-option-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }
    
    .model-dropdown-inline .check-icon {
      color: var(--accent-color);
      opacity: 0;
      transition: opacity var(--duration-fast) var(--ease-default);
    }
    
    .model-dropdown-inline .model-option.active .check-icon {
      opacity: 1;
    }
    
    .input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: var(--space-3);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: var(--space-3) var(--space-4);
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .input-wrapper:focus-within {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    
    .chat-input {
      flex: 1;
      min-height: 24px;
      max-height: 200px;
      padding: var(--space-2) 0;
      background: transparent;
      border: none;
      resize: none;
      font-family: var(--font-sans);
      font-size: var(--font-size-base);
      line-height: var(--leading-normal);
      color: var(--text-primary);
    }
    
    .chat-input:focus {
      outline: none;
    }
    
    .chat-input::placeholder {
      color: var(--text-tertiary);
    }
    
    .input-actions {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }
    
    .send-btn,
    .stop-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-color);
      border: none;
      border-radius: var(--radius-md);
      color: white;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .send-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }
    
    .send-btn:disabled {
      background: var(--bg-tertiary);
      cursor: not-allowed;
      transform: none;
    }
    
    .stop-btn {
      background: var(--error-color);
    }
    
    .stop-btn:hover {
      background: #DC2626;
    }
    
    .input-hint {
      text-align: center;
      padding: var(--space-3);
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }
    
    /* ================================================================================
       Toast Notifications
       ================================================================================ */
    .toast-container {
      position: fixed;
      top: var(--space-6);
      right: var(--space-6);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      z-index: var(--z-toast);
    }
    
    .toast {
      min-width: 320px;
      max-width: 480px;
      padding: var(--space-4) var(--space-5);
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      animation: slideIn 0.3s ease;
      border-left: 4px solid;
    }
    
    .toast-success {
      border-left-color: var(--success-color);
    }
    
    .toast-error {
      border-left-color: var(--error-color);
    }
    
    .toast-info {
      border-left-color: var(--info-color);
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(calc(100% + var(--space-6)));
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* ================================================================================
       Responsive Design
       ================================================================================ */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .menu-toggle {
        display: flex;
      }
      
      .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .message-bubble,
      .message-content {
        max-width: 85%;
      }
      
      .model-dropdown {
        left: -100px;
        width: calc(100vw - var(--space-8));
      }
    }
    
    /* ================================================================================
       Dark Theme
       ================================================================================ */
    [data-theme="dark"] {
      --bg-primary: #1A1A1A;
      --bg-secondary: #0F0F0F;
      --bg-tertiary: #2A2A2A;
      --bg-elevated: #1C1C1E;
      --text-primary: #F5F5F5;
      --text-secondary: #9A9A9A;
      --text-tertiary: #6B6B6B;
      --border-color: #3A3A3A;
      --border-light: rgba(255, 255, 255, 0.06);
      --accent-light: rgba(255, 140, 71, 0.12);
      --claude-orange: #FF8C47;
    }
  </style>

  <script>
    // TypeScript interfaces
    interface Message {
      role: 'user' | 'assistant';
      content: string;
      timestamp?: Date;
    }
    
    interface Conversation {
      id: string;
      title: string;
      messages: Message[];
      model: string;
      createdAt: Date;
      updatedAt: Date;
    }
    
    // State
    let currentModel = 'doubao-2.0-pro';
    let currentModelName = 'Doubao 2.0 Pro';
    let chatHistory: Message[] = [];
    let conversations: Conversation[] = [];
    let currentConversationId: string | null = null;
    let isStreaming = false;
    let abortController: AbortController | null = null;
    
    // Language detection
    const lang = document.documentElement.lang || 'en';
    
    // API Base
    const API_BASE = 'https://api.agiera.net';
    
    // Initialize
    function init() {
      console.log('[Chatbot] Initializing...');
      console.log('[Chatbot] Language:', lang);
      
      // Ensure DOM is ready
      if (!document.getElementById('chat-input')) {
        console.error('[Chatbot] Chat input element not found!');
        return;
      }
      
      loadConversations();
      setupEventListeners();
      renderHistory();
      
      console.log('[Chatbot] Initialization complete');
    }
    
    function setupEventListeners() {
      console.log('[Chatbot] Setting up event listeners...');
      
      // Model selection
      const modelBtn = document.getElementById('model-btn');
      const modelDropdown = document.getElementById('model-dropdown');
      
      console.log('[Chatbot] Model button:', modelBtn ? 'found' : 'NOT FOUND');
      console.log('[Chatbot] Model dropdown:', modelDropdown ? 'found' : 'NOT FOUND');
      
      if (modelBtn && modelDropdown) {
        modelBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = modelDropdown.classList.contains('visible');
          console.log('[Chatbot] Model dropdown visible:', isVisible, '-> toggling to:', !isVisible);
          modelDropdown.classList.toggle('visible', !isVisible);
          modelBtn.setAttribute('aria-expanded', isVisible ? 'false' : 'true');
        });
        
        // Model options
        modelDropdown.querySelectorAll('.model-option').forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const model = option.getAttribute('data-model');
            const name = option.getAttribute('data-name');
            console.log('[Chatbot] Model option clicked:', model, name);
            if (model && name) {
              selectModel(model, name);
              modelDropdown.classList.remove('visible');
              modelBtn.setAttribute('aria-expanded', 'false');
            }
          });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!modelDropdown.contains(e.target as Node) && !modelBtn.contains(e.target as Node)) {
            modelDropdown.classList.remove('visible');
            modelBtn.setAttribute('aria-expanded', 'false');
          }
        });
      }
      
      // New chat
      const newChatBtn = document.getElementById('new-chat-btn');
      if (newChatBtn) {
        newChatBtn.addEventListener('click', startNewChat);
      }
      
      // Send message
      const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
      const sendBtn = document.getElementById('send-btn');
      
      console.log('[Chatbot] Chat input:', chatInput ? 'found' : 'NOT FOUND');
      console.log('[Chatbot] Send button:', sendBtn ? 'found' : 'NOT FOUND');
      
      if (chatInput && sendBtn) {
        chatInput.addEventListener('input', () => {
          console.log('[Chatbot] Input event triggered, value:', chatInput.value);
          sendBtn.disabled = chatInput.value.trim() === '';
        });
        
        sendBtn.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) {
              sendMessage();
            }
          }
        });
      } else {
        console.error('[Chatbot] Critical: chat input or send button not found!');
      }
    }
    
    function selectModel(model: string, name: string) {
      currentModel = model;
      currentModelName = name;
      
      const modelName = document.getElementById('model-name');
      if (modelName) {
        modelName.textContent = name;
      }
      
      // Update dropdown
      document.querySelectorAll('.model-option').forEach(opt => {
        const isActive = opt.getAttribute('data-model') === model;
        opt.classList.toggle('active', isActive);
        opt.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      
      showToast(`${lang === 'zh' ? '已切换到' : 'Switched to'} ${name}`, 'success');
    }
    
    async function sendMessage() {
      const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
      const content = chatInput?.value.trim();
      
      console.log('[Chatbot] Sending message:', content);
      console.log('[Chatbot] Current model:', currentModel);
      console.log('[Chatbot] API Base:', API_BASE);
      
      if (!content || isStreaming) {
        console.error('[Chatbot] Aborted: content=', content, 'isStreaming=', isStreaming);
        return;
      }
      
      // Hide welcome screen when sending first message
      const welcomeScreen = document.getElementById('welcome-screen');
      if (welcomeScreen) {
        welcomeScreen.classList.add('hidden');
      }
      
      // Add user message
      addMessage('user', content);
      chatInput.value = '';
      
      // Disable send button
      const sendBtn = document.getElementById('send-btn') as HTMLButtonElement;
      if (sendBtn) {
        sendBtn.disabled = true;
      }
      
      // Show typing indicator
      showTypingIndicator();
      
      try {
        console.log('[Chatbot] Fetching from API:', `${API_BASE}/api/chat`);
        
        const requestBody = {
          message: content,
          model: currentModel,
          history: chatHistory.slice(-10)
        };
        
        console.log('[Chatbot] Request body:', JSON.stringify(requestBody, null, 2));
        
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });
        
        console.log('[Chatbot] Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          console.error('[Chatbot] HTTP error:', response.status, response.statusText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('[Chatbot] Response data:', data);
        
        // Remove typing indicator
        removeTypingIndicator();
        
        if (data.success && data.reply) {
          console.log('[Chatbot] Adding AI response:', data.reply);
          addMessage('assistant', data.reply);
        } else {
          console.error('[Chatbot] API returned error:', data);
          showToast(data.message || 'Failed to get response', 'error');
        }
      } catch (error) {
        console.error('[Chatbot] Fetch error:', error);
        removeTypingIndicator();
        showToast(`Network error: ${error instanceof Error ? error.message : 'Unknown error'}`, 'error');
      }
    }
    
    function addMessage(role: 'user' | 'assistant', content: string) {
      const messagesContainer = document.getElementById('messages-container');
      const chatArea = document.getElementById('chat-area');
      if (!messagesContainer) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}-message`;
      
      if (role === 'user') {
        messageDiv.innerHTML = `
          <div class="message-bubble">
            <p>${escapeHtml(content)}</p>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="assistant-avatar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 16v-4"></path>
              <path d="M12 8h.01"></path>
            </svg>
          </div>
          <div class="message-content">
            <p>${escapeHtml(content)}</p>
          </div>
        `;
      }
      
      messagesContainer.appendChild(messageDiv);
      
      // Scroll to bottom - use chat-area as the scroll container
      if (chatArea) {
        chatArea.scrollTo({
          top: chatArea.scrollHeight,
          behavior: 'smooth'
        });
      }
      
      // Add to history
      chatHistory.push({ role, content, timestamp: new Date() });
      
      // Save conversation
      saveConversation();
    }
    
    function showTypingIndicator() {
      const messagesContainer = document.getElementById('messages-container');
      const chatArea = document.getElementById('chat-area');
      if (!messagesContainer) return;
      
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      `;
      
      messagesContainer.appendChild(typingDiv);
      
      // Scroll to bottom
      if (chatArea) {
        chatArea.scrollTo({
          top: chatArea.scrollHeight,
          behavior: 'smooth'
        });
      }
    }
    
    function removeTypingIndicator() {
      const typingIndicator = document.getElementById('typing-indicator');
      typingIndicator?.remove();
    }
    
    function startNewChat() {
      currentConversationId = null;
      chatHistory = [];
      
      const messagesContainer = document.getElementById('messages-container');
      const welcomeScreen = document.getElementById('welcome-screen');
      
      if (messagesContainer) {
        messagesContainer.innerHTML = '';
      }
      
      if (welcomeScreen) {
        welcomeScreen.classList.remove('hidden');
      }
      
      renderHistory();
    }
    
    function loadConversations() {
      const stored = localStorage.getItem('chatbot_conversations');
      if (stored) {
        try {
          conversations = JSON.parse(stored);
        } catch (e) {
          conversations = [];
        }
      }
    }
    
    function saveConversation() {
      if (!currentConversationId) {
        currentConversationId = Date.now().toString();
        conversations.unshift({
          id: currentConversationId,
          title: chatHistory[0]?.content.slice(0, 50) || 'New Chat',
          messages: [...chatHistory],
          model: currentModel,
          createdAt: new Date(),
          updatedAt: new Date()
        });
      } else {
        const conv = conversations.find(c => c.id === currentConversationId);
        if (conv) {
          conv.messages = [...chatHistory];
          conv.updatedAt = new Date();
        }
      }
      
      localStorage.setItem('chatbot_conversations', JSON.stringify(conversations));
      renderHistory();
    }
    
    function renderHistory() {
      const todayList = document.getElementById('history-today');
      const weekList = document.getElementById('history-week');
      const olderList = document.getElementById('history-older');
      
      if (!todayList || !weekList || !olderList) return;
      
      todayList.innerHTML = '';
      weekList.innerHTML = '';
      olderList.innerHTML = '';
      
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      let todayCount = 0, weekCount = 0, olderCount = 0;
      
      conversations.forEach(conv => {
        const convDate = new Date(conv.createdAt);
        const item = document.createElement('div');
        item.className = 'history-item';
        if (conv.id === currentConversationId) item.classList.add('active');
        
        item.innerHTML = `
          <div class="history-item-content">
            <span class="history-title">${escapeHtml(conv.title)}</span>
            <span class="history-date">${formatDate(convDate)}</span>
          </div>
        `;
        
        item.addEventListener('click', () => loadConversation(conv.id));
        
        if (convDate >= today) {
          todayList.appendChild(item);
          todayCount++;
        } else if (convDate >= weekAgo) {
          weekList.appendChild(item);
          weekCount++;
        } else {
          olderList.appendChild(item);
          olderCount++;
        }
      });
      
      document.getElementById('count-today')!.textContent = todayCount.toString();
      document.getElementById('count-week')!.textContent = weekCount.toString();
      document.getElementById('count-older')!.textContent = olderCount.toString();
    }
    
    function loadConversation(id: string) {
      const conv = conversations.find(c => c.id === id);
      if (!conv) return;
      
      currentConversationId = id;
      chatHistory = [...conv.messages];
      
      const messagesContainer = document.getElementById('messages-container');
      const welcomeScreen = document.getElementById('welcome-screen');
      
      if (messagesContainer) {
        messagesContainer.innerHTML = '';
        chatHistory.forEach(msg => addMessage(msg.role, msg.content, false));
      }
      
      if (welcomeScreen) {
        welcomeScreen.classList.add('hidden');
      }
      
      renderHistory();
    }
    
    function showToast(message: string, type: 'success' | 'error' | 'info') {
      const toastContainer = document.getElementById('toast-container');
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatDate(date: Date): string {
      return date.toLocaleTimeString(lang === 'zh' ? 'zh-CN' : 'en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Initialize on load
    init();
  </script>
</body>
</html>
