---
import '@styles/global.css';
import { getLangFromUrl, useTranslations } from '@i18n';
import Header from '@components/layout/Header.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    
    <title>{t('chatbot.title')} - Meow Note</title>
    <meta name="title" content={`${t('chatbot.title')} - Meow Note`} />
    <meta name="description" content={lang === 'zh' ? '智能 AI 对话助手，支持通义千问、豆包 2.0 Pro、豆包 2.0 Code 多模型' : 'Intelligent AI chat assistant with Qwen and Doubao models support'} />
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <meta name="theme-color" content="#ffffff" />
    <meta name="color-scheme" content="light dark" />
    
    <script is:inline>
      (function() {
        try {
          const theme = localStorage.getItem('theme') || 'light';
          document.documentElement.setAttribute('data-theme', theme);
        } catch (e) {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      })();
    </script>
  </head>
  <body>
    <Header />
    <div class="chat-app" data-lang={lang} role="application" aria-label={t('chatbot.title')}>

    <!-- Sidebar - Claude Style -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label={t('chatbot.chatHistory')}>
      <div class="sidebar-header">
        <span class="sidebar-title">{t('chatbot.chatHistory')}</span>
        <button class="close-sidebar" id="close-sidebar" type="button" aria-label={t('chatbot.closeSidebar')}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <button class="new-chat-btn" id="new-chat-btn" type="button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>{t('chatbot.newChat')}</span>
      </button>

      <div class="sidebar-search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="search" class="search-input" id="search-input" placeholder={t('chatbot.search')} aria-label={t('chatbot.searchHistory')} />
      </div>
      
      <div class="sidebar-content" id="sidebar-content" role="list">
        <div class="sidebar-section" data-section="today">
          <button class="section-header" data-toggle="today" aria-expanded="true" aria-controls="history-today" type="button">
            <svg class="section-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>{t('chatbot.today')}</span>
            <span class="section-count" id="count-today">0</span>
          </button>
          <div class="history-list" id="history-today" role="list"></div>
        </div>

        <div class="sidebar-section" data-section="week">
          <button class="section-header" data-toggle="week" aria-expanded="true" aria-controls="history-week" type="button">
            <svg class="section-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>{t('chatbot.last7Days')}</span>
            <span class="section-count" id="count-week">0</span>
          </button>
          <div class="history-list" id="history-week" role="list"></div>
        </div>

        <div class="sidebar-section" data-section="older">
          <button class="section-header" data-toggle="older" aria-expanded="true" aria-controls="history-older" type="button">
            <svg class="section-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>{t('chatbot.earlier')}</span>
            <span class="section-count" id="count-older">0</span>
          </button>
          <div class="history-list" id="history-older" role="list"></div>
        </div>
      </div>
      
      <div class="sidebar-footer">
        <button class="sidebar-action" id="settings-btn" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
          <span>{t('chatbot.settings')}</span>
        </button>
        <button class="sidebar-action danger" id="clear-all-btn" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          <span>{t('chatbot.clearChats')}</span>
        </button>
      </div>
    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" aria-hidden="true"></div>

    <!-- Main Content - Claude Style Layout -->
    <main class="main-content">
      <!-- Header -->
      <header class="chat-header">
        <button class="menu-toggle" id="menu-toggle" type="button" aria-label={t('aria.openMenu')} aria-expanded="false" aria-controls="sidebar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>

        <button class="header-action" id="export-btn" title={t('chatbot.exportChat')} type="button" aria-label={t('chatbot.exportChat')} style="margin-left: auto;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </button>
      </header>

      <!-- Chat Area -->
      <div class="chat-area" id="chat-area" role="log" aria-live="polite" aria-label={t('aria.chatArea')}>
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcome-screen">
          <div class="welcome-content">
            <div class="welcome-brand">
              <video class="welcome-logo" autoplay loop muted playsinline preload="auto" aria-hidden="true">
                <source src="/logo.mp4" type="video/mp4" />
              </video>
              <h1 class="welcome-title">{t('chatbot.welcomeTitle')}</h1>
              <p class="welcome-subtitle">{t('chatbot.welcomeSubtitle')}</p>
            </div>

            <div class="quick-actions">
              <div class="quick-actions-title">{t('chatbot.quickStart')}</div>
              <div class="quick-actions-grid">
                <button class="quick-action" data-prompt={t('chatbot.writeCodePrompt')} type="button">
                  <div class="quick-action-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="16 18 22 12 16 6"></polyline>
                      <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                  </div>
                  <span>{t('chatbot.writeCode')}</span>
                </button>
                <button class="quick-action" data-prompt={t('chatbot.answerQuestionPrompt')} type="button">
                  <div class="quick-action-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 16v-4"></path>
                      <path d="M12 8h.01"></path>
                    </svg>
                  </div>
                  <span>{t('chatbot.answerQuestion')}</span>
                </button>
                <button class="quick-action" data-prompt={t('chatbot.writeDocumentPrompt')} type="button">
                  <div class="quick-action-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                      <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                  </div>
                  <span>{t('chatbot.writeDocument')}</span>
                </button>
                <button class="quick-action" data-prompt={t('chatbot.brainstormPrompt')} type="button">
                  <div class="quick-action-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"></path>
                      <path d="M9 21h6"></path>
                    </svg>
                  </div>
                  <span>{t('chatbot.brainstorm')}</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messages-container" aria-label={t('aria.messagesList')}></div>
      </div>

      <!-- Input Area - Claude Style -->
      <div class="input-area" id="input-area">
        <div class="input-container">
          <!-- Model Selector - In Input Area -->
          <div class="model-selector-inline" id="model-selector">
            <button class="model-btn-inline" id="model-btn" type="button" aria-haspopup="listbox" aria-expanded="false" aria-label={t('aria.selectModel')}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
              </svg>
              <span class="model-name-inline" id="model-name">Doubao 2.0 Pro</span>
              <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="model-dropdown-inline" id="model-dropdown" role="listbox" aria-label={t('aria.modelList')}>
              <div class="model-group">
                <div class="model-group-label">Doubao</div>
                <button class="model-option active" data-model="doubao-2.0-pro" data-name="Doubao 2.0 Pro" role="option" aria-selected="true" type="button">
                  <span class="model-option-name">Doubao 2.0 Pro</span>
                  <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button class="model-option" data-model="doubao-2.0-code" data-name="Doubao 2.0 Code" role="option" aria-selected="false" type="button">
                  <span class="model-option-name">Doubao 2.0 Code</span>
                  <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
              </div>
              <div class="model-group">
                <div class="model-group-label">Qwen</div>
                <button class="model-option" data-model="qwen-turbo" data-name="Qwen Turbo" role="option" aria-selected="false" type="button">
                  <span class="model-option-name">Qwen Turbo</span>
                  <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button class="model-option" data-model="qwen-plus" data-name="Qwen Plus" role="option" aria-selected="false" type="button">
                  <span class="model-option-name">Qwen Plus</span>
                  <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <div class="input-wrapper">
            <textarea
              id="chat-input"
              class="chat-input"
              placeholder={t('chatbot.inputPlaceholder')}
              rows="1"
              aria-label={t('aria.chatInput')}
              aria-describedby="input-hint"
            ></textarea>
            <div class="input-actions">
              <button class="send-btn" id="send-btn" type="button" disabled aria-label={t('aria.sendMessage')}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <button class="stop-btn" id="stop-btn" type="button" style="display: none;" aria-label={t('aria.stopGeneration')}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div class="input-hint" id="input-hint">
          <span>{t('chatbot.inputHint')}</span>
        </div>
      </div>
    </main>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite"></div>
  </div>

  <style>
    /* ================================================================================
       Claude Design System - Strict Implementation
       Based on official Claude UI specifications
       ================================================================================ */
    
    /* ================================================================================
       CSS Reset - Minimal & Clean
       ================================================================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      font-feature-settings: 'kern' 1, 'liga' 1;
      -webkit-text-size-adjust: 100%;
    }
    
    body {
      font-family: var(--font-sans);
      font-weight: var(--font-regular);
      letter-spacing: var(--tracking-normal);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: var(--leading-normal);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* ================================================================================
       Design Tokens - Claude Strict Specification
       All values based on 4px grid system
       ================================================================================ */
    :root {
      /* Colors - Light Theme (Exact Claude values) */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F7;
      --bg-tertiary: #E8E8ED;
      --bg-elevated: #FFFFFF;
      --bg-overlay: rgba(0, 0, 0, 0.5);
      
      --text-primary: #1A1A1A;
      --text-secondary: #6B6B6B;
      --text-tertiary: #9A9A9A;
      --text-inverse: #FFFFFF;
      
      --border-color: #E5E5E5;
      --border-light: rgba(0, 0, 0, 0.06);
      --border-focus: #D45D00;
      
      /* Claude Brand Color - Orange */
      --accent-primary: #D45D00;
      --accent-hover: #E86A00;
      --accent-active: #C24E00;
      --accent-light: rgba(212, 93, 0, 0.08);
      --accent-lighter: rgba(212, 93, 0, 0.04);
      --accent-gradient: linear-gradient(135deg, #D45D00 0%, #FF8C47 100%);
      
      /* Semantic Colors */
      --success: #10B981;
      --success-light: rgba(16, 185, 129, 0.08);
      --error: #EF4444;
      --error-light: rgba(239, 68, 68, 0.08);
      --warning: #F59E0B;
      --warning-light: rgba(245, 158, 11, 0.08);
      --info: #3B82F6;
      --info-light: rgba(59, 130, 242, 0.08);
      
      /* Spacing - Strict 4px Grid System */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;
      --space-20: 80px;
      --space-24: 96px;
      
      /* Typography - Claude Style Font Stack */
      --font-sans: 'Söhne', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      --font-mono: 'Söhne Mono', 'SF Mono', 'Fira Code', 'Consolas', 'Liberation Mono', monospace;
      --font-display: 'Söhne Breit', -apple-system, BlinkMacSystemFont, sans-serif;
      
      /* Font Sizes - Precise Scale */
      --font-size-xs: 12px;
      --font-size-sm: 13px;
      --font-size-base: 15px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;
      --font-size-3xl: 32px;
      
      /* Font Weights */
      --font-regular: 400;
      --font-medium: 500;
      --font-semibold: 600;
      --font-bold: 700;
      
      /* Line Heights - Claude Style */
      --leading-none: 1;
      --leading-tight: 1.25;
      --leading-snug: 1.375;
      --leading-normal: 1.5;
      --leading-relaxed: 1.625;
      --leading-loose: 1.75;
      
      /* Letter Spacing - Claude Style */
      --tracking-tight: -0.025em;
      --tracking-normal: 0;
      --tracking-wide: 0.025em;
      --tracking-wider: 0.05em;
      
      /* Border Radius - Consistent Scale */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 20px;
      --radius-full: 9999px;
      
      /* Shadows - Subtle Depth */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.15);
      --shadow-2xl: 0 24px 64px rgba(0, 0, 0, 0.18);
      
      /* Transitions - Claude's Signature Smooth Feel */
      --duration-instant: 0ms;
      --duration-fast: 150ms;
      --duration-normal: 200ms;
      --duration-slow: 300ms;
      --duration-slower: 500ms;
      
      /* Easing - cubic-bezier for natural motion */
      --ease-default: cubic-bezier(0.4, 0, 0.2, 1);
      --ease-in: cubic-bezier(0.4, 0, 1, 1);
      --ease-out: cubic-bezier(0, 0, 0.2, 1);
      --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Z-index Scale */
      --z-base: 0;
      --z-dropdown: 10;
      --z-sticky: 20;
      --z-sidebar: 30;
      --z-modal-overlay: 40;
      --z-modal: 50;
      --z-popover: 60;
      --z-toast: 70;
      
      /* Layout Dimensions */
      --sidebar-width: 260px;
      --header-height: 64px;
      --input-max-width: 800px;
      --message-max-width: 70%;
    }
    
    /* Dark Theme - Exact Claude Dark Values */
    [data-theme="dark"] {
      --bg-primary: #1A1A1A;
      --bg-secondary: #0F0F0F;
      --bg-tertiary: #2A2A2A;
      --bg-elevated: #1C1C1E;
      --bg-overlay: rgba(0, 0, 0, 0.7);
      
      --text-primary: #F5F5F5;
      --text-secondary: #9A9A9A;
      --text-tertiary: #6B6B6B;
      
      --border-color: #3A3A3A;
      --border-light: rgba(255, 255, 255, 0.06);
      --border-focus: #FF8C47;
      
      --accent-primary: #FF8C47;
      --accent-hover: #FFA06A;
      --accent-active: #FF7830;
      --accent-light: rgba(255, 140, 71, 0.12);
      --accent-lighter: rgba(255, 140, 71, 0.06);
      
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
    }
    
    /* ================================================================================
       Global Focus Styles - Accessibility
       ================================================================================ */
    :focus-visible {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }
    
    button:focus-visible,
    a:focus-visible,
    input:focus-visible,
    textarea:focus-visible,
    [role="button"]:focus-visible {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }
    
    /* ================================================================================
       Layout Structure - Clean & Minimal
       ================================================================================ */
    .chat-app {
      display: flex;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      position: relative;
      padding-top: 80px;
    }
    
    /* ================================================================================
       Sidebar - Minimalist Claude Design
       Clean, focused, distraction-free
       ================================================================================ */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      z-index: var(--z-sidebar);
      transition: transform var(--duration-slow) var(--ease-default);
      will-change: transform;
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      padding: 0 var(--space-4);
      border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }
    
    .close-sidebar {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .close-sidebar:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .new-chat-btn {
      margin: var(--space-4);
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .new-chat-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-sm);
    }
    
    .new-chat-btn:active {
      transform: scale(0.98);
      box-shadow: none;
    }
    
    .sidebar-search {
      position: relative;
      margin: 0 var(--space-4) var(--space-4);
    }
    
    .sidebar-search svg {
      position: absolute;
      left: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
    }
    
    .search-input {
      width: 100%;
      height: 40px;
      padding: 0 var(--space-4) 0 var(--space-10);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 0 var(--space-4);
    }
    
    .sidebar-section {
      margin-bottom: var(--space-6);
    }
    
    .section-header {
      width: 100%;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) 0;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: var(--font-size-xs);
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: color var(--duration-fast) var(--ease-default);
    }
    
    .section-header:hover {
      color: var(--text-primary);
    }
    
    .section-chevron {
      transition: transform var(--duration-fast) var(--ease-default);
    }
    
    .section-header[aria-expanded="false"] .section-chevron {
      transform: rotate(-90deg);
    }
    
    .section-count {
      margin-left: auto;
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 11px;
    }
    
    .history-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      margin-top: var(--space-2);
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .history-list.collapsed {
      display: none;
    }
    
    .history-item {
      padding: var(--space-3);
      background: transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .history-item:hover {
      background: var(--bg-tertiary);
    }
    
    .history-item.active {
      background: var(--accent-light);
    }
    
    .history-item-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .history-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .history-date {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }
    
    .sidebar-footer {
      padding: var(--space-4);
      border-top: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .sidebar-action {
      width: 100%;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .sidebar-action:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    .sidebar-action.danger:hover {
      background: var(--error-light);
      color: var(--error);
      border-color: var(--error);
    }
    
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      opacity: 0;
      visibility: hidden;
      transition: all var(--duration-slow) var(--ease-default);
      z-index: calc(var(--z-sidebar) - 1);
    }
    
    .sidebar-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    
    /* ================================================================================
       Main Content Area
       ================================================================================ */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: margin-left var(--duration-slow) var(--ease-default);
    }
    
    /* Header */
    .chat-header {
      position: sticky;
      top: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-6);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      z-index: var(--z-dropdown);
    }
    
    .menu-toggle {
      display: none;
      width: 40px;
      height: 40px;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .menu-toggle:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .header-action {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .header-action:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    /* Model Selector */
    .model-selector {
      position: relative;
    }
    
    .model-btn {
      height: 40px;
      padding: 0 var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .model-btn:hover {
      background: var(--bg-tertiary);
    }
    
    .model-btn[aria-expanded="true"] {
      background: var(--bg-tertiary);
    }
    
    .model-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-light);
      border-radius: var(--radius-sm);
      color: var(--accent-primary);
    }
    
    .model-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }
    
    .chevron {
      color: var(--text-tertiary);
      transition: transform var(--duration-fast) var(--ease-default);
    }
    
    .model-btn[aria-expanded="true"] .chevron {
      transform: rotate(180deg);
    }
    
    .model-dropdown {
      position: absolute;
      top: calc(100% + var(--space-2));
      left: 0;
      width: 320px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-2);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all var(--duration-fast) var(--ease-default);
      z-index: var(--z-modal);
    }
    
    .model-dropdown.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .model-group {
      margin-bottom: var(--space-2);
    }
    
    .model-group:last-child {
      margin-bottom: 0;
    }
    
    .model-group-label {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
      font-weight: var(--font-semibold);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    
    .model-option {
      width: 100%;
      padding: var(--space-3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
      text-align: left;
    }
    
    .model-option:hover {
      background: var(--bg-tertiary);
    }
    
    .model-option.active {
      background: var(--accent-light);
    }
    
    .model-option-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .model-option-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }
    
    .model-option-desc {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }
    
    .check-icon {
      color: var(--accent-primary);
      opacity: 0;
      transition: opacity var(--duration-fast) var(--ease-default);
    }
    
    .model-option.active .check-icon {
      opacity: 1;
    }
    
    /* ================================================================================
       Chat Area
       ================================================================================ */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
      position: relative;
    }
    
    .welcome-screen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-10);
    }
    
    .welcome-screen.hidden {
      display: none;
    }
    
    .welcome-content {
      max-width: 800px;
      text-align: center;
    }
    
    .welcome-brand {
      margin-bottom: var(--space-10);
    }
    
    .welcome-logo {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
    }
    
    .welcome-title {
      font-family: var(--font-display);
      font-size: var(--font-size-3xl);
      font-weight: var(--font-semibold);
      letter-spacing: var(--tracking-tight);
      line-height: var(--leading-tight);
      color: var(--text-primary);
      margin-bottom: var(--space-3);
    }
    
    .welcome-subtitle {
      font-size: var(--font-size-lg);
      font-weight: var(--font-regular);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--tracking-normal);
      color: var(--text-secondary);
      max-width: 500px;
    }
    
    .quick-actions {
      margin-top: var(--space-8);
    }
    
    .quick-actions-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-semibold);
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
    }
    
    .quick-action {
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .quick-action:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .quick-action-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-light);
      border-radius: var(--radius-md);
      color: var(--accent-primary);
    }
    
    .quick-action span {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }
    
    .messages-container {
      flex: 1;
      padding: var(--space-6);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .message {
      display: flex;
      gap: var(--space-4);
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      animation: messageEnter var(--duration-slow) var(--ease-out);
    }
    
    @keyframes messageEnter {
      from {
        opacity: 0;
        transform: translateY(var(--space-4));
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .user-message {
      justify-content: flex-end;
    }
    
    /* User Message Bubble */
    .user-message .message-bubble {
      max-width: 70%;
      padding: var(--space-4) var(--space-5);
      background: var(--accent-primary);
      color: white;
      border-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
      position: relative;
    }
    
    .user-message .message-bubble p {
      font-size: var(--font-size-base);
      font-weight: var(--font-regular);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--tracking-normal);
      color: white;
      margin: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .user-message .message-time {
      display: block;
      font-size: var(--font-size-xs);
      color: rgba(255, 255, 255, 0.7);
      margin-top: var(--space-2);
    }
    
    /* Assistant Message Content */
    .assistant-message .message-content {
      max-width: 70%;
      padding: var(--space-4) var(--space-5);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-bottom-left-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
    }
    
    .assistant-message .message-content p {
      font-size: var(--font-size-base);
      font-weight: var(--font-regular);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--tracking-normal);
      color: var(--text-primary);
      margin: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .assistant-message .message-time {
      display: block;
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-top: var(--space-2);
    }
    
    .message-time {
      display: block;
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-top: var(--space-2);
    }
    
    .message-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: var(--space-2);
      gap: var(--space-2);
    }
    
    .copy-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-tertiary);
      cursor: pointer;
      opacity: 0;
      transition: all var(--duration-fast) var(--ease-default);
      flex-shrink: 0;
    }
    
    .message-content:hover .copy-btn,
    .message-content:focus-within .copy-btn {
      opacity: 1;
    }
    
    .copy-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .copy-btn:focus-visible {
      opacity: 1;
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }
    
    /* Mobile: always show copy button */
    @media (max-width: 768px) {
      .copy-btn {
        opacity: 1;
        width: 32px;
        height: 32px;
      }
    }
    
    .assistant-message {
      justify-content: flex-start;
      align-items: flex-start;
    }
    
    .assistant-avatar {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-gradient);
      border-radius: var(--radius-full);
      color: white;
      margin-top: var(--space-1);
    }
    
    /* Empty message placeholder */
    .message-bubble:empty::before,
    .message-content p:empty::before {
      content: attr(data-placeholder);
      color: var(--text-tertiary);
      font-style: italic;
    }
    
    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      gap: var(--space-1);
      padding: var(--space-3) var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-bottom-left-radius: var(--radius-sm);
      width: fit-content;
      margin-left: calc(var(--space-4) + 32px + var(--space-4));
      box-shadow: var(--shadow-sm);
      animation: messageEnter var(--duration-slow) var(--ease-out);
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-tertiary);
      border-radius: var(--radius-full);
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }
    
    /* ================================================================================
       Input Area - Claude Style
       ================================================================================ */
    .input-area {
      padding: var(--space-4) var(--space-6);
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
    }
    
    .input-hint {
      text-align: center;
      padding: var(--space-2) var(--space-4);
      margin-top: var(--space-2);
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }
    
    .input-container {
      max-width: var(--input-max-width);
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    /* Model Selector Inline - In Input Area */
    .model-selector-inline {
      position: relative;
      flex-shrink: 0;
    }
    
    .model-btn-inline {
      height: 56px;
      padding: 0 var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
      color: var(--text-primary);
      flex-shrink: 0;
    }
    
    .model-btn-inline:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
    }
    
    .model-btn-inline[aria-expanded="true"] {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
    }
    
    .model-name-inline {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .model-dropdown-inline {
      position: absolute;
      bottom: calc(100% + var(--space-2));
      left: 0;
      width: 220px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-2);
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all var(--duration-fast) var(--ease-default);
      z-index: var(--z-modal);
    }
    
    .model-dropdown-inline.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .model-dropdown-inline .model-group {
      margin-bottom: var(--space-2);
    }
    
    .model-dropdown-inline .model-group:last-child {
      margin-bottom: 0;
    }
    
    .model-dropdown-inline .model-group-label {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
      font-weight: var(--font-semibold);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    
    .model-dropdown-inline .model-option {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
      text-align: left;
    }
    
    .model-dropdown-inline .model-option:hover {
      background: var(--bg-tertiary);
    }
    
    .model-dropdown-inline .model-option.active {
      background: var(--accent-light);
    }
    
    .model-dropdown-inline .model-option-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }
    
    .model-dropdown-inline .check-icon {
      color: var(--accent-primary);
      opacity: 0;
      transition: opacity var(--duration-fast) var(--ease-default);
    }
    
    .model-dropdown-inline .model-option.active .check-icon {
      opacity: 1;
    }
    
    .input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: var(--space-3) var(--space-4);
      min-height: 56px;
      max-height: 200px;
      transition: all var(--duration-fast) var(--ease-default);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }
    
    .input-wrapper:focus-within {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px var(--accent-light), var(--shadow-md);
    }
    
    .input-wrapper.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .input-wrapper.loading::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-xl);
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .chat-input {
      flex: 1;
      min-height: 24px;
      max-height: 160px;
      padding: 0;
      background: transparent;
      border: none;
      resize: none;
      font-family: var(--font-sans);
      font-size: var(--font-size-base);
      font-weight: var(--font-regular);
      line-height: var(--leading-relaxed);
      letter-spacing: var(--tracking-normal);
      color: var(--text-primary);
      align-self: center;
    }
    
    .chat-input:focus {
      outline: none;
    }
    
    .chat-input::placeholder {
      color: var(--text-tertiary);
    }
    
    .input-actions {
      display: flex;
      gap: var(--space-2);
      align-items: center;
      flex-shrink: 0;
      align-self: center;
    }

    .send-btn,
    .stop-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-primary);
      border: none;
      border-radius: var(--radius-md);
      color: white;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .send-btn::after,
    .stop-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.2);
      opacity: 0;
      transition: opacity var(--duration-fast) var(--ease-default);
    }
    
    .send-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }
    
    .send-btn:active {
      transform: scale(0.95);
    }
    
    .send-btn:active::after {
      opacity: 1;
    }
    
    .send-btn:disabled {
      background: var(--bg-tertiary);
      cursor: not-allowed;
      transform: none;
    }
    
    .send-btn:disabled::after {
      display: none;
    }
    
    .stop-btn {
      background: var(--error);
    }
    
    .stop-btn:hover {
      background: #DC2626;
    }
    
    .stop-btn:active {
      transform: scale(0.95);
    }
    
    .stop-btn:active::after {
      opacity: 1;
    }
    
    /* ================================================================================
       Toast Notifications
       ================================================================================ */
    .toast-container {
      position: fixed;
      top: var(--space-6);
      right: var(--space-6);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      z-index: var(--z-toast);
    }
    
    .toast {
      min-width: 320px;
      max-width: 480px;
      padding: var(--space-4) var(--space-5);
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      animation: slideIn 0.3s ease;
      border-left: 4px solid;
    }
    
    .toast-success {
      border-left-color: var(--success);
    }
    
    .toast-error {
      border-left-color: var(--error);
    }
    
    .toast-info {
      border-left-color: var(--info);
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(calc(100% + var(--space-6)));
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* ================================================================================
       Responsive Design
       ================================================================================ */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .menu-toggle {
        display: flex;
      }
      
      .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .user-message .message-bubble,
      .assistant-message .message-content {
        max-width: 85%;
        padding: var(--space-3) var(--space-4);
      }

      .messages-container {
        padding: var(--space-4);
        gap: var(--space-3);
      }

      .message {
        gap: var(--space-2);
      }

      /* Mobile input area alignment */
      .input-container {
        flex-wrap: nowrap;
        gap: var(--space-2);
      }

      .model-selector-inline {
        width: auto;
        order: 0;
        flex-shrink: 0;
      }

      .model-btn-inline {
        width: auto;
        height: 48px;
        padding: 0 var(--space-3);
      }

      .model-name-inline {
        max-width: 80px;
      }

      .input-wrapper {
        min-height: 48px;
        padding: var(--space-2) var(--space-3);
      }

      .chat-input {
        max-height: 120px;
      }

      .send-btn,
      .stop-btn {
        width: 36px;
        height: 36px;
      }
      
      /* Input Area Mobile */
        .input-area {
          padding: var(--space-3) var(--space-4);
        }

        .model-dropdown-inline {
          width: 100%;
          bottom: calc(100% + var(--space-2));
        }

        .chat-input {
          font-size: 16px;
        }
    }
  </style>

  <script>
    // ================================================================================
    // TypeScript Interfaces
    // ================================================================================
    interface Message {
      role: 'user' | 'assistant';
      content: string;
      timestamp?: string;
    }
    
    interface Conversation {
      id: string;
      title: string;
      messages: Message[];
      model: string;
      createdAt: string;
      updatedAt: string;
    }
    
    // ================================================================================
    // State Management
    // ================================================================================
    let currentModel = 'doubao-2.0-pro';
    let currentModelName = 'Doubao 2.0 Pro';
    let chatHistory: Message[] = [];
    let conversations: Conversation[] = [];
    let currentConversationId: string | null = null;
    let isStreaming = false;
    let abortController: AbortController | null = null;
    let searchDebounceTimer: number | null = null;
    
    // Language detection
    const lang = document.documentElement.lang || 'en';
    
    // API Base
    const API_BASE = 'https://api.agiera.net';
    
    // ================================================================================
    // Safe Storage Helpers
    // ================================================================================
    function safeGetItem(key: string): string | null {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        console.warn(`[Chatbot] Failed to get ${key} from localStorage:`, e);
        return null;
      }
    }
    
    function safeSetItem(key: string, value: string): boolean {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        console.warn(`[Chatbot] Failed to set ${key} in localStorage:`, e);
        return false;
      }
    }
    
    function safeRemoveItem(key: string): boolean {
      try {
        localStorage.removeItem(key);
        return true;
      } catch (e) {
        console.warn(`[Chatbot] Failed to remove ${key} from localStorage:`, e);
        return false;
      }
    }
    
    function safeGetSessionItem(key: string): string | null {
      try {
        return sessionStorage.getItem(key);
      } catch (e) {
        console.warn(`[Chatbot] Failed to get ${key} from sessionStorage:`, e);
        return null;
      }
    }
    
    function safeSetSessionItem(key: string, value: string): boolean {
      try {
        sessionStorage.setItem(key, value);
        return true;
      } catch (e) {
        console.warn(`[Chatbot] Failed to set ${key} in sessionStorage:`, e);
        return false;
      }
    }
    
    function safeRemoveSessionItem(key: string): boolean {
      try {
        sessionStorage.removeItem(key);
        return true;
      } catch (e) {
        console.warn(`[Chatbot] Failed to remove ${key} from sessionStorage:`, e);
        return false;
      }
    }
    
    // ================================================================================
    // Initialization
    // ================================================================================
    function init() {
      console.log('[Chatbot] Initializing...');
      console.log('[Chatbot] Language:', lang);
      
      // Ensure DOM is ready
      if (!document.getElementById('chat-input')) {
        console.error('[Chatbot] Chat input element not found!');
        return;
      }
      
      loadConversations();
      setupEventListeners();
      renderHistory();
      setupQuickActions();
      setupSidebarToggle();
      setupSearch();
      setupSectionToggle();
      setupSettings();
      setupClearAll();
      setupExport();
      
      console.log('[Chatbot] Initialization complete');
    }
    
    // ================================================================================
    // Event Listeners Setup
    // ================================================================================
    function setupEventListeners() {
      console.log('[Chatbot] Setting up event listeners...');
      
      // Model selection
      const modelBtn = document.getElementById('model-btn');
      const modelDropdown = document.getElementById('model-dropdown');
      
      console.log('[Chatbot] Model button:', modelBtn ? 'found' : 'NOT FOUND');
      console.log('[Chatbot] Model dropdown:', modelDropdown ? 'found' : 'NOT FOUND');
      
      if (modelBtn && modelDropdown) {
        modelBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = modelDropdown.classList.contains('visible');
          console.log('[Chatbot] Model dropdown visible:', isVisible, '-> toggling to:', !isVisible);
          modelDropdown.classList.toggle('visible', !isVisible);
          modelBtn.setAttribute('aria-expanded', isVisible ? 'false' : 'true');
        });
        
        // Model options
        modelDropdown.querySelectorAll('.model-option').forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const model = option.getAttribute('data-model');
            const name = option.getAttribute('data-name');
            console.log('[Chatbot] Model option clicked:', model, name);
            if (model && name) {
              selectModel(model, name);
              modelDropdown.classList.remove('visible');
              modelBtn.setAttribute('aria-expanded', 'false');
            }
          });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!modelDropdown.contains(e.target as Node) && !modelBtn.contains(e.target as Node)) {
            modelDropdown.classList.remove('visible');
            modelBtn.setAttribute('aria-expanded', 'false');
          }
        });
        
        // Keyboard navigation for model dropdown
        modelBtn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            modelBtn.click();
          } else if (e.key === 'Escape') {
            modelDropdown.classList.remove('visible');
            modelBtn.setAttribute('aria-expanded', 'false');
          }
        });
        
        // Arrow key navigation in dropdown
        const modelOptions = modelDropdown.querySelectorAll('.model-option');
        modelOptions.forEach((option, index) => {
          option.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              const next = modelOptions[index + 1] || modelOptions[0];
              (next as HTMLElement).focus();
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              const prev = modelOptions[index - 1] || modelOptions[modelOptions.length - 1];
              (prev as HTMLElement).focus();
            } else if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              (option as HTMLElement).click();
            } else if (e.key === 'Escape') {
              modelDropdown.classList.remove('visible');
              modelBtn.setAttribute('aria-expanded', 'false');
              modelBtn.focus();
            }
          });
        });
      }
      
      // New chat
      const newChatBtn = document.getElementById('new-chat-btn');
      if (newChatBtn) {
        newChatBtn.addEventListener('click', startNewChat);
      }
      
      // Send message
      const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
      const sendBtn = document.getElementById('send-btn');
      const stopBtn = document.getElementById('stop-btn');
      
      console.log('[Chatbot] Chat input:', chatInput ? 'found' : 'NOT FOUND');
      console.log('[Chatbot] Send button:', sendBtn ? 'found' : 'NOT FOUND');
      
      if (chatInput && sendBtn) {
        chatInput.addEventListener('input', () => {
          console.log('[Chatbot] Input event triggered, value:', chatInput.value);
          sendBtn.disabled = chatInput.value.trim() === '';
          
          // Auto-resize textarea
          chatInput.style.height = 'auto';
          chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
        });
        
        // Mobile keyboard handling
        chatInput.addEventListener('focus', () => {
          if (window.innerWidth <= 768) {
            setTimeout(() => {
              const inputArea = document.getElementById('input-area');
              if (inputArea) {
                inputArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
              }
            }, 300);
          }
        });
        
        sendBtn.addEventListener('click', sendMessage);
        
        // Stop button
        if (stopBtn) {
          stopBtn.addEventListener('click', stopGeneration);
        }
        
        chatInput.addEventListener('keydown', (e) => {
          // Only send on Enter if not in a composition session (IME)
          if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
            e.preventDefault();
            if (!sendBtn.disabled && !isStreaming) {
              sendMessage();
            }
          }
        });
      } else {
        console.error('[Chatbot] Critical: chat input or send button not found!');
      }
    }
    
    // ================================================================================
    // Quick Actions Setup
    // ================================================================================
    function setupQuickActions() {
      const quickActions = document.querySelectorAll('.quick-action');
      const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
      const sendBtn = document.getElementById('send-btn') as HTMLButtonElement;
      
      quickActions.forEach(action => {
        action.addEventListener('click', () => {
          const prompt = action.getAttribute('data-prompt');
          if (prompt && chatInput) {
            chatInput.value = prompt;
            chatInput.focus();
            if (sendBtn) {
              sendBtn.disabled = false;
            }
            // Trigger input event for auto-resize
            chatInput.dispatchEvent(new Event('input'));
          }
        });
      });
    }
    
    // ================================================================================
    // Sidebar Toggle Setup
    // ================================================================================
    function setupSidebarToggle() {
      const menuToggle = document.getElementById('menu-toggle');
      const closeSidebar = document.getElementById('close-sidebar');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      
      function openSidebar() {
        sidebar?.classList.add('open');
        overlay?.classList.add('visible');
        menuToggle?.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }
      
      function closeSidebarFn() {
        sidebar?.classList.remove('open');
        overlay?.classList.remove('visible');
        menuToggle?.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }
      
      menuToggle?.addEventListener('click', openSidebar);
      closeSidebar?.addEventListener('click', closeSidebarFn);
      overlay?.addEventListener('click', closeSidebarFn);
      
      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && sidebar?.classList.contains('open')) {
          closeSidebarFn();
        }
      });
    }
    
    // ================================================================================
    // Search Setup
    // ================================================================================
    function setupSearch() {
      const searchInput = document.getElementById('search-input') as HTMLInputElement;
      
      if (!searchInput) return;
      
      searchInput.addEventListener('input', () => {
        if (searchDebounceTimer) {
          clearTimeout(searchDebounceTimer);
        }
        
        searchDebounceTimer = window.setTimeout(() => {
          const query = searchInput.value.toLowerCase().trim();
          filterConversations(query);
        }, 300);
      });
    }
    
    function filterConversations(query: string) {
      const historyItems = document.querySelectorAll('.history-item');
      
      historyItems.forEach(item => {
        const title = item.querySelector('.history-title')?.textContent?.toLowerCase() || '';
        if (query === '' || title.includes(query)) {
          (item as HTMLElement).style.display = '';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
    }
    
    // ================================================================================
    // Section Toggle Setup
    // ================================================================================
    function setupSectionToggle() {
      const sectionHeaders = document.querySelectorAll('.section-header');
      
      sectionHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const section = header.getAttribute('data-toggle');
          const list = document.getElementById(`history-${section}`);
          const isExpanded = header.getAttribute('aria-expanded') === 'true';
          
          header.setAttribute('aria-expanded', (!isExpanded).toString());
          list?.classList.toggle('collapsed', isExpanded);
        });
      });
    }
    
    // ================================================================================
    // Settings Setup
    // ================================================================================
    function setupSettings() {
      const settingsBtn = document.getElementById('settings-btn');
      
      settingsBtn?.addEventListener('click', () => {
        showToast(lang === 'zh' ? '设置功能即将推出' : 'Settings coming soon', 'info');
      });
    }
    
    // ================================================================================
    // Clear All Setup
    // ================================================================================
    function setupClearAll() {
      const clearAllBtn = document.getElementById('clear-all-btn');
      
      clearAllBtn?.addEventListener('click', () => {
        const confirmMessage = lang === 'zh' 
          ? '确定要清除所有对话历史吗？此操作无法撤销。' 
          : 'Are you sure you want to clear all conversation history? This cannot be undone.';
        
        if (confirm(confirmMessage)) {
          conversations = [];
          safeRemoveItem('chatbot_conversations');
          safeRemoveSessionItem('chatbot_session_id');
          startNewChat();
          showToast(lang === 'zh' ? '所有对话已清除' : 'All conversations cleared', 'success');
        }
      });
    }
    
    // ================================================================================
    // Export Setup
    // ================================================================================
    function setupExport() {
      const exportBtn = document.getElementById('export-btn');
      
      exportBtn?.addEventListener('click', () => {
        if (chatHistory.length === 0) {
          showToast(lang === 'zh' ? '没有可导出的对话' : 'No conversation to export', 'error');
          return;
        }
        
        const exportData = {
          title: conversations.find(c => c.id === currentConversationId)?.title || 'Chat Export',
          model: currentModel,
          messages: chatHistory,
          exportedAt: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(lang === 'zh' ? '对话已导出' : 'Conversation exported', 'success');
      });
    }
    
    // ================================================================================
    // Model Selection
    // ================================================================================
    function selectModel(model: string, name: string) {
      currentModel = model;
      currentModelName = name;
      
      const modelName = document.getElementById('model-name');
      if (modelName) {
        modelName.textContent = name;
      }
      
      // Update dropdown
      document.querySelectorAll('.model-option').forEach(opt => {
        const isActive = opt.getAttribute('data-model') === model;
        opt.classList.toggle('active', isActive);
        opt.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      
      showToast(`${lang === 'zh' ? '已切换到' : 'Switched to'} ${name}`, 'success');
    }
    
    // ================================================================================
    // Send Message
    // ================================================================================
    async function sendMessage() {
      const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
      const content = chatInput?.value.trim();
      
      console.log('[Chatbot] Sending message:', content);
      console.log('[Chatbot] Current model:', currentModel);
      console.log('[Chatbot] API Base:', API_BASE);
      
      if (!content || isStreaming) {
        console.error('[Chatbot] Aborted: content=', content, 'isStreaming=', isStreaming);
        return;
      }
      
      // Hide welcome screen when sending first message
      const welcomeScreen = document.getElementById('welcome-screen');
      if (welcomeScreen) {
        welcomeScreen.classList.add('hidden');
      }
      
      // Add user message
      addMessage('user', content);
      chatInput.value = '';
      chatInput.style.height = 'auto';
      
      // Set streaming state
      isStreaming = true;
      
      // Disable input and show loading state
      const sendBtn = document.getElementById('send-btn') as HTMLButtonElement;
      const stopBtn = document.getElementById('stop-btn') as HTMLButtonElement;
      const inputWrapper = document.querySelector('.input-wrapper');
      
      if (sendBtn) {
        sendBtn.style.display = 'none';
      }
      if (stopBtn) {
        stopBtn.style.display = 'flex';
      }
      if (inputWrapper) {
        inputWrapper.classList.add('loading');
      }
      if (chatInput) {
        chatInput.disabled = true;
      }
      
      // Show typing indicator
      showTypingIndicator();
      
      // Create abort controller for cancellation
      abortController = new AbortController();
      
      try {
        console.log('[Chatbot] Fetching from API:', `${API_BASE}/api/chat`);
        
        const requestBody = {
          message: content,
          model: currentModel,
          history: chatHistory.slice(-10)
        };
        
        console.log('[Chatbot] Request body:', JSON.stringify(requestBody, null, 2));
        
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody),
          signal: abortController.signal
        });
        
        console.log('[Chatbot] Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          console.error('[Chatbot] HTTP error:', response.status, response.statusText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('[Chatbot] Response data:', data);
        
        // Remove typing indicator
        removeTypingIndicator();
        
        if (data.success && data.reply) {
          console.log('[Chatbot] Adding AI response:', data.reply);
          addMessage('assistant', data.reply);
        } else {
          console.error('[Chatbot] API returned error:', data);
          showToast(data.message || 'Failed to get response', 'error');
        }
      } catch (error) {
        // Check if it's an abort error
        if (error instanceof Error && error.name === 'AbortError') {
          console.log('[Chatbot] Request was aborted');
          removeTypingIndicator();
          addMessage('assistant', lang === 'zh' ? '生成已停止。' : 'Generation stopped.');
        } else {
          console.error('[Chatbot] Fetch error:', error);
          removeTypingIndicator();
          
          // Show error with retry option
          const errorMessage = error instanceof Error ? error.message : 'Unknown error';
          showToast(`${lang === 'zh' ? '网络错误' : 'Network error'}: ${errorMessage}`, 'error');
          
          // Add error message to chat
          addMessage('assistant', lang === 'zh' 
            ? `抱歉，发生了错误：${errorMessage}。请稍后重试。`
            : `Sorry, an error occurred: ${errorMessage}. Please try again later.`
          );
        }
      } finally {
        // Reset streaming state
        isStreaming = false;
        abortController = null;
        
        const sendBtn = document.getElementById('send-btn') as HTMLButtonElement;
        const stopBtn = document.getElementById('stop-btn') as HTMLButtonElement;
        const inputWrapper = document.querySelector('.input-wrapper');
        
        if (sendBtn) {
          sendBtn.style.display = 'flex';
          sendBtn.disabled = true;
        }
        if (stopBtn) {
          stopBtn.style.display = 'none';
        }
        if (inputWrapper) {
          inputWrapper.classList.remove('loading');
        }
        if (chatInput) {
          chatInput.disabled = false;
          chatInput.focus();
        }
      }
    }
    
    // ================================================================================
    // Stop Generation
    // ================================================================================
    function stopGeneration() {
      if (abortController) {
        abortController.abort();
      }
    }
    
    // ================================================================================
    // Add Message
    // ================================================================================
    function addMessage(role: 'user' | 'assistant', content: string, shouldSave: boolean = true) {
      const messagesContainer = document.getElementById('messages-container');
      const chatArea = document.getElementById('chat-area');
      if (!messagesContainer) return;
      
      const now = new Date();
      const timeStr = now.toLocaleTimeString(lang === 'zh' ? 'zh-CN' : 'en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}-message`;
      
      if (role === 'user') {
        messageDiv.innerHTML = `
          <div class="message-bubble">
            <p>${escapeHtml(content)}</p>
            <span class="message-time">${timeStr}</span>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="assistant-avatar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 16v-4"></path>
              <path d="M12 8h.01"></path>
            </svg>
          </div>
          <div class="message-content">
            <p>${escapeHtml(content)}</p>
            <div class="message-footer">
              <span class="message-time">${timeStr}</span>
              <button class="copy-btn" aria-label="${lang === 'zh' ? '复制消息' : 'Copy message'}" type="button">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
      }
      
      messagesContainer.appendChild(messageDiv);
      
      // Add copy button event listener
      const copyBtn = messageDiv.querySelector('.copy-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(content).then(() => {
            showToast(lang === 'zh' ? '已复制到剪贴板' : 'Copied to clipboard', 'success');
          }).catch(() => {
            showToast(lang === 'zh' ? '复制失败' : 'Copy failed', 'error');
          });
        });
      }
      
      // Scroll to bottom - use chat-area as the scroll container
      if (chatArea) {
        requestAnimationFrame(() => {
          chatArea.scrollTo({
            top: chatArea.scrollHeight,
            behavior: 'smooth'
          });
        });
      }
      
      // Add to history
      if (shouldSave) {
        chatHistory.push({ 
          role, 
          content, 
          timestamp: now.toISOString() 
        });
        
        // Save conversation
        saveConversation();
      }
    }
    
    // ================================================================================
    // Typing Indicator
    // ================================================================================
    function showTypingIndicator() {
      const messagesContainer = document.getElementById('messages-container');
      const chatArea = document.getElementById('chat-area');
      if (!messagesContainer) return;
      
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      `;
      
      messagesContainer.appendChild(typingDiv);
      
      // Scroll to bottom
      if (chatArea) {
        requestAnimationFrame(() => {
          chatArea.scrollTo({
            top: chatArea.scrollHeight,
            behavior: 'smooth'
          });
        });
      }
    }

    function removeTypingIndicator() {
      const typingIndicator = document.getElementById('typing-indicator');
      typingIndicator?.remove();
    }
    
    // ================================================================================
    // New Chat
    // ================================================================================
    function startNewChat() {
      // Clear session to start a new conversation
      safeRemoveSessionItem('chatbot_session_id');
      currentConversationId = null;
      chatHistory = [];
      
      const messagesContainer = document.getElementById('messages-container');
      const welcomeScreen = document.getElementById('welcome-screen');
      
      if (messagesContainer) {
        messagesContainer.innerHTML = '';
      }
      
      if (welcomeScreen) {
        welcomeScreen.classList.remove('hidden');
      }
      
      // Reset input
      const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
      const sendBtn = document.getElementById('send-btn') as HTMLButtonElement;
      if (chatInput) {
        chatInput.value = '';
        chatInput.style.height = 'auto';
      }
      if (sendBtn) {
        sendBtn.disabled = true;
      }
      
      renderHistory();
      
      // Close mobile sidebar if open
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const menuToggle = document.getElementById('menu-toggle');
      if (sidebar?.classList.contains('open')) {
        sidebar.classList.remove('open');
        overlay?.classList.remove('visible');
        menuToggle?.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }
    }
    
    // ================================================================================
    // Load Conversations
    // ================================================================================
    function loadConversations() {
      const stored = safeGetItem('chatbot_conversations');
      if (stored) {
        try {
          conversations = JSON.parse(stored);
        } catch (e) {
          console.error('[Chatbot] Failed to parse conversations:', e);
          conversations = [];
        }
      }
      
      // Check if there's a session conversation ID stored
      const sessionId = safeGetSessionItem('chatbot_session_id');
      if (sessionId) {
        currentConversationId = sessionId;
        // Load the conversation if it exists
        const conv = conversations.find(c => c.id === sessionId);
        if (conv) {
          chatHistory = [...conv.messages];
          
          // Render messages to the UI
          const messagesContainer = document.getElementById('messages-container');
          const welcomeScreen = document.getElementById('welcome-screen');
          
          if (messagesContainer && chatHistory.length > 0) {
            // Hide welcome screen
            if (welcomeScreen) {
              welcomeScreen.classList.add('hidden');
            }
            
            // Render all messages
            chatHistory.forEach(msg => {
              addMessage(msg.role, msg.content, false);
            });
          }
        }
      }
    }
    
    // ================================================================================
    // Save Conversation
    // ================================================================================
    function saveConversation() {
      // Use session storage to track the current session conversation
      let sessionId = safeGetSessionItem('chatbot_session_id');
      
      if (!sessionId) {
        // Create a new session conversation for this page visit
        sessionId = 'session_' + Date.now().toString();
        safeSetSessionItem('chatbot_session_id', sessionId);
        currentConversationId = sessionId;
        
        conversations.unshift({
          id: currentConversationId,
          title: chatHistory[0]?.content.slice(0, 50) || (lang === 'zh' ? '新对话' : 'New Chat'),
          messages: [...chatHistory],
          model: currentModel,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
      } else {
        // Update existing session conversation
        currentConversationId = sessionId;
        const conv = conversations.find(c => c.id === sessionId);
        if (conv) {
          conv.messages = [...chatHistory];
          conv.updatedAt = new Date().toISOString();
          // Update title if first message changed
          if (chatHistory.length > 0) {
            conv.title = chatHistory[0].content.slice(0, 50);
          }
        } else {
          // Conversation doesn't exist (was deleted), create new one
          conversations.unshift({
            id: sessionId,
            title: chatHistory[0]?.content.slice(0, 50) || (lang === 'zh' ? '新对话' : 'New Chat'),
            messages: [...chatHistory],
            model: currentModel,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
        }
      }
      
      safeSetItem('chatbot_conversations', JSON.stringify(conversations));
      renderHistory();
    }
    
    // ================================================================================
    // Render History
    // ================================================================================
    function renderHistory() {
      const todayList = document.getElementById('history-today');
      const weekList = document.getElementById('history-week');
      const olderList = document.getElementById('history-older');
      
      if (!todayList || !weekList || !olderList) return;
      
      todayList.innerHTML = '';
      weekList.innerHTML = '';
      olderList.innerHTML = '';
      
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      let todayCount = 0, weekCount = 0, olderCount = 0;
      
      conversations.forEach(conv => {
        const convDate = new Date(conv.createdAt);
        const item = document.createElement('div');
        item.className = 'history-item';
        if (conv.id === currentConversationId) item.classList.add('active');
        
        item.innerHTML = `
          <div class="history-item-content">
            <span class="history-title">${escapeHtml(conv.title)}</span>
            <span class="history-date">${formatDate(convDate)}</span>
          </div>
        `;
        
        item.addEventListener('click', () => loadConversation(conv.id));
        
        if (convDate >= today) {
          todayList.appendChild(item);
          todayCount++;
        } else if (convDate >= weekAgo) {
          weekList.appendChild(item);
          weekCount++;
        } else {
          olderList.appendChild(item);
          olderCount++;
        }
      });
      
      const countToday = document.getElementById('count-today');
      const countWeek = document.getElementById('count-week');
      const countOlder = document.getElementById('count-older');
      
      if (countToday) countToday.textContent = todayCount.toString();
      if (countWeek) countWeek.textContent = weekCount.toString();
      if (countOlder) countOlder.textContent = olderCount.toString();
    }
    
    // ================================================================================
    // Load Conversation
    // ================================================================================
    function loadConversation(id: string) {
      const conv = conversations.find(c => c.id === id);
      if (!conv) return;
      
      currentConversationId = id;
      chatHistory = [...conv.messages];
      
      const messagesContainer = document.getElementById('messages-container');
      const welcomeScreen = document.getElementById('welcome-screen');
      
      if (messagesContainer) {
        messagesContainer.innerHTML = '';
        chatHistory.forEach(msg => addMessage(msg.role, msg.content, false));
      }
      
      if (welcomeScreen) {
        welcomeScreen.classList.add('hidden');
      }
      
      // Update active state in sidebar
      renderHistory();
      
      // Close mobile sidebar
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const menuToggle = document.getElementById('menu-toggle');
      if (sidebar?.classList.contains('open')) {
        sidebar.classList.remove('open');
        overlay?.classList.remove('visible');
        menuToggle?.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }
    }
    
    // ================================================================================
    // Show Toast
    // ================================================================================
    function showToast(message: string, type: 'success' | 'error' | 'info') {
      const toastContainer = document.getElementById('toast-container');
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(calc(100% + var(--space-6)))';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // ================================================================================
    // Escape HTML
    // ================================================================================
    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ================================================================================
    // Format Date
    // ================================================================================
    function formatDate(date: Date): string {
      return date.toLocaleTimeString(lang === 'zh' ? 'zh-CN' : 'en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // ================================================================================
    // Global Error Handler
    // ================================================================================
    window.addEventListener('error', (e) => {
      console.error('[Chatbot] Global error:', e.error);
      showToast(lang === 'zh' ? '发生错误，请刷新页面重试' : 'An error occurred, please refresh the page', 'error');
    });
    
    window.addEventListener('unhandledrejection', (e) => {
      console.error('[Chatbot] Unhandled promise rejection:', e.reason);
      showToast(lang === 'zh' ? '发生错误，请刷新页面重试' : 'An error occurred, please refresh the page', 'error');
    });
    
    // ================================================================================
    // Initialize on load
    // ================================================================================
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>