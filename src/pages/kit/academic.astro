---
import Layout from '@layouts/Layout.astro';

const tools = [
  { id: 'doi', title: 'DOI 引用转换', desc: '转换为多种引用格式' },
  { id: 'bibtex', title: 'BibTeX', desc: '生成标准BibTeX格式' },
  { id: 'impact', title: '期刊查询', desc: '查询影响因子和分区' },
  { id: 'latex', title: 'LaTeX', desc: '数学公式编辑器' },
  { id: 'translate', title: '学术翻译', desc: '专业学术翻译' },
  { id: 'keywords', title: '关键词提取', desc: '自动提取关键词' }
];

const formats = ['APA', 'MLA', 'Chicago', 'IEEE', 'Vancouver', 'GB/T 7714', 'BibTeX'];
---

<Layout 
  title="学术工具 - USTC Dev"
  description="学术研究工具集"
>
  <section class="academic">
    <div class="container">
      <header class="header">
        <a href="/kit" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          <span>工具箱</span>
        </a>
        <h1 class="title">学术工具</h1>
        <p class="desc">为学术研究提供便捷工具</p>
      </header>
      
      <div class="tools-grid" id="tools-grid">
        {tools.map(tool => (
          <button class="tool-btn" data-tool={tool.id}>
            <span class="tool-title">{tool.title}</span>
            <span class="tool-desc">{tool.desc}</span>
          </button>
        ))}
      </div>
      
      <!-- DOI Tool -->
      <div class="panel" id="panel-doi">
        <div class="panel-header">
          <button class="back-btn" data-back>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h2 class="panel-title">DOI 引用转换</h2>
        </div>
        <div class="panel-body">
          <div class="field">
            <input type="text" id="doi-input" placeholder="10.1000/xyz123" />
          </div>
          <button class="btn" id="fetch-doi">获取引用</button>
          <div class="result hidden" id="doi-result">
            <div class="article-info" id="article-info"></div>
            <div class="format-tabs" id="format-tabs">
              {formats.map((f, i) => <button class:list={['tab', { active: i === 0 }]} data-format={f}>{f}</button>)}
            </div>
            <div class="output">
              <pre id="citation-output"></pre>
              <button class="copy-btn" id="copy-doi">复制</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- BibTeX Tool -->
      <div class="panel" id="panel-bibtex">
        <div class="panel-header">
          <button class="back-btn" data-back>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h2 class="panel-title">BibTeX 生成器</h2>
        </div>
        <div class="panel-body">
          <div class="fields">
            <select id="bibtex-type">
              <option value="article">期刊论文</option>
              <option value="book">书籍</option>
              <option value="inproceedings">会议论文</option>
            </select>
            <input type="text" id="bibtex-key" placeholder="引用键 (如: Author2024)" />
            <input type="text" id="bibtex-title" placeholder="标题" />
            <input type="text" id="bibtex-author" placeholder="作者 (逗号分隔)" />
            <input type="text" id="bibtex-journal" placeholder="期刊/出版社" />
            <div class="row">
              <input type="text" id="bibtex-year" placeholder="年份" />
              <input type="text" id="bibtex-volume" placeholder="卷" />
              <input type="text" id="bibtex-pages" placeholder="页码" />
            </div>
          </div>
          <button class="btn" id="gen-bibtex">生成</button>
          <div class="output hidden" id="bibtex-output">
            <pre id="bibtex-code"></pre>
            <button class="copy-btn" id="copy-bibtex">复制</button>
          </div>
        </div>
      </div>
      
      <!-- Impact Factor -->
      <div class="panel" id="panel-impact">
        <div class="panel-header">
          <button class="back-btn" data-back>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h2 class="panel-title">期刊查询</h2>
        </div>
        <div class="panel-body">
          <div class="field">
            <input type="text" id="journal-input" placeholder="期刊名称或ISSN" />
          </div>
          <button class="btn" id="search-journal">查询</button>
          <div class="result hidden" id="journal-result">
            <div class="metrics">
              <div class="metric"><span class="val" id="if-value">--</span><span class="lbl">IF</span></div>
              <div class="metric"><span class="val" id="jcr-value">--</span><span class="lbl">JCR</span></div>
              <div class="metric"><span class="val" id="cas-value">--</span><span class="lbl">CAS</span></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- LaTeX -->
      <div class="panel" id="panel-latex">
        <div class="panel-header">
          <button class="back-btn" data-back>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h2 class="panel-title">LaTeX 公式</h2>
        </div>
        <div class="panel-body">
          <div class="field">
            <textarea id="latex-input" rows="3" placeholder="\frac{a}{b}"></textarea>
          </div>
          <div class="symbols">
            <button data-sym="\frac{}{}">frac</button>
            <button data-sym="\sqrt{}">√</button>
            <button data-sym="^{}">xⁿ</button>
            <button data-sym="_{}">xₙ</button>
            <button data-sym="\sum">Σ</button>
            <button data-sym="\int">∫</button>
            <button data-sym="\alpha">α</button>
            <button data-sym="\beta">β</button>
            <button data-sym="\infty">∞</button>
          </div>
          <button class="btn" id="render-latex">渲染</button>
          <div class="preview" id="latex-preview"></div>
        </div>
      </div>
      
      <!-- Translate -->
      <div class="panel" id="panel-translate">
        <div class="panel-header">
          <button class="back-btn" data-back>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h2 class="panel-title">学术翻译</h2>
        </div>
        <div class="panel-body">
          <div class="translate-row">
            <select id="src-lang"><option value="en">English</option><option value="zh">中文</option></select>
            <button class="swap-btn" id="swap-lang">⇄</button>
            <select id="tgt-lang"><option value="zh">中文</option><option value="en">English</option></select>
          </div>
          <textarea id="src-text" rows="4" placeholder="输入文本"></textarea>
          <button class="btn" id="do-translate">翻译</button>
          <textarea id="tgt-text" rows="4" readonly placeholder="翻译结果"></textarea>
        </div>
      </div>
      
      <!-- Keywords -->
      <div class="panel" id="panel-keywords">
        <div class="panel-header">
          <button class="back-btn" data-back>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h2 class="panel-title">关键词提取</h2>
        </div>
        <div class="panel-body">
          <div class="field">
            <textarea id="kw-text" rows="6" placeholder="粘贴文本..."></textarea>
          </div>
          <div class="row">
            <select id="kw-count">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="15">15</option>
            </select>
          </div>
          <button class="btn" id="extract-kw">提取</button>
          <div class="tags hidden" id="kw-tags"></div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  .academic { min-height: 100vh; padding: calc(var(--header-total-height) + var(--space-4)) var(--space-4) var(--space-16); }
  .container { max-width: 640px; margin: 0 auto; }
  
  .header { margin-bottom: var(--space-8); }
  .back-link { display: inline-flex; align-items: center; gap: var(--space-1); color: var(--text-tertiary); font-size: var(--text-sm); margin-bottom: var(--space-4); }
  .back-link:hover { color: var(--text-secondary); }
  .title { font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary); margin-bottom: var(--space-1); }
  .desc { font-size: var(--text-sm); color: var(--text-secondary); }
  
  .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); }
  .tool-btn { display: flex; flex-direction: column; gap: 2px; padding: var(--space-4); background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-xl); text-align: left; transition: all var(--duration-fast) var(--ease-default); }
  .tool-btn:hover { background: var(--bg-tertiary); border-color: var(--border-hover); }
  .tool-title { font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--text-primary); }
  .tool-desc { font-size: var(--text-xs); color: var(--text-tertiary); }
  
  .panel { display: none; }
  .panel.active { display: block; }
  .panel-header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-6); }
  .back-btn { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: var(--bg-secondary); border-radius: var(--radius-lg); color: var(--text-tertiary); }
  .back-btn:hover { color: var(--text-primary); }
  .panel-title { font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary); }
  
  .panel-body { display: flex; flex-direction: column; gap: var(--space-3); }
  .field input, .field textarea, .fields input, .fields select, .fields textarea { width: 100%; padding: var(--space-3); background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); color: var(--text-primary); font-size: var(--text-sm); }
  .field input:focus, .field textarea:focus, .fields input:focus, .fields select:focus { outline: none; border-color: var(--color-accent-blue); }
  .fields { display: flex; flex-direction: column; gap: var(--space-2); }
  .row { display: flex; gap: var(--space-2); }
  .row > * { flex: 1; }
  
  .btn { padding: var(--space-3) var(--space-4); background: var(--text-primary); border-radius: var(--radius-lg); color: var(--bg-primary); font-size: var(--text-sm); font-weight: var(--font-medium); transition: opacity var(--duration-fast) var(--ease-default); }
  .btn:hover { opacity: 0.9; }
  
  .result { margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-primary); }
  .result.hidden { display: none; }
  .article-info { margin-bottom: var(--space-3); font-size: var(--text-sm); color: var(--text-primary); line-height: 1.6; }
  
  .format-tabs { display: flex; flex-wrap: wrap; gap: var(--space-1); margin-bottom: var(--space-3); }
  .tab { padding: var(--space-1) var(--space-2); background: var(--bg-secondary); border-radius: var(--radius-md); font-size: var(--text-xs); color: var(--text-secondary); }
  .tab.active { background: var(--text-primary); color: var(--bg-primary); }
  
  .output { position: relative; background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--space-3); }
  .output pre { font-size: var(--text-sm); color: var(--text-primary); white-space: pre-wrap; word-break: break-word; margin: 0; font-family: inherit; }
  .output.hidden { display: none; }
  .copy-btn { position: absolute; top: var(--space-2); right: var(--space-2); padding: var(--space-1) var(--space-2); background: var(--bg-tertiary); border-radius: var(--radius-md); font-size: var(--text-xs); color: var(--text-secondary); }
  .copy-btn:hover { color: var(--text-primary); }
  
  .metrics { display: flex; gap: var(--space-4); }
  .metric { display: flex; flex-direction: column; align-items: center; padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-lg); flex: 1; }
  .metric .val { font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text-primary); }
  .metric .lbl { font-size: var(--text-xs); color: var(--text-tertiary); }
  
  .symbols { display: flex; flex-wrap: wrap; gap: var(--space-1); }
  .symbols button { padding: var(--space-1) var(--space-2); background: var(--bg-secondary); border-radius: var(--radius-md); font-size: var(--text-xs); color: var(--text-secondary); font-family: var(--font-mono); }
  .symbols button:hover { background: var(--bg-tertiary); color: var(--text-primary); }
  .preview { min-height: 80px; padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; }
  
  .translate-row { display: flex; align-items: center; gap: var(--space-2); }
  .translate-row select { padding: var(--space-2); background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-md); color: var(--text-primary); font-size: var(--text-sm); flex: 1; }
  .swap-btn { width: 36px; height: 36px; background: var(--bg-secondary); border-radius: var(--radius-md); color: var(--text-secondary); }
  .swap-btn:hover { color: var(--text-primary); }
  
  .tags { display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-3); }
  .tags.hidden { display: none; }
  .tag { padding: var(--space-1) var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-full); font-size: var(--text-sm); color: var(--text-primary); }
</style>

<script>
  const toolsGrid = document.getElementById('tools-grid');
  const panels = document.querySelectorAll('.panel');
  let article = null;
  let format = 'APA';
  
  document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.tool;
      toolsGrid.style.display = 'none';
      panels.forEach(p => p.classList.toggle('active', p.id === `panel-${id}`));
    });
  });
  
  document.querySelectorAll('[data-back]').forEach(btn => {
    btn.addEventListener('click', () => {
      panels.forEach(p => p.classList.remove('active'));
      toolsGrid.style.display = 'grid';
    });
  });
  
  // DOI
  document.getElementById('fetch-doi')?.addEventListener('click', async () => {
    const doi = document.getElementById('doi-input').value.trim();
    if (!doi) return;
    try {
      const res = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`);
      const data = await res.json();
      if (data.message) {
        article = data.message;
        const info = document.getElementById('article-info');
        info.innerHTML = `<strong>${article.title?.[0] || ''}</strong><br>${article.author?.map(a => `${a.given} ${a.family}`).join(', ') || ''}<br><em>${article['container-title']?.[0] || ''}</em>, ${article.published?.['date-parts']?.[0]?.[0] || ''}`;
        document.getElementById('doi-result').classList.remove('hidden');
        renderCitation();
      }
    } catch (e) { alert('获取失败'); }
  });
  
  document.querySelectorAll('#format-tabs .tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('#format-tabs .tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      format = tab.dataset.format;
      renderCitation();
    });
  });
  
  function renderCitation() {
    if (!article) return;
    const t = article.title?.[0] || '';
    const authors = article.author || [];
    const journal = article['container-title']?.[0] || '';
    const year = article.published?.['date-parts']?.[0]?.[0] || '';
    const vol = article.volume || '';
    const issue = article.issue || '';
    const pages = article.page || '';
    const doi = article.DOI || '';
    
    let out = '';
    const au = authors.slice(0, 3).map(a => `${a.family}, ${a.given?.[0] || ''}.`).join(', ');
    
    if (format === 'APA') out = `${au} (${year}). ${t}. ${journal}, ${vol}(${issue}), ${pages}. https://doi.org/${doi}`;
    else if (format === 'MLA') out = `${authors[0]?.family || ''}, ${authors[0]?.given || ''}. "${t}." ${journal}, vol. ${vol}, no. ${issue}, ${year}, pp. ${pages}.`;
    else if (format === 'Chicago') out = `${au}. "${t}." ${journal} ${vol}, no. ${issue} (${year}): ${pages}.`;
    else if (format === 'IEEE') out = `${authors.map(a => `${a.given?.[0] || ''}. ${a.family}`).join(', ')}, "${t}," ${journal}, vol. ${vol}, no. ${issue}, pp. ${pages}, ${year}.`;
    else if (format === 'Vancouver') out = `${authors.map(a => `${a.family} ${a.given?.[0] || ''}`).join(', ')}. ${t}. ${journal}. ${year};${vol}(${issue}):${pages}.`;
    else if (format === 'GB/T 7714') out = `${authors.slice(0, 3).map(a => a.family).join(', ')}. ${t}[J]. ${journal}, ${year}, ${vol}(${issue}): ${pages}.`;
    else if (format === 'BibTeX') out = `@article{${authors[0]?.family?.toLowerCase() || 'key'}${year},\n  author = {${authors.map(a => `${a.family}, ${a.given}`).join(' and ')}},\n  title = {${t}},\n  journal = {${journal}},\n  year = {${year}},\n  volume = {${vol}},\n  number = {${issue}},\n  pages = {${pages}},\n  doi = {${doi}}\n}`;
    
    document.getElementById('citation-output').textContent = out;
  }
  
  document.getElementById('copy-doi')?.addEventListener('click', () => {
    navigator.clipboard.writeText(document.getElementById('citation-output').textContent);
  });
  
  // BibTeX
  document.getElementById('gen-bibtex')?.addEventListener('click', () => {
    const type = document.getElementById('bibtex-type').value;
    const key = document.getElementById('bibtex-key').value || 'key';
    const title = document.getElementById('bibtex-title').value;
    const author = document.getElementById('bibtex-author').value;
    const journal = document.getElementById('bibtex-journal').value;
    const year = document.getElementById('bibtex-year').value;
    const volume = document.getElementById('bibtex-volume').value;
    const pages = document.getElementById('bibtex-pages').value;
    
    let b = `@${type}{${key},\n`;
    if (author) b += `  author = {${author}},\n`;
    if (title) b += `  title = {${title}},\n`;
    if (journal) b += `  journal = {${journal}},\n`;
    if (year) b += `  year = {${year}},\n`;
    if (volume) b += `  volume = {${volume}},\n`;
    if (pages) b += `  pages = {${pages}},\n`;
    b = b.slice(0, -2) + '\n}';
    
    document.getElementById('bibtex-code').textContent = b;
    document.getElementById('bibtex-output').classList.remove('hidden');
  });
  
  document.getElementById('copy-bibtex')?.addEventListener('click', () => {
    navigator.clipboard.writeText(document.getElementById('bibtex-code').textContent);
  });
  
  // Symbols
  document.querySelectorAll('.symbols button').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = document.getElementById('latex-input');
      const sym = btn.dataset.sym;
      const start = input.selectionStart;
      input.value = input.value.slice(0, start) + sym + input.value.slice(input.selectionEnd);
      input.focus();
    });
  });
  
  // Swap
  document.getElementById('swap-lang')?.addEventListener('click', () => {
    const src = document.getElementById('src-lang');
    const tgt = document.getElementById('tgt-lang');
    [src.value, tgt.value] = [tgt.value, src.value];
  });
  
  // Keywords
  document.getElementById('extract-kw')?.addEventListener('click', () => {
    const text = document.getElementById('kw-text').value;
    const count = parseInt(document.getElementById('kw-count').value);
    if (!text) return;
    
    const words = text.toLowerCase().match(/\b[a-z\u4e00-\u9fff]{3,}\b/g) || [];
    const freq = {};
    words.forEach(w => freq[w] = (freq[w] || 0) + 1);
    const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, count);
    
    const tags = document.getElementById('kw-tags');
    tags.innerHTML = sorted.map(([w]) => `<span class="tag">${w}</span>`).join('');
    tags.classList.remove('hidden');
  });
</script>
