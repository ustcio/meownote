---
import Layout from '@layouts/Layout.astro';

const lang = Astro.url.pathname.startsWith('/zh') ? 'zh' : 'en';

const months = lang === 'zh' 
  ? ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']
  : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

const days = lang === 'zh' 
  ? ['日', '一', '二', '三', '四', '五', '六']
  : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

const today = new Date();
const currentYear = today.getFullYear();
const startDate = new Date(today);
startDate.setFullYear(startDate.getFullYear() - 1);
startDate.setDate(startDate.getDate() - startDate.getDay());

function getMonthPositions() {
  const positions = [];
  let lastMonth = -1;
  
  const currentDate = new Date(startDate);
  let dayIndex = 0;
  
  while (currentDate <= today) {
    const week = Math.floor(dayIndex / 7);
    const month = currentDate.getMonth();
    if (month !== lastMonth) {
      positions.push({ month, week });
      lastMonth = month;
    }
    currentDate.setDate(currentDate.getDate() + 1);
    dayIndex++;
  }
  
  return positions;
}

const monthPositions = getMonthPositions();
const totalDays = Math.ceil((today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
const totalWeeks = Math.ceil(totalDays / 7);

const timeRanges = [
  { id: 'realtime', label: lang === 'zh' ? '实时' : 'Real-time' },
  { id: '1m', label: lang === 'zh' ? '1个月' : '1 Month' },
  { id: '3m', label: lang === 'zh' ? '3个月' : '3 Months' },
  { id: '6m', label: lang === 'zh' ? '6个月' : '6 Months' },
  { id: '1y', label: lang === 'zh' ? '1年' : '1 Year' },
];
---

<Layout 
  title={lang === 'zh' ? '黄金价格 - Meow Note' : 'Gold Price - Meow Note'}
  description={lang === 'zh' ? '实时黄金价格查询' : 'Real-time gold price tracking'}
>
  <section class="gold">
    <div class="gold-container">
      <div class="gold-header">
        <a href="/kit" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          <span>{lang === 'zh' ? '返回工具箱' : 'Back to Toolkit'}</span>
        </a>
        <h1 class="gold-title">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          {lang === 'zh' ? '黄金价格' : 'Gold Price'}
        </h1>
        <p class="gold-subtitle">{lang === 'zh' ? '实时追踪国内外黄金价格' : 'Track domestic and international gold prices in real-time'}</p>
      </div>
      
      <div class="time-range-tabs" id="time-range-tabs">
        {timeRanges.map((range, index) => (
          <button 
            class:list={['time-tab', { active: index === 0 }]}
            data-range={range.id}
          >
            {range.label}
          </button>
        ))}
      </div>
      
      <div class="gold-cards">
        <div class="gold-card">
          <div class="card-header">
            <div class="card-icon domestic">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
            </div>
            <div class="card-title-group">
              <h2 class="card-title">{lang === 'zh' ? '国内黄金' : 'Domestic Gold'}</h2>
              <span class="card-unit">{lang === 'zh' ? '元/克' : 'CNY/g'}</span>
            </div>
            <div class="live-badge">
              <span class="live-dot"></span>
              <span class="live-text">LIVE</span>
            </div>
          </div>
          <div class="card-price">
            <span class="price-value" id="domestic-price">--</span>
            <span class="price-change" id="domestic-change">--</span>
          </div>
          <div class="card-stats">
            <div class="stat">
              <span class="stat-label">{lang === 'zh' ? '最高' : 'High'}</span>
              <span class="stat-value" id="domestic-high">--</span>
            </div>
            <div class="stat">
              <span class="stat-label">{lang === 'zh' ? '最低' : 'Low'}</span>
              <span class="stat-value" id="domestic-low">--</span>
            </div>
            <div class="stat">
              <span class="stat-label">{lang === 'zh' ? '开盘' : 'Open'}</span>
              <span class="stat-value" id="domestic-open">--</span>
            </div>
          </div>
          <div class="card-chart">
            <canvas id="domestic-chart"></canvas>
          </div>
        </div>
        
        <div class="gold-card">
          <div class="card-header">
            <div class="card-icon international">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
            </div>
            <div class="card-title-group">
              <h2 class="card-title">{lang === 'zh' ? '国际黄金' : 'International Gold'}</h2>
              <span class="card-unit">{lang === 'zh' ? '美元/盎司' : 'USD/oz'}</span>
            </div>
            <div class="live-badge">
              <span class="live-dot"></span>
              <span class="live-text">LIVE</span>
            </div>
          </div>
          <div class="card-price">
            <span class="price-value" id="international-price">--</span>
            <span class="price-change" id="international-change">--</span>
          </div>
          <div class="card-stats">
            <div class="stat">
              <span class="stat-label">{lang === 'zh' ? '最高' : 'High'}</span>
              <span class="stat-value" id="international-high">--</span>
            </div>
            <div class="stat">
              <span class="stat-label">{lang === 'zh' ? '最低' : 'Low'}</span>
              <span class="stat-value" id="international-low">--</span>
            </div>
            <div class="stat">
              <span class="stat-label">{lang === 'zh' ? '开盘' : 'Open'}</span>
              <span class="stat-value" id="international-open">--</span>
            </div>
          </div>
          <div class="card-chart">
            <canvas id="international-chart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="update-info">
        <span class="update-time" id="update-time">{lang === 'zh' ? '更新中...' : 'Updating...'}</span>
      </div>
    </div>
  </section>
</Layout>

<style>
  .gold {
    min-height: 100vh;
    padding: calc(var(--header-height) + var(--space-8)) var(--space-4) var(--space-12);
  }
  
  .gold-container {
    max-width: var(--container-lg);
    margin: 0 auto;
  }
  
  .gold-header {
    margin-bottom: var(--space-8);
  }
  
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--text-secondary);
    font-size: var(--text-sm);
    margin-bottom: var(--space-4);
    transition: color var(--duration-fast) var(--ease-default);
  }
  
  .back-link:hover {
    color: var(--text-primary);
  }
  
  .gold-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-3);
  }
  
  .gold-title svg {
    color: #FFD700;
  }
  
  .gold-subtitle {
    color: var(--text-secondary);
    font-size: var(--text-lg);
  }
  
  .time-range-tabs {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
  }
  
  .time-tab {
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-full);
    transition: all var(--duration-fast) var(--ease-default);
  }
  
  .time-tab:hover {
    color: var(--text-primary);
    border-color: var(--border-hover);
  }
  
  .time-tab.active {
    color: white;
    background: linear-gradient(135deg, var(--color-accent-blue), var(--color-accent-purple));
    border-color: transparent;
  }
  
  .gold-cards {
    display: grid;
    gap: var(--space-6);
  }
  
  @media (min-width: 1024px) {
    .gold-cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  .gold-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    box-shadow: var(--card-shadow);
  }
  
  .card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
    position: relative;
  }
  
  .card-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: var(--radius-xl);
  }
  
  .card-icon.domestic {
    background: linear-gradient(135deg, #FF6B6B, #FF8E53);
    color: white;
  }
  
  .card-icon.international {
    background: linear-gradient(135deg, #4FACFE, #00F2FE);
    color: white;
  }
  
  .card-title-group {
    flex: 1;
  }
  
  .card-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }
  
  .card-unit {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }
  
  .live-badge {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: rgba(34, 197, 94, 0.15);
    border-radius: var(--radius-full);
    font-size: 10px;
    font-weight: var(--font-semibold);
    letter-spacing: 0.05em;
  }
  
  .live-dot {
    width: 6px;
    height: 6px;
    background: #22c55e;
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
  }
  
  .live-text {
    color: #22c55e;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }
  
  .card-price {
    display: flex;
    align-items: baseline;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }
  
  .price-value {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    font-family: var(--font-number, 'SF Pro Display', monospace);
    font-variant-numeric: tabular-nums;
  }
  
  .price-change {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    padding: 2px 8px;
    border-radius: var(--radius-md);
  }
  
  .price-change.up {
    color: #22c55e;
    background: rgba(34, 197, 94, 0.15);
  }
  
  .price-change.down {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.15);
  }
  
  .card-stats {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    padding: var(--space-3);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
  }
  
  .stat {
    flex: 1;
    text-align: center;
  }
  
  .stat-label {
    display: block;
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    margin-bottom: 2px;
  }
  
  .stat-value {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    font-family: var(--font-number, 'SF Pro Display', monospace);
  }
  
  .card-chart {
    height: 200px;
    position: relative;
  }
  
  .card-chart canvas {
    width: 100% !important;
    height: 100% !important;
  }
  
  .update-info {
    text-align: center;
    margin-top: var(--space-6);
  }
  
  .update-time {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }
</style>

<script>
  const API_BASE = 'https://api.agiera.net';
  const REFRESH_INTERVAL = 10000;
  
  let currentTimeRange = 'realtime';
  let domesticChart = null;
  let internationalChart = null;
  let priceHistory = { domestic: [], international: [], labels: [] };
  
  const domesticCtx = document.getElementById('domestic-chart');
  const internationalCtx = document.getElementById('international-chart');
  
  function initCharts() {
    const chartConfig = {
      type: 'line',
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            padding: 10,
            cornerRadius: 8
          }
        },
        scales: {
          x: {
            display: true,
            grid: { display: false },
            ticks: { color: '#888', maxTicksLimit: 6 }
          },
          y: {
            display: true,
            grid: { color: 'rgba(255, 255, 255, 0.1)', drawBorder: false },
            ticks: { color: '#888', maxTicksLimit: 5 }
          }
        },
        elements: {
          point: { radius: 0, hoverRadius: 4 },
          line: { tension: 0.4, borderWidth: 2 }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    };
    
    if (domesticCtx && (window as any).Chart) {
      domesticChart = new (window as any).Chart(domesticCtx, {
        ...chartConfig,
        data: {
          labels: [],
          datasets: [{ data: [], borderColor: '#FF6B6B', backgroundColor: 'rgba(255, 107, 107, 0.1)', fill: true }]
        }
      });
    }
    
    if (internationalCtx && (window as any).Chart) {
      internationalChart = new (window as any).Chart(internationalCtx, {
        ...chartConfig,
        data: {
          labels: [],
          datasets: [{ data: [], borderColor: '#4FACFE', backgroundColor: 'rgba(79, 172, 254, 0.1)', fill: true }]
        }
      });
    }
  }
  
  function formatPrice(price, decimals = 2) {
    return price.toFixed(decimals);
  }
  
  function formatChange(change, isPercent = true) {
    const sign = change >= 0 ? '+' : '';
    return isPercent ? `${sign}${change.toFixed(2)}%` : `${sign}${change.toFixed(2)}`;
  }
  
  function updateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    const updateEl = document.getElementById('update-time');
    if (updateEl) updateEl.textContent = `Last updated: ${timeStr}`;
  }
  
  async function fetchGoldPrice() {
    try {
      const response = await fetch(`${API_BASE}/api/gold`);
      const result = await response.json();
      
      if (result.success) {
        const domestic = result.domestic;
        const international = result.international;
        
        const domesticPriceEl = document.getElementById('domestic-price');
        const domesticChangeEl = document.getElementById('domestic-change');
        const domesticHighEl = document.getElementById('domestic-high');
        const domesticLowEl = document.getElementById('domestic-low');
        const domesticOpenEl = document.getElementById('domestic-open');
        
        if (domesticPriceEl) domesticPriceEl.textContent = formatPrice(domestic.price);
        if (domesticChangeEl) {
          domesticChangeEl.textContent = formatChange(domestic.change);
          domesticChangeEl.className = `price-change ${domestic.change >= 0 ? 'up' : 'down'}`;
        }
        if (domesticHighEl) domesticHighEl.textContent = formatPrice(domestic.high);
        if (domesticLowEl) domesticLowEl.textContent = formatPrice(domestic.low);
        if (domesticOpenEl) domesticOpenEl.textContent = formatPrice(domestic.open);
        
        const internationalPriceEl = document.getElementById('international-price');
        const internationalChangeEl = document.getElementById('international-change');
        const internationalHighEl = document.getElementById('international-high');
        const internationalLowEl = document.getElementById('international-low');
        const internationalOpenEl = document.getElementById('international-open');
        
        if (internationalPriceEl) internationalPriceEl.textContent = formatPrice(international.price);
        if (internationalChangeEl) {
          internationalChangeEl.textContent = formatChange(international.change);
          internationalChangeEl.className = `price-change ${international.change >= 0 ? 'up' : 'down'}`;
        }
        if (internationalHighEl) internationalHighEl.textContent = formatPrice(international.high);
        if (internationalLowEl) internationalLowEl.textContent = formatPrice(international.low);
        if (internationalOpenEl) internationalOpenEl.textContent = formatPrice(international.open);
        
        const now = new Date();
        const timeLabel = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        priceHistory.domestic.push(domestic.price);
        priceHistory.international.push(international.price);
        priceHistory.labels.push(timeLabel);
        
        if (priceHistory.domestic.length > 60) {
          priceHistory.domestic.shift();
          priceHistory.international.shift();
          priceHistory.labels.shift();
        }
        
        updateCharts();
        updateTime();
      }
    } catch (error) {
      console.error('Failed to fetch gold price:', error);
    }
  }
  
  function updateCharts() {
    if (domesticChart) {
      domesticChart.data.labels = priceHistory.labels;
      domesticChart.data.datasets[0].data = priceHistory.domestic;
      domesticChart.update('none');
    }
    
    if (internationalChart) {
      internationalChart.data.labels = priceHistory.labels;
      internationalChart.data.datasets[0].data = priceHistory.international;
      internationalChart.update('none');
    }
  }
  
  async function fetchHistoricalData(range) {
    try {
      const response = await fetch(`${API_BASE}/api/gold/history?range=${range}`);
      const result = await response.json();
      
      if (result.success) {
        priceHistory.domestic = result.domestic.prices;
        priceHistory.international = result.international.prices;
        priceHistory.labels = result.labels;
        updateCharts();
      }
    } catch (error) {
      console.error('Failed to fetch historical data:', error);
    }
  }
  
  document.querySelectorAll('.time-tab').forEach(tab => {
    tab.addEventListener('click', async () => {
      document.querySelectorAll('.time-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      currentTimeRange = tab.getAttribute('data-range') || 'realtime';
      
      if (currentTimeRange === 'realtime') {
        priceHistory = { domestic: [], international: [], labels: [] };
        await fetchGoldPrice();
      } else {
        await fetchHistoricalData(currentTimeRange);
      }
    });
  });
  
  document.addEventListener('DOMContentLoaded', async () => {
    if ((window as any).Chart) {
      initCharts();
      await fetchGoldPrice();
      setInterval(fetchGoldPrice, REFRESH_INTERVAL);
    } else {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      script.onload = async () => {
        initCharts();
        await fetchGoldPrice();
        setInterval(fetchGoldPrice, REFRESH_INTERVAL);
      };
      document.head.appendChild(script);
    }
  });
</script>
