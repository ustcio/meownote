---
import Layout from '@layouts/Layout.astro';

const lang = Astro.url.pathname.startsWith('/zh') ? 'zh' : 'en';

const timeRanges = [
  { id: 'realtime', label: lang === 'zh' ? '实时' : 'Real-time' },
  { id: '1m', label: lang === 'zh' ? '1个月' : '1 Month' },
  { id: '3m', label: lang === 'zh' ? '3个月' : '3 Months' },
  { id: '6m', label: lang === 'zh' ? '6个月' : '6 Months' },
  { id: '1y', label: lang === 'zh' ? '1年' : '1 Year' },
];
---

<Layout 
  title={lang === 'zh' ? '黄金价格 - Meow Note' : 'Gold Price - Meow Note'}
  description={lang === 'zh' ? '实时黄金价格查询' : 'Real-time gold price tracking'}
>
  <section class="gold">
    <div class="container">
      <header class="header">
        <a href="/kit" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          <span>{lang === 'zh' ? '工具箱' : 'Toolkit'}</span>
        </a>
        <h1 class="title">{lang === 'zh' ? '黄金价格' : 'Gold Price'}</h1>
        <p class="desc">{lang === 'zh' ? '实时追踪国内外黄金价格' : 'Track domestic and international gold prices'}</p>
      </header>
      
      <div class="tabs" id="time-range-tabs">
        {timeRanges.map((range, index) => (
          <button class:list={['tab', { active: index === 0 }]} data-range={range.id}>
            {range.label}
          </button>
        ))}
      </div>
      
      <div class="cards">
        <div class="card">
          <div class="card-head">
            <h2 class="card-title">{lang === 'zh' ? '国内黄金' : 'Domestic Gold'}</h2>
            <span class="unit">{lang === 'zh' ? '元/克' : 'CNY/g'}</span>
          </div>
          <div class="price-row">
            <span class="price" id="domestic-price">--</span>
            <span class="change" id="domestic-change">--</span>
          </div>
          <div class="stats">
            <div class="stat"><span class="lbl">{lang === 'zh' ? '最高' : 'High'}</span><span class="val" id="domestic-high">--</span></div>
            <div class="stat"><span class="lbl">{lang === 'zh' ? '最低' : 'Low'}</span><span class="val" id="domestic-low">--</span></div>
            <div class="stat"><span class="lbl">{lang === 'zh' ? '开盘' : 'Open'}</span><span class="val" id="domestic-open">--</span></div>
          </div>
          <div class="chart"><canvas id="domestic-chart"></canvas></div>
        </div>
        
        <div class="card">
          <div class="card-head">
            <h2 class="card-title">{lang === 'zh' ? '国际黄金' : 'International Gold'}</h2>
            <span class="unit">{lang === 'zh' ? '美元/盎司' : 'USD/oz'}</span>
          </div>
          <div class="price-row">
            <span class="price" id="international-price">--</span>
            <span class="change" id="international-change">--</span>
          </div>
          <div class="stats">
            <div class="stat"><span class="lbl">{lang === 'zh' ? '最高' : 'High'}</span><span class="val" id="international-high">--</span></div>
            <div class="stat"><span class="lbl">{lang === 'zh' ? '最低' : 'Low'}</span><span class="val" id="international-low">--</span></div>
            <div class="stat"><span class="lbl">{lang === 'zh' ? '开盘' : 'Open'}</span><span class="val" id="international-open">--</span></div>
          </div>
          <div class="chart"><canvas id="international-chart"></canvas></div>
        </div>
      </div>
      
      <div class="update">
        <span id="update-time">{lang === 'zh' ? '更新中...' : 'Updating...'}</span>
      </div>
    </div>
  </section>
</Layout>

<style>
  .gold { min-height: 100vh; padding: calc(var(--header-total-height) + var(--space-4)) var(--space-4) var(--space-16); }
  .container { max-width: 800px; margin: 0 auto; }
  
  .header { margin-bottom: var(--space-8); }
  .back-link { display: inline-flex; align-items: center; gap: var(--space-1); color: var(--text-tertiary); font-size: var(--text-sm); margin-bottom: var(--space-4); }
  .back-link:hover { color: var(--text-secondary); }
  .title { font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary); margin-bottom: var(--space-1); }
  .desc { font-size: var(--text-sm); color: var(--text-secondary); }
  
  .tabs { display: flex; justify-content: center; gap: var(--space-2); margin-bottom: var(--space-6); flex-wrap: wrap; }
  .tab { padding: var(--space-2) var(--space-4); font-size: var(--text-sm); color: var(--text-secondary); background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-full); transition: all var(--duration-fast) var(--ease-default); }
  .tab:hover { color: var(--text-primary); border-color: var(--border-hover); }
  .tab.active { color: var(--bg-primary); background: var(--text-primary); border-color: transparent; }
  
  .cards { display: grid; gap: var(--space-4); }
  @media (min-width: 768px) { .cards { grid-template-columns: repeat(2, 1fr); } }
  
  .card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-xl); padding: var(--space-5); }
  
  .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); }
  .card-title { font-size: var(--text-base); font-weight: var(--font-semibold); color: var(--text-primary); }
  .unit { font-size: var(--text-xs); color: var(--text-tertiary); }
  
  .price-row { display: flex; align-items: baseline; gap: var(--space-3); margin-bottom: var(--space-4); }
  .price { font-size: var(--text-3xl); font-weight: var(--font-bold); color: var(--text-primary); font-variant-numeric: tabular-nums; }
  .change { font-size: var(--text-sm); font-weight: var(--font-medium); padding: 2px 8px; border-radius: var(--radius-md); }
  .change.up { color: #22c55e; background: rgba(34, 197, 94, 0.15); }
  .change.down { color: #ef4444; background: rgba(239, 68, 68, 0.15); }
  
  .stats { display: flex; gap: var(--space-3); margin-bottom: var(--space-4); padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-lg); }
  .stat { flex: 1; text-align: center; }
  .stat .lbl { display: block; font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: 2px; }
  .stat .val { font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--text-primary); font-variant-numeric: tabular-nums; }
  
  .chart { height: 160px; }
  .chart canvas { width: 100% !important; height: 100% !important; }
  
  .update { text-align: center; margin-top: var(--space-6); font-size: var(--text-xs); color: var(--text-tertiary); }
  
  /* 加载状态样式 */
  .price.loading {
    opacity: 0.6;
    animation: pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }
</style>

<script>
  // Gold Price API Configuration
  // Using your Cloudflare Worker for SGE and international gold prices
  const API_BASE = 'https://api.agiera.net'; // 你的 Worker 地址
  const REFRESH_INTERVAL = 30000; // 30 seconds - 更频繁的更新
  
  // 显示加载状态
  function showLoading() {
    const ids = ['domestic-price', 'international-price'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('loading');
    });
  }
  
  // 隐藏加载状态
  function hideLoading() {
    const ids = ['domestic-price', 'international-price'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.remove('loading');
    });
  }
  
  let currentTimeRange = 'realtime';
  let domesticChart = null;
  let internationalChart = null;
  let priceHistory = { domestic: [], international: [], labels: [] };
  
  const domesticCtx = document.getElementById('domestic-chart');
  const internationalCtx = document.getElementById('international-chart');
  
  function initCharts() {
    const chartConfig = {
      type: 'line',
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 8, cornerRadius: 6 } },
        scales: {
          x: { display: true, grid: { display: false }, ticks: { color: '#888', maxTicksLimit: 5 } },
          y: { display: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#888', maxTicksLimit: 4 } }
        },
        elements: { point: { radius: 0, hoverRadius: 4 }, line: { tension: 0.4, borderWidth: 2 } },
        interaction: { intersect: false, mode: 'index' }
      }
    };
    
    if (domesticCtx && (window as any).Chart) {
      domesticChart = new (window as any).Chart(domesticCtx, {
        ...chartConfig,
        data: { labels: [], datasets: [{ data: [], borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true }] }
      });
    }
    
    if (internationalCtx && (window as any).Chart) {
      internationalChart = new (window as any).Chart(internationalCtx, {
        ...chartConfig,
        data: { labels: [], datasets: [{ data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true }] }
      });
    }
  }
  
  function formatPrice(price, decimals = 2) {
    return price.toFixed(decimals);
  }
  
  function formatChange(change) {
    const sign = change >= 0 ? '+' : '';
    return `${sign}${change.toFixed(2)}%`;
  }
  
  function updateTime(timestamp?: number) {
    const el = document.getElementById('update-time');
    if (el) {
      if (timestamp) {
        const date = new Date(timestamp);
        el.textContent = date.toLocaleTimeString();
      } else {
        el.textContent = new Date().toLocaleTimeString();
      }
    }
  }
  
  // Fetch gold price from your Worker API
  async function fetchGoldPriceData(forceRefresh = false) {
    try {
      showLoading();
      
      // 添加时间戳参数来绕过缓存
      const timestamp = Date.now();
      const refreshParam = forceRefresh ? '&refresh=true' : '';
      const url = `${API_BASE}/api/gold?t=${timestamp}${refreshParam}`;
      
      console.log('[Gold] Fetching from:', url);
      
      const response = await fetch(url, {
        headers: { 
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log('[Gold] Data received:', data);
        
        if (data.success) {
          return data;
        }
      } else {
        console.error('[Gold] API error:', response.status, response.statusText);
      }
      
      console.warn('[Gold] Failed to fetch gold price from API');
      return null;
      
    } catch (error) {
      console.error('[Gold] Failed to fetch gold price:', error);
      return null;
    } finally {
      hideLoading();
    }
  }
  
  // Fetch historical data from your Worker
  async function fetchHistoricalData(range: string) {
    try {
      const response = await fetch(`${API_BASE}/api/gold/history?range=${range}`);
      if (response.ok) {
        return await response.json();
      }
    } catch (error) {
      console.error('Failed to fetch historical data:', error);
    }
    
    // Fallback: generate simulated data
    return generateSimulatedHistory(range);
  }
  
  // Generate simulated historical data for fallback
  function generateSimulatedHistory(range: string) {
    const days = { '1m': 30, '3m': 90, '6m': 180, '1y': 365 }[range] || 30;
    const basePrice = 2000;
    const labels = [];
    const domesticPrices = [];
    const internationalPrices = [];
    
    for (let i = days; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      
      const randomChange = (Math.random() - 0.5) * 50;
      const price = basePrice + randomChange + (days - i) * 0.5;
      internationalPrices.push(price);
      domesticPrices.push(price * 7.2 / 31.1035);
    }
    
    return {
      success: true,
      labels: labels,
      domestic: { prices: domesticPrices },
      international: { prices: internationalPrices }
    };
  }
  
  async function fetchGoldPrice(forceRefresh = false) {
    try {
      console.log('[Gold] Fetching price data...');
      
      // 使用正确的函数名 fetchGoldPriceData
      const data = await fetchGoldPriceData(forceRefresh);
      if (!data || !data.success) {
        console.error('[Gold] Failed to fetch gold price data:', data?.error || 'Unknown error');
        
        // 显示错误状态
        const dp = document.getElementById('domestic-price');
        const ip = document.getElementById('international-price');
        if (dp) dp.textContent = 'Error';
        if (ip) ip.textContent = 'Error';
        
        return;
      }
      
      console.log('[Gold] Data fetched successfully:', {
        domestic: data.domestic?.price,
        international: data.international?.price,
        source: data.domestic?.source
      });
      
      // 从 API 响应中获取国内和国际金价数据
      const domestic = data.domestic;
      const international = data.international;
      
      // Update Domestic Gold Display
      const dp = document.getElementById('domestic-price');
      const dc = document.getElementById('domestic-change');
      const dh = document.getElementById('domestic-high');
      const dl = document.getElementById('domestic-low');
      const dopen = document.getElementById('domestic-open');
      
      if (dp && domestic?.price) dp.textContent = formatPrice(domestic.price);
      if (dc && domestic?.changePercent !== undefined) { 
        dc.textContent = formatChange(domestic.changePercent); 
        dc.className = `change ${domestic.changePercent >= 0 ? 'up' : 'down'}`; 
      }
      if (dh && domestic?.high) dh.textContent = formatPrice(domestic.high);
      if (dl && domestic?.low) dl.textContent = formatPrice(domestic.low);
      if (dopen && domestic?.open) dopen.textContent = formatPrice(domestic.open);
      
      // Update International Gold Display
      const ip = document.getElementById('international-price');
      const ic = document.getElementById('international-change');
      const ih = document.getElementById('international-high');
      const il = document.getElementById('international-low');
      const iopen = document.getElementById('international-open');
      
      if (ip && international?.price) ip.textContent = formatPrice(international.price);
      if (ic && international?.changePercent !== undefined) { 
        ic.textContent = formatChange(international.changePercent); 
        ic.className = `change ${international.changePercent >= 0 ? 'up' : 'down'}`; 
      }
      if (ih && international?.high) ih.textContent = formatPrice(international.high);
      if (il && international?.low) il.textContent = formatPrice(international.low);
      if (iopen && international?.open) iopen.textContent = formatPrice(international.open);
      
      // Update chart data (only in realtime mode)
      if (currentTimeRange === 'realtime') {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        
        priceHistory.domestic.push(domestic.price);
        priceHistory.international.push(international.price);
        priceHistory.labels.push(timeLabel);
        
        if (priceHistory.domestic.length > 60) {
          priceHistory.domestic.shift();
          priceHistory.international.shift();
          priceHistory.labels.shift();
        }
        
        updateCharts();
      }
      
      updateTime(data.timestamp);
      
    } catch (error) {
      console.error('[Gold] Failed to fetch gold price:', error);
    }
  }
  
  function updateCharts() {
    if (domesticChart) {
      domesticChart.data.labels = priceHistory.labels;
      domesticChart.data.datasets[0].data = priceHistory.domestic;
      domesticChart.update('none');
    }
    
    if (internationalChart) {
      internationalChart.data.labels = priceHistory.labels;
      internationalChart.data.datasets[0].data = priceHistory.international;
      internationalChart.update('none');
    }
  }
  
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', async () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      currentTimeRange = tab.getAttribute('data-range') || 'realtime';
      
      if (currentTimeRange === 'realtime') {
        priceHistory = { domestic: [], international: [], labels: [] };
        await fetchGoldPrice();
      } else {
        await fetchHistoricalData(currentTimeRange);
      }
    });
  });
  
  document.addEventListener('DOMContentLoaded', async () => {
    if ((window as any).Chart) {
      initCharts();
      await fetchGoldPrice();
      setInterval(fetchGoldPrice, REFRESH_INTERVAL);
    } else {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      script.onload = async () => {
        initCharts();
        await fetchGoldPrice();
        setInterval(fetchGoldPrice, REFRESH_INTERVAL);
      };
      document.head.appendChild(script);
    }
  });
</script>
