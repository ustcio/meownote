---
import Layout from '@layouts/Layout.astro';

const lang = Astro.url.pathname.startsWith('/zh') ? 'zh' : 'en';

const dayTabs = [
  { id: 'today', label: lang === 'zh' ? '今日金价' : 'Today' },
  { id: 'yesterday', label: lang === 'zh' ? '昨日金价' : 'Yesterday' },
];
---

<Layout 
  title={lang === 'zh' ? '黄金价格 - Meow Note' : 'Gold Price - Meow Note'}
  description={lang === 'zh' ? '追踪国内外黄金价格' : 'Track domestic and international gold prices'}
>
  <!-- Preload Chart.js for faster rendering -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" as="script" />
  
  <section class="gold">
    <div class="container">
      <header class="header">
        <a href="/kit" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          <span>{lang === 'zh' ? '工具箱' : 'Toolkit'}</span>
        </a>
        <h1 class="title">{lang === 'zh' ? '黄金价格' : 'Gold Price'}</h1>
        <p class="desc">{lang === 'zh' ? '追踪国内外黄金价格走势' : 'Track domestic and international gold prices'}</p>
      </header>
      
      <div class="tabs" id="day-tabs">
        {dayTabs.map((tab, index) => (
          <button class:list={['tab', { active: index === 0 }]} data-day={tab.id}>
            {tab.label}
          </button>
        ))}
      </div>
      
      <div class="cards">
        <div class="card">
          <div class="card-head">
            <h2 class="card-title">{lang === 'zh' ? '国内黄金' : 'Domestic Gold'}</h2>
            <span class="unit">{lang === 'zh' ? '元/克' : 'CNY/g'}</span>
          </div>
          <div class="price-row">
            <span class="price" id="domestic-price">--</span>
            <span class="change" id="domestic-change">--</span>
          </div>
          <div class="stats">
            <div class="stat"><span class="lbl">{lang === 'zh' ? '最高' : 'High'}</span><span class="val" id="domestic-high">--</span></div>
            <div class="stat"><span class="lbl">{lang === 'zh' ? '最低' : 'Low'}</span><span class="val" id="domestic-low">--</span></div>
            <div class="stat"><span class="lbl">{lang === 'zh' ? '开盘' : 'Open'}</span><span class="val" id="domestic-open">--</span></div>
          </div>
          <div class="chart"><canvas id="domestic-chart"></canvas><div class="chart-empty" id="domestic-empty">数据采集中...</div></div>
        </div>
        
        <div class="card">
          <div class="card-head">
            <h2 class="card-title">{lang === 'zh' ? '国际黄金' : 'International Gold'}</h2>
            <span class="unit">{lang === 'zh' ? '美元/盎司' : 'USD/oz'}</span>
          </div>
          <div class="price-row">
            <span class="price" id="international-price">--</span>
            <span class="change" id="international-change">--</span>
          </div>
          <div class="stats">
            <div class="stat"><span class="lbl">{lang === 'zh' ? '最高' : 'High'}</span><span class="val" id="international-high">--</span></div>
            <div class="stat"><span class="lbl">{lang === 'zh' ? '最低' : 'Low'}</span><span class="val" id="international-low">--</span></div>
            <div class="stat"><span class="lbl">{lang === 'zh' ? '开盘' : 'Open'}</span><span class="val" id="international-open">--</span></div>
          </div>
          <div class="chart"><canvas id="international-chart"></canvas><div class="chart-empty" id="international-empty">数据采集中...</div></div>
        </div>
      </div>
      
      <div class="update">
        <span id="update-time">{lang === 'zh' ? '更新中...' : 'Updating...'}</span>
      </div>
    </div>
  </section>
</Layout>

<style>
  .gold { min-height: 100vh; padding: calc(var(--header-total-height) + var(--space-4)) var(--space-4) var(--space-16); }
  .container { max-width: 800px; margin: 0 auto; }
  
  .header { margin-bottom: var(--space-8); }
  .back-link { display: inline-flex; align-items: center; gap: var(--space-1); color: var(--text-tertiary); font-size: var(--text-sm); margin-bottom: var(--space-4); }
  .back-link:hover { color: var(--text-secondary); }
  .title { font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary); margin-bottom: var(--space-1); }
  .desc { font-size: var(--text-sm); color: var(--text-secondary); }
  
  .tabs { display: flex; justify-content: center; gap: var(--space-2); margin-bottom: var(--space-6); flex-wrap: wrap; }
  .tab { padding: var(--space-2) var(--space-6); font-size: var(--text-sm); color: var(--text-secondary); background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-full); transition: all var(--duration-fast) var(--ease-default); cursor: pointer; }
  .tab:hover { color: var(--text-primary); border-color: var(--border-hover); }
  .tab.active { color: var(--bg-primary); background: var(--text-primary); border-color: transparent; }
  
  .cards { display: grid; gap: var(--space-4); }
  @media (min-width: 768px) { .cards { grid-template-columns: repeat(2, 1fr); } }
  
  .card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-xl); padding: var(--space-5); }
  
  .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); }
  .card-title { font-size: var(--text-base); font-weight: var(--font-semibold); color: var(--text-primary); }
  .unit { font-size: var(--text-xs); color: var(--text-tertiary); }
  
  .price-row { display: flex; align-items: baseline; gap: var(--space-3); margin-bottom: var(--space-4); }
  .price { font-size: var(--text-3xl); font-weight: var(--font-bold); color: var(--text-primary); font-variant-numeric: tabular-nums; font-family: var(--font-number); }
  .change { font-size: var(--text-sm); font-weight: var(--font-medium); padding: 2px 8px; border-radius: var(--radius-md); font-family: var(--font-number); }
  .change.up { color: #22c55e; background: rgba(34, 197, 94, 0.15); }
  .change.down { color: #ef4444; background: rgba(239, 68, 68, 0.15); }
  
  .stats { display: flex; gap: var(--space-3); margin-bottom: var(--space-4); padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-lg); }
  .stat { flex: 1; text-align: center; }
  .stat .lbl { display: block; font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: 2px; }
  .stat .val { font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--text-primary); font-variant-numeric: tabular-nums; font-family: var(--font-number); }
  
  .chart { height: 200px; position: relative; }
  .chart canvas { width: 100% !important; height: 100% !important; }
  .chart-empty {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-tertiary);
    font-size: var(--text-sm);
    text-align: center;
  }
  
  .update { text-align: center; margin-top: var(--space-6); font-size: var(--text-xs); color: var(--text-tertiary); }
  
  .price.loading {
    opacity: 0.6;
    animation: pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }
  
  .price.error {
    color: #ef4444;
  }
</style>

<script>
  const API_BASE = 'https://api.ustc.dev';
  const REFRESH_INTERVAL = 30000;
  const lang = window.location.pathname.startsWith('/zh') ? 'zh' : 'en';
  
  function showLoading() {
    const ids = ['domestic-price', 'international-price'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('loading');
    });
  }
  
  function hideLoading() {
    const ids = ['domestic-price', 'international-price'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.remove('loading');
    });
  }
  
  let currentDay = 'today';
  let domesticChart = null;
  let internationalChart = null;
  let todayData = null;
  let yesterdayData = null;
  
  const domesticCtx = document.getElementById('domestic-chart');
  const internationalCtx = document.getElementById('international-chart');
  
  function initCharts() {
    const SF_PRO_FONT = '"SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif';
    
    const chartConfig = {
      type: 'line',
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: false }, 
          tooltip: { 
            backgroundColor: 'rgba(0, 0, 0, 0.85)', 
            padding: 12, 
            cornerRadius: 8,
            titleFont: { family: SF_PRO_FONT, size: 13, weight: 'bold' },
            bodyFont: { family: SF_PRO_FONT, size: 12 },
            callbacks: {
              label: function(context) {
                return `${context.parsed.y.toFixed(2)}`;
              }
            }
          } 
        },
        scales: {
          x: { 
            display: true, 
            grid: { display: false, drawBorder: false }, 
            ticks: { 
              color: '#888', 
              maxTicksLimit: 8,
              font: { family: SF_PRO_FONT, size: 10 }
            },
            title: {
              display: true,
              text: lang === 'zh' ? '时间' : 'Time',
              color: '#666',
              font: { family: SF_PRO_FONT, size: 11 }
            }
          },
          y: { 
            display: true, 
            grid: { 
              color: 'rgba(255, 255, 255, 0.06)',
              drawBorder: false
            }, 
            ticks: { 
              color: '#888', 
              maxTicksLimit: 5,
              font: { family: SF_PRO_FONT, size: 10 },
              callback: function(value) {
                return value.toFixed(1);
              }
            }
          }
        },
        elements: { 
          point: { 
            radius: 0,
            hitRadius: 10,
            hoverRadius: 4,
            hoverBackgroundColor: '#fff',
            hoverBorderWidth: 2,
            pointStyle: false
          }, 
          line: { 
            tension: 0.4, 
            borderWidth: 2,
            borderJoinStyle: 'round',
            borderCapStyle: 'round'
          } 
        },
        interaction: { intersect: false, mode: 'index' },
        animation: {
          duration: 300
        }
      }
    };
    
    if (domesticCtx && window.Chart) {
      domesticChart = new window.Chart(domesticCtx, {
        ...chartConfig,
        data: { 
          labels: [], 
          datasets: [{ 
            data: [], 
            borderColor: '#f97316', 
            backgroundColor: 'rgba(249, 115, 22, 0.15)', 
            fill: true,
            borderWidth: 2.5
          }] 
        },
        options: {
          ...chartConfig.options,
          scales: {
            ...chartConfig.options.scales,
            y: {
              ...chartConfig.options.scales.y,
              title: {
                display: true,
                text: lang === 'zh' ? '价格 (元/克)' : 'Price (CNY/g)',
                color: '#f97316',
                font: { family: SF_PRO_FONT, size: 11, weight: 'bold' }
              }
            }
          }
        }
      });
    }

    if (internationalCtx && window.Chart) {
      internationalChart = new window.Chart(internationalCtx, {
        ...chartConfig,
        data: { 
          labels: [], 
          datasets: [{ 
            data: [], 
            borderColor: '#3b82f6', 
            backgroundColor: 'rgba(59, 130, 246, 0.15)', 
            fill: true,
            borderWidth: 2.5
          }] 
        },
        options: {
          ...chartConfig.options,
          scales: {
            ...chartConfig.options.scales,
            y: {
              ...chartConfig.options.scales.y,
              title: {
                display: true,
                text: lang === 'zh' ? '价格 (美元/盎司)' : 'Price (USD/oz)',
                color: '#3b82f6',
                font: { family: SF_PRO_FONT, size: 11, weight: 'bold' }
              }
            }
          }
        }
      });
    }
  }
  
  function formatPrice(price, decimals = 2) {
    if (price === undefined || price === null || isNaN(price)) {
      return '--';
    }
    return price.toFixed(decimals);
  }

  function formatChange(change) {
    if (change === undefined || change === null || isNaN(change)) return '--';
    const sign = change >= 0 ? '+' : '';
    return `${sign}${change.toFixed(2)}%`;
  }

  function updateTime(timestamp) {
    const el = document.getElementById('update-time');
    if (el) {
      if (timestamp) {
        const date = new Date(timestamp);
        el.textContent = date.toLocaleString('zh-CN', { 
          timeZone: 'Asia/Shanghai',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
      } else {
        el.textContent = new Date().toLocaleString('zh-CN', { 
          timeZone: 'Asia/Shanghai',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
      }
    }
  }
  
  async function fetchGoldPriceData(date = null) {
    try {
      showLoading();
      
      const timestamp = Date.now();
      let url = `${API_BASE}/api/gold?t=${timestamp}`;
      if (date) {
        url += `&date=${date}`;
      }
      
      console.log('[Gold] Fetching from:', url);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);
      
      const response = await fetch(url, {
        headers: { 
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        },
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (response.ok) {
        const data = await response.json();
        console.log('[Gold] Data received:', data);
        
        if (data.success) {
          return data;
        } else {
          console.error('[Gold] API returned success=false:', data.error);
        }
      } else {
        console.error('[Gold] API error:', response.status);
      }
      
      return null;
      
    } catch (error) {
      console.error('[Gold] Failed to fetch gold price:', error.name, error.message);
      return null;
    } finally {
      hideLoading();
    }
  }
  
  function updateDisplay(data) {
    if (!data || !data.success) {
      const elementsToUpdate = [
        'domestic-price', 'domestic-change', 'domestic-high', 'domestic-low', 'domestic-open',
        'international-price', 'international-change', 'international-high', 'international-low', 'international-open'
      ];
      
      elementsToUpdate.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          if (id.includes('price')) {
            el.textContent = 'Error';
            el.classList.add('error');
          } else {
            el.textContent = '--';
          }
        }
      });
      return;
    }
    
    const domestic = data.domestic;
    const international = data.international;
    
    const dp = document.getElementById('domestic-price');
    const dc = document.getElementById('domestic-change');
    const dh = document.getElementById('domestic-high');
    const dl = document.getElementById('domestic-low');
    const dopen = document.getElementById('domestic-open');
    
    if (dp && domestic && domestic.price !== undefined) dp.textContent = formatPrice(domestic.price);
    if (dc && domestic && domestic.changePercent !== undefined) { 
      dc.textContent = formatChange(domestic.changePercent); 
      dc.className = `change ${domestic.changePercent >= 0 ? 'up' : 'down'}`; 
    }
    if (dh && domestic && domestic.high !== undefined) dh.textContent = formatPrice(domestic.high);
    if (dl && domestic && domestic.low !== undefined) dl.textContent = formatPrice(domestic.low);
    if (dopen && domestic && domestic.open !== undefined) dopen.textContent = formatPrice(domestic.open);
    
    const ip = document.getElementById('international-price');
    const ic = document.getElementById('international-change');
    const ih = document.getElementById('international-high');
    const il = document.getElementById('international-low');
    const iopen = document.getElementById('international-open');
    
    if (ip && international && international.price !== undefined) ip.textContent = formatPrice(international.price);
    if (ic && international && international.changePercent !== undefined) { 
      ic.textContent = formatChange(international.changePercent); 
      ic.className = `change ${international.changePercent >= 0 ? 'up' : 'down'}`; 
    }
    if (ih && international && international.high !== undefined) ih.textContent = formatPrice(international.high);
    if (il && international && international.low !== undefined) il.textContent = formatPrice(international.low);
    if (iopen && international && international.open !== undefined) iopen.textContent = formatPrice(international.open);
    
    updateCharts(data.history);
    updateTime(data.timestamp);
  }
  
  function updateCharts(history) {
    const domesticEmpty = document.getElementById('domestic-empty');
    const internationalEmpty = document.getElementById('international-empty');
    
    if (!history || !history.domestic || history.domestic.length === 0) {
      if (domesticChart) {
        domesticChart.data.labels = [];
        domesticChart.data.datasets[0].data = [];
        domesticChart.update('none');
      }
      if (internationalChart) {
        internationalChart.data.labels = [];
        internationalChart.data.datasets[0].data = [];
        internationalChart.update('none');
      }
      if (domesticEmpty) domesticEmpty.style.display = 'block';
      if (internationalEmpty) internationalEmpty.style.display = 'block';
      return;
    }
    
    if (domesticEmpty) domesticEmpty.style.display = 'none';
    if (internationalEmpty) internationalEmpty.style.display = 'none';
    
    if (domesticChart && history.domestic) {
      domesticChart.data.labels = history.labels || [];
      domesticChart.data.datasets[0].data = history.domestic;
      domesticChart.update('active');
    }
    
    if (internationalChart && history.international) {
      internationalChart.data.labels = history.labels || [];
      internationalChart.data.datasets[0].data = history.international;
      internationalChart.update('active');
    }
  }
  
  async function loadTodayPrice() {
    const data = await fetchGoldPriceData();
    if (data) {
      todayData = data;
      if (currentDay === 'today') {
        updateDisplay(data);
      }
    }
  }
  
  async function loadYesterdayPrice() {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const dateStr = yesterday.toISOString().split('T')[0];
    
    const data = await fetchGoldPriceData(dateStr);
    if (data) {
      yesterdayData = data;
      if (currentDay === 'yesterday') {
        updateDisplay(data);
      }
    }
  }
  
  async function switchDay(day) {
    currentDay = day;
    
    if (day === 'today') {
      if (todayData) {
        updateDisplay(todayData);
      }
      await loadTodayPrice();
    } else {
      if (yesterdayData) {
        updateDisplay(yesterdayData);
      } else {
        await loadYesterdayPrice();
      }
    }
  }
  
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', async () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      const day = tab.getAttribute('data-day') || 'today';
      await switchDay(day);
    });
  });
  
  function initPage() {
    if (window.Chart) {
      initCharts();
      loadTodayPrice();
      if (!window.goldPriceInterval) {
        window.goldPriceInterval = setInterval(() => {
          if (currentDay === 'today') {
            loadTodayPrice();
          }
        }, REFRESH_INTERVAL);
      }
    } else {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      script.async = true;
      script.onload = () => {
        initCharts();
        loadTodayPrice();
        if (!window.goldPriceInterval) {
          window.goldPriceInterval = setInterval(() => {
            if (currentDay === 'today') {
              loadTodayPrice();
            }
          }, REFRESH_INTERVAL);
        }
      };
      script.onerror = () => {
        console.error('[Gold] Failed to load Chart.js');
        const domesticEmpty = document.getElementById('domestic-empty');
        const internationalEmpty = document.getElementById('international-empty');
        if (domesticEmpty) domesticEmpty.textContent = '图表加载失败';
        if (internationalEmpty) internationalEmpty.textContent = '图表加载失败';
      };
      document.head.appendChild(script);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPage);
  } else {
    initPage();
  }
  
  document.addEventListener('astro:page-load', initPage);
</script>
