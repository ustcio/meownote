---
import Layout from '@layouts/Layout.astro';
---

<Layout 
  title="黄金交易管理 - Meow Note"
  description="黄金交易管理与收益分析"
>
  <section class="trading" id="trading-app">
    <div class="trading-login" id="login-section">
      <div class="login-card">
        <div class="login-icon">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
            <circle cx="32" cy="32" r="28" stroke="url(#lockGradient)" stroke-width="3" fill="none"/>
            <rect x="20" y="28" width="24" height="20" rx="3" fill="url(#lockGradient)"/>
            <path d="M24 28V24C24 19.5817 27.5817 16 32 16C36.4183 16 40 19.5817 40 24V28" stroke="url(#lockGradient)" stroke-width="3" fill="none"/>
            <circle cx="32" cy="38" r="3" fill="white"/>
            <rect x="31" y="40" width="2" height="5" fill="white"/>
            <defs>
              <linearGradient id="lockGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#64d2ff"/>
                <stop offset="100%" style="stop-color:#bf5af2"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <h1 class="login-title">超级管理员</h1>
        <p class="login-subtitle">登录以访问交易管理系统</p>
        
        <form class="login-form" id="trading-login-form">
          <div class="form-group">
            <label for="trading-username">用户名</label>
            <div class="input-wrapper">
              <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <input type="text" id="trading-username" name="username" required placeholder="请输入用户名" />
            </div>
          </div>
          <div class="form-group">
            <label for="trading-password">密码</label>
            <div class="input-wrapper password-wrapper">
              <input type="password" id="trading-password" name="password" required placeholder="请输入密码" />
              <button type="button" class="toggle-password" id="trading-toggle-pwd" aria-label="切换密码可见性">
                <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-closed hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="login-btn" id="trading-login-btn">
            <span class="btn-text">登录</span>
            <span class="btn-loading hidden">
              <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
              </svg>
            </span>
          </button>
        </form>
      </div>
    </div>

    <div class="trading-dashboard hidden" id="dashboard-section">
      <div class="dashboard-header">
        <div class="header-left">
          <h1 class="dashboard-title">黄金交易管理</h1>
          <p class="dashboard-subtitle">实时监控金价，智能管理交易</p>
        </div>
        <div class="header-right">
          <div class="current-price-card">
            <span class="price-label">当前金价</span>
            <span class="price-value" id="current-gold-price">--</span>
            <span class="price-unit">元/克</span>
          </div>
          <button class="logout-btn" id="logout-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>退出</span>
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card profit">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-total-profit">¥0.00</span>
            <span class="stat-label">累计收益</span>
          </div>
        </div>
        <div class="stat-card month">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-month-profit">¥0.00</span>
            <span class="stat-label">本月收益</span>
          </div>
        </div>
        <div class="stat-card week">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-week-profit">¥0.00</span>
            <span class="stat-label">本周收益</span>
          </div>
        </div>
        <div class="stat-card quantity">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-total-quantity">0g</span>
            <span class="stat-label">持仓克数</span>
          </div>
        </div>
      </div>

      <div class="main-grid">
        <div class="panel buy-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              买入设置
            </h2>
          </div>
          <form class="panel-form" id="buy-form">
            <div class="form-row">
              <div class="form-group">
                <label>买入金价</label>
                <div class="input-with-unit">
                  <input type="number" id="buy-price" step="0.01" min="0" placeholder="0.00" required />
                  <span class="unit">元/克</span>
                </div>
              </div>
              <div class="form-group">
                <label>买入克数</label>
                <div class="input-with-unit">
                  <input type="number" id="buy-quantity" step="0.001" min="0.001" placeholder="0.000" required />
                  <span class="unit">g</span>
                </div>
              </div>
            </div>
            <div class="calculated-row">
              <span class="calc-label">买入总额</span>
              <span class="calc-value" id="buy-total">¥0.00</span>
            </div>
            <div class="form-group">
              <label>备注</label>
              <input type="text" id="buy-notes" placeholder="可选备注" />
            </div>
            <button type="submit" class="submit-btn buy">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              确认买入
            </button>
          </form>
        </div>

        <div class="panel sell-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              卖出设置
            </h2>
          </div>
          <form class="panel-form" id="sell-form">
            <div class="form-row">
              <div class="form-group">
                <label>卖出价格</label>
                <div class="input-with-unit">
                  <input type="number" id="sell-price" step="0.01" min="0" placeholder="0.00" required />
                  <span class="unit">元/克</span>
                </div>
              </div>
              <div class="form-group">
                <label>卖出克数</label>
                <div class="input-with-unit">
                  <input type="number" id="sell-quantity" step="0.001" min="0.001" placeholder="0.000" required />
                  <span class="unit">g</span>
                </div>
              </div>
            </div>
            <div class="calculated-row">
              <span class="calc-label">卖出总额</span>
              <span class="calc-value" id="sell-total">¥0.00</span>
            </div>
            <div class="form-group">
              <label>备注</label>
              <input type="text" id="sell-notes" placeholder="可选备注" />
            </div>
            <button type="submit" class="submit-btn sell">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              确认卖出
            </button>
          </form>
        </div>

        <div class="panel alert-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              价格预警
            </h2>
          </div>
          <form class="panel-form" id="alert-form">
            <div class="alert-type-row">
              <label class="alert-type-label">
                <input type="radio" name="alert-type" value="buy" checked />
                <span class="alert-type-btn buy">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  买入提醒
                </span>
              </label>
              <label class="alert-type-label">
                <input type="radio" name="alert-type" value="sell" />
                <span class="alert-type-btn sell">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  卖出提醒
                </span>
              </label>
            </div>
            <div class="form-group">
              <label>目标价格</label>
              <div class="input-with-unit">
                <input type="number" id="alert-price" step="0.01" min="0" placeholder="0.00" required />
                <span class="unit">元/克</span>
              </div>
            </div>
            <button type="submit" class="submit-btn alert">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              添加预警
            </button>
          </form>
          <div class="alert-list" id="alert-list"></div>
        </div>
      </div>

      <div class="transactions-section">
        <div class="section-header">
          <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            交易记录
          </h2>
          <div class="filter-row">
            <select id="filter-type">
              <option value="">全部类型</option>
              <option value="buy">买入</option>
              <option value="sell">卖出</option>
            </select>
            <select id="filter-sort">
              <option value="desc">最新优先</option>
              <option value="asc">最早优先</option>
            </select>
          </div>
        </div>
        <div class="transactions-container">
          <div class="transactions-list" id="transactions-list"></div>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>

      <div class="charts-section">
        <div class="chart-card">
          <h3 class="chart-title">每日收益</h3>
          <div class="chart-container" id="daily-chart"></div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">每周收益</h3>
          <div class="chart-container" id="weekly-chart"></div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  .trading {
    min-height: 100vh;
    padding: calc(var(--header-total-height) + var(--space-4)) var(--space-4) var(--space-12);
  }

  .hidden {
    display: none !important;
  }

  .trading-login {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - var(--header-total-height) - var(--space-16));
  }

  .login-card {
    width: 100%;
    max-width: 400px;
    padding: var(--space-8);
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    text-align: center;
  }

  .login-icon {
    margin-bottom: var(--space-6);
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .login-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .login-subtitle {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    margin-bottom: var(--space-6);
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    text-align: left;
  }

  .form-group label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
  }

  .input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .input-icon {
    position: absolute;
    left: var(--space-3);
    color: var(--text-tertiary);
    pointer-events: none;
  }

  .input-wrapper input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    padding-left: calc(var(--space-3) + 26px);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .input-wrapper input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
    box-shadow: 0 0 0 3px rgba(100, 210, 255, 0.15);
    background: var(--bg-primary);
  }

  .input-wrapper.password-wrapper input {
    padding-left: var(--space-4);
    padding-right: 44px;
  }

  .toggle-password {
    position: absolute;
    right: var(--space-2);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-tertiary);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .toggle-password:hover {
    color: var(--text-secondary);
    background: var(--bg-secondary);
  }

  .toggle-password .hidden {
    display: none;
  }

  .login-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    margin-top: var(--space-2);
    background: linear-gradient(135deg, var(--color-accent-blue), var(--color-accent-purple));
    color: white;
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .login-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(100, 210, 255, 0.3);
  }

  .login-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
  }

  .dashboard-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
  }

  .dashboard-subtitle {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .current-price-card {
    display: flex;
    flex-direction: column;
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: var(--radius-xl);
    text-align: center;
  }

  .price-label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .price-value {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: #ffd700;
  }

  .price-unit {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .logout-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    color: var(--text-secondary);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .logout-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  @media (max-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
    .dashboard-header {
      flex-direction: column;
    }
    .header-right {
      width: 100%;
      justify-content: space-between;
    }
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .stat-card .stat-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: var(--radius-xl);
    flex-shrink: 0;
  }

  .stat-card.profit .stat-icon {
    background: rgba(48, 209, 88, 0.15);
    color: #30d158;
  }

  .stat-card.month .stat-icon {
    background: rgba(100, 210, 255, 0.15);
    color: #64d2ff;
  }

  .stat-card.week .stat-icon {
    background: rgba(191, 90, 242, 0.15);
    color: #bf5af2;
  }

  .stat-card.quantity .stat-icon {
    background: rgba(255, 159, 10, 0.15);
    color: #ff9f0a;
  }

  .stat-card .stat-content {
    display: flex;
    flex-direction: column;
  }

  .stat-card .stat-value {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
  }

  .stat-card .stat-label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .main-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  @media (max-width: 1024px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
  }

  .panel {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
  }

  .panel-header {
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--border-primary);
  }

  .panel-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .panel-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
  }

  @media (max-width: 480px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .input-with-unit {
    position: relative;
    display: flex;
    align-items: center;
  }

  .input-with-unit input {
    width: 100%;
    padding: var(--space-3);
    padding-right: 60px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .input-with-unit input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
    box-shadow: 0 0 0 3px rgba(100, 210, 255, 0.15);
  }

  .input-with-unit .unit {
    position: absolute;
    right: var(--space-3);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .calculated-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
  }

  .calc-label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
  }

  .calc-value {
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    color: var(--text-primary);
  }

  .submit-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .submit-btn.buy {
    background: linear-gradient(135deg, #30d158, #34c759);
    color: white;
  }

  .submit-btn.sell {
    background: linear-gradient(135deg, #ff375f, #ff453a);
    color: white;
  }

  .submit-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .alert-panel {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
  }

  .alert-type-row {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .alert-type-label {
    flex: 1;
    cursor: pointer;
  }

  .alert-type-label input {
    display: none;
  }

  .alert-type-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: var(--bg-secondary);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .alert-type-btn.buy:hover,
  .alert-type-label input:checked + .alert-type-btn.buy {
    border-color: #30d158;
    background: rgba(48, 209, 88, 0.1);
    color: #30d158;
  }

  .alert-type-btn.sell:hover,
  .alert-type-label input:checked + .alert-type-btn.sell {
    border-color: #ff375f;
    background: rgba(255, 55, 95, 0.1);
    color: #ff375f;
  }

  .submit-btn.alert {
    background: linear-gradient(135deg, #bf5af2 0%, #5e5ce6 100%);
  }

  .submit-btn.alert:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(191, 90, 242, 0.3);
  }

  .alert-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-top: var(--space-4);
    max-height: 200px;
    overflow-y: auto;
  }

  .alert-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
  }

  .alert-item .alert-info {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .alert-item .alert-type {
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
  }

  .alert-item .alert-type.buy {
    background: rgba(48, 209, 88, 0.15);
    color: #30d158;
  }

  .alert-item .alert-type.sell {
    background: rgba(255, 55, 95, 0.15);
    color: #ff375f;
  }

  .alert-item .delete-alert {
    color: var(--text-tertiary);
    transition: color var(--duration-fast) var(--ease-default);
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-1);
  }

  .alert-item .delete-alert:hover {
    color: #ff375f;
  }

  .transactions-section {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    margin-bottom: var(--space-6);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    gap: var(--space-3);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .filter-row {
    display: flex;
    gap: var(--space-2);
  }

  .filter-row select {
    padding: var(--space-2) var(--space-3);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
  }

  .transactions-list {
    overflow-x: auto;
  }

  /* Transaction Records - Modern Table Design */
  .transactions-container {
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-primary);
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .transactions-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: var(--text-sm);
  }

  .transactions-table thead {
    background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
  }

  .transactions-table th {
    padding: var(--space-4) var(--space-4);
    font-weight: var(--font-semibold);
    color: var(--text-secondary);
    white-space: nowrap;
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    border-bottom: 2px solid var(--border-primary);
    text-align: left;
  }

  .transactions-table th:first-child {
    padding-left: var(--space-5);
  }

  .transactions-table th:last-child {
    padding-right: var(--space-5);
    text-align: center;
  }

  .transactions-table td {
    padding: var(--space-4);
    text-align: left;
    border-bottom: 1px solid var(--border-primary);
    vertical-align: middle;
  }

  .transactions-table td:first-child {
    padding-left: var(--space-5);
  }

  .transactions-table td:last-child {
    padding-right: var(--space-5);
    text-align: center;
  }

  .transactions-table tbody tr {
    transition: all var(--duration-fast) var(--ease-default);
    background: var(--bg-primary);
  }

  .transactions-table tbody tr:nth-child(even) {
    background: var(--bg-secondary);
  }

  .transactions-table tbody tr:hover {
    background: var(--bg-tertiary);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .transactions-table tbody tr:last-child td {
    border-bottom: none;
  }

  /* Type Badge */
  .type-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    border: 1px solid transparent;
  }

  .type-badge.buy {
    background: rgba(48, 209, 88, 0.1);
    color: #30d158;
    border-color: rgba(48, 209, 88, 0.2);
  }

  .type-badge.sell {
    background: rgba(255, 55, 95, 0.1);
    color: #ff375f;
    border-color: rgba(255, 55, 95, 0.2);
  }

  .type-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }

  .type-badge.buy::before {
    background: #30d158;
    box-shadow: 0 0 4px #30d158;
  }

  .type-badge.sell::before {
    background: #ff375f;
    box-shadow: 0 0 4px #ff375f;
  }

  /* Price Cell */
  .price-cell {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .price-cell .display-value {
    font-weight: var(--font-semibold);
    font-family: var(--font-number);
    font-size: var(--text-base);
    color: var(--text-primary);
  }

  .price-cell .sell-price {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-family: var(--font-number);
  }

  /* Quantity & Amount */
  .quantity-cell,
  .amount-cell {
    font-family: var(--font-number);
    font-weight: var(--font-medium);
    color: var(--text-primary);
  }

  /* Profit Cell */
  .profit-cell {
    font-family: var(--font-number);
    font-weight: var(--font-bold);
    font-size: var(--text-base);
  }

  .profit-cell.positive {
    color: #30d158;
  }

  .profit-cell.negative {
    color: #ff375f;
  }

  .profit-cell.neutral {
    color: var(--text-tertiary);
  }

  /* Time Cell */
  .time-cell {
    color: var(--text-tertiary);
    white-space: nowrap;
    font-size: var(--text-xs);
    font-family: var(--font-mono);
  }

  /* Actions Cell */
  .actions-cell {
    white-space: nowrap;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    margin-right: var(--space-1);
    background: transparent;
    opacity: 0.7;
  }

  .transactions-table tbody tr:hover .action-btn {
    opacity: 1;
  }

  .action-btn.edit {
    background: rgba(100, 210, 255, 0.1);
    color: #64d2ff;
  }

  .action-btn.edit:hover {
    background: rgba(100, 210, 255, 0.25);
    transform: scale(1.1);
  }

  .action-btn.delete {
    background: rgba(255, 55, 95, 0.1);
    color: #ff375f;
  }

  .action-btn.delete:hover {
    background: rgba(255, 55, 95, 0.25);
    transform: scale(1.1);
  }

  .action-btn.delete:hover {
    background: rgba(255, 55, 95, 0.3);
  }

  .edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }

  .edit-modal-content {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    width: 100%;
    max-width: 400px;
    box-shadow: var(--shadow-xl);
  }

  .edit-modal-content h3 {
    margin: 0 0 var(--space-4);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .edit-modal-content .form-group {
    margin-bottom: var(--space-4);
  }

  .edit-modal-content label {
    display: block;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
  }

  .edit-modal-content input {
    width: 100%;
    padding: var(--space-3);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-base);
  }

  .edit-modal-content input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
  }

  .edit-actions {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-5);
  }

  .edit-actions button {
    flex: 1;
    padding: var(--space-3);
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
  }

  .btn-cancel {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
  }

  .btn-cancel:hover {
    background: var(--border-primary);
  }

  .btn-save {
    background: var(--color-accent-blue);
    color: white;
  }

  .btn-save:hover {
    background: #1a8cff;
  }

  .transaction-item {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .transaction-item:hover {
    background: var(--bg-tertiary);
  }

  .transaction-type {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: var(--radius-lg);
    flex-shrink: 0;
  }

  .transaction-type.buy {
    background: rgba(48, 209, 88, 0.15);
    color: #30d158;
  }

  .transaction-type.sell {
    background: rgba(255, 55, 95, 0.15);
    color: #ff375f;
  }

  .transaction-info {
    flex: 1;
    min-width: 0;
  }

  .transaction-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-1);
  }

  .transaction-title {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-primary);
  }

  .transaction-amount {
    font-size: var(--text-base);
    font-weight: var(--font-bold);
    color: var(--text-primary);
  }

  .transaction-meta {
    display: flex;
    gap: var(--space-4);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .transaction-profit {
    font-weight: var(--font-semibold);
  }

  .transaction-profit.positive {
    color: #30d158;
  }

  .transaction-profit.negative {
    color: #ff375f;
  }

  .transaction-actions {
    display: flex;
    gap: var(--space-2);
  }

  .action-btn {
    padding: var(--space-2);
    color: var(--text-tertiary);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .action-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .action-btn.delete:hover {
    color: #ff375f;
  }

  .pagination {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-4);
  }

  .pagination button {
    padding: var(--space-2) var(--space-3);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .pagination button:hover:not(:disabled) {
    background: var(--bg-secondary);
    border-color: var(--border-hover);
  }

  .pagination button.active {
    background: var(--color-accent-blue);
    border-color: var(--color-accent-blue);
    color: white;
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .charts-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  @media (max-width: 768px) {
    .charts-section {
      grid-template-columns: 1fr;
    }
  }

  .chart-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
  }

  .chart-title {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-4);
  }

  .chart-container {
    height: 200px;
    display: flex;
    align-items: flex-end;
    gap: 4px;
    padding: var(--space-4) 0;
  }

  .chart-bar {
    flex: 1;
    background: linear-gradient(180deg, var(--color-accent-blue), var(--color-accent-purple));
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    min-height: 4px;
    transition: all var(--duration-fast) var(--ease-default);
    position: relative;
  }

  .chart-bar:hover {
    opacity: 0.8;
  }

  .chart-bar.negative {
    background: linear-gradient(180deg, #ff375f, #ff453a);
  }

  .chart-bar::after {
    content: attr(data-value);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    white-space: nowrap;
    opacity: 0;
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .chart-bar:hover::after {
    opacity: 1;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-8);
    color: var(--text-tertiary);
  }

  .empty-state svg {
    margin-bottom: var(--space-4);
    opacity: 0.5;
  }
</style>

<script>
  const API_BASE = 'https://api.ustc.dev';

  const loginSection = document.getElementById('login-section');
  const dashboardSection = document.getElementById('dashboard-section');
  const loginForm = document.getElementById('trading-login-form');
  const buyForm = document.getElementById('buy-form');
  const sellForm = document.getElementById('sell-form');
  const alertForm = document.getElementById('alert-form');

  let authToken = localStorage.getItem('trading_token') || '';
  let currentPage = 1;
  let totalPages = 1;

  function formatCurrency(value) {
    const num = parseFloat(value) || 0;
    return `¥${num.toFixed(2)}`;
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('zh-CN', {
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  async function apiRequest(endpoint, options = {}) {
    try {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
          ...options.headers
        }
      });
      
      if (!response.ok) {
        console.error('API Error:', response.status, response.statusText);
        return { success: false, error: `HTTP Error: ${response.status}` };
      }
      
      const text = await response.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('JSON Parse Error:', text);
        return { success: false, error: 'Invalid JSON response' };
      }
    } catch (error) {
      console.error('API Request Error:', error);
      return { success: false, error: error.message || 'Network error' };
    }
  }

  async function checkAuth() {
    if (!authToken) {
      showLogin();
      return false;
    }

    try {
      const result = await apiRequest('/api/trading/verify');
      if (result.success) {
        showDashboard();
        return true;
      } else {
        localStorage.removeItem('trading_token');
        authToken = '';
        showLogin();
        return false;
      }
    } catch (error) {
      console.error('Auth check failed:', error);
      showLogin();
      return false;
    }
  }

  function showLogin() {
    loginSection?.classList.remove('hidden');
    dashboardSection?.classList.add('hidden');
  }

  function showDashboard() {
    loginSection?.classList.add('hidden');
    dashboardSection?.classList.remove('hidden');
    loadDashboard();
  }

  async function loadDashboard() {
    await Promise.all([
      loadGoldPrice(),
      loadStats(),
      loadTransactions(),
      loadAlerts()
    ]);
  }

  async function loadGoldPrice() {
    try {
      const result = await apiRequest('/api/gold');
      if (result.success && result.data?.domestic?.price) {
        document.getElementById('current-gold-price').textContent = result.data.domestic.price.toFixed(2);
      }
    } catch (error) {
      console.error('Failed to load gold price:', error);
    }
  }

  async function loadStats() {
    try {
      const result = await apiRequest('/api/trading/stats');
      if (result.success) {
        const stats = result.stats;
        document.getElementById('stat-total-profit').textContent = formatCurrency(stats.total.profit);
        document.getElementById('stat-month-profit').textContent = formatCurrency(stats.month.profit);
        document.getElementById('stat-week-profit').textContent = formatCurrency(stats.week.profit);
        
        const holdings = stats.total.quantityBought - stats.total.quantitySold;
        document.getElementById('stat-total-quantity').textContent = `${holdings.toFixed(3)}g`;

        renderCharts(stats);
      }
    } catch (error) {
      console.error('Failed to load stats:', error);
    }
  }

  function renderCharts(stats) {
    const dailyChart = document.getElementById('daily-chart');
    const weeklyChart = document.getElementById('weekly-chart');

    if (dailyChart && stats.daily?.length > 0) {
      const maxProfit = Math.max(...stats.daily.map(d => Math.abs(d.profit || 0)), 1);
      dailyChart.innerHTML = stats.daily.slice(0, 14).reverse().map(d => {
        const height = Math.abs(d.profit || 0) / maxProfit * 150;
        const isNegative = d.profit < 0;
        return `<div class="chart-bar ${isNegative ? 'negative' : ''}" style="height: ${Math.max(height, 4)}px" data-value="${formatCurrency(d.profit)}"></div>`;
      }).join('');
    }

    if (weeklyChart && stats.weekly?.length > 0) {
      const maxProfit = Math.max(...stats.weekly.map(w => Math.abs(w.profit || 0)), 1);
      weeklyChart.innerHTML = stats.weekly.slice(0, 12).reverse().map(w => {
        const height = Math.abs(w.profit || 0) / maxProfit * 150;
        const isNegative = w.profit < 0;
        return `<div class="chart-bar ${isNegative ? 'negative' : ''}" style="height: ${Math.max(height, 4)}px" data-value="${formatCurrency(w.profit)}"></div>`;
      }).join('');
    }
  }

  async function loadTransactions(page = 1) {
    try {
      const type = document.getElementById('filter-type')?.value || '';
      const sort = document.getElementById('filter-sort')?.value || 'desc';
      
      let url = `/api/trading/transactions?page=${page}&limit=10&sortOrder=${sort}`;
      if (type) url += `&type=${type}`;

      const result = await apiRequest(url);
      if (result.success) {
        renderTransactions(result.transactions);
        renderPagination(result.pagination);
      }
    } catch (error) {
      console.error('Failed to load transactions:', error);
    }
  }

  function renderTransactions(transactions) {
    const list = document.getElementById('transactions-list');
    if (!list) return;

    if (!transactions?.length) {
      list.innerHTML = `
        <div class="empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <p>暂无交易记录</p>
        </div>
      `;
      return;
    }

    list.innerHTML = `
      <table class="transactions-table">
        <thead>
          <tr>
            <th>类型</th>
            <th>价格(元/克)</th>
            <th>数量</th>
            <th>总额</th>
            <th>收益</th>
            <th>交易时间</th>
            <th style="text-align: center;">操作</th>
          </tr>
        </thead>
        <tbody>
          ${transactions.map(t => {
            const isBuy = t.type === 'buy';
            const profitValue = parseFloat(t.profit) || 0;
            const profitClass = profitValue > 0 ? 'positive' : profitValue < 0 ? 'negative' : 'neutral';
            const profitDisplay = isBuy ? '-' : formatCurrency(t.profit);
            
            return `
              <tr class="transaction-row" data-id="${t.id}">
                <td>
                  <span class="type-badge ${t.type}">
                    ${isBuy ? '买入' : '卖出'}
                  </span>
                </td>
                <td class="price-cell">
                  <span class="display-value">¥${t.price.toFixed(2)}</span>
                  ${!isBuy ? `<span class="sell-price">卖出 ¥${(t.actual_sell_price || t.price).toFixed(2)}</span>` : ''}
                </td>
                <td class="quantity-cell">${t.quantity.toFixed(3)} g</td>
                <td class="amount-cell">${formatCurrency(t.total_amount)}</td>
                <td class="profit-cell ${profitClass}">${profitDisplay}</td>
                <td class="time-cell">${formatDate(t.created_at)}</td>
                <td class="actions-cell">
                  <button class="action-btn edit" onclick="editTransaction(${t.id})" title="编辑">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  <button class="action-btn delete" onclick="deleteTransaction(${t.id})" title="删除">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }

  function renderPagination(pagination) {
    const container = document.getElementById('pagination');
    if (!container) return;

    currentPage = pagination.page;
    totalPages = pagination.totalPages;

    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = '';
    
    html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="loadTransactions(${currentPage - 1})">上一页</button>`;
    
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
        html += `<button class="${i === currentPage ? 'active' : ''}" onclick="loadTransactions(${i})">${i}</button>`;
      } else if (i === currentPage - 2 || i === currentPage + 2) {
        html += '<span>...</span>';
      }
    }

    html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="loadTransactions(${currentPage + 1})">下一页</button>`;

    container.innerHTML = html;
  }

  async function loadAlerts() {
    try {
      const result = await apiRequest('/api/trading/alerts');
      if (result.success) {
        renderAlerts(result.alerts);
      }
    } catch (error) {
      console.error('Failed to load alerts:', error);
    }
  }

  function renderAlerts(alerts) {
    const list = document.getElementById('alert-list');
    if (!list) return;

    if (!alerts?.length) {
      list.innerHTML = '';
      return;
    }

    list.innerHTML = alerts.map(a => `
      <div class="alert-item" data-id="${a.id}">
        <div class="alert-info">
          <span class="alert-type ${a.alert_type}">${a.alert_type === 'buy' ? '买' : '卖'}</span>
          <span>¥${a.target_price}/g</span>
        </div>
        <button class="delete-alert" onclick="deleteAlert(${a.id})">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    `).join('');
  }

  async function deleteTransaction(id) {
    if (!confirm('确定删除此交易记录？')) return;

    try {
      const result = await apiRequest(`/api/trading/transaction?id=${id}`, { method: 'DELETE' });
      if (result.success) {
        loadDashboard();
      } else {
        alert(result.error || '删除失败');
      }
    } catch (error) {
      console.error('Delete failed:', error);
      alert('删除失败');
    }
  }

  async function editTransaction(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) return;

    const cells = row.querySelectorAll('td');
    const typeCell = cells[0];
    const priceCell = cells[1];
    const qtyCell = cells[2];
    const type = typeCell.querySelector('.type-badge').classList.contains('buy') ? 'buy' : 'sell';
    const currentPrice = parseFloat(priceCell.querySelector('.display-value').textContent.replace('¥', ''));
    const currentQty = parseFloat(qtyCell.textContent.replace('g', ''));
    const currentSellPrice = type === 'sell' ? parseFloat(priceCell.querySelector('.sell-price')?.textContent.match(/¥([\d.]+)/)?.[1] || currentPrice) : null;

    const modal = document.createElement('div');
    modal.className = 'edit-modal';
    modal.innerHTML = `
      <div class="edit-modal-content">
        <h3>编辑交易记录</h3>
        <form id="edit-form">
          <div class="form-group">
            <label>买入价格 (元/克)</label>
            <input type="number" id="edit-price" step="0.01" value="${currentPrice}" required />
          </div>
          ${type === 'sell' ? `
            <div class="form-group">
              <label>卖出价格 (元/克)</label>
              <input type="number" id="edit-sell-price" step="0.01" value="${currentSellPrice || currentPrice}" required />
            </div>
          ` : ''}
          <div class="form-group">
            <label>数量 (克)</label>
            <input type="number" id="edit-quantity" step="0.001" value="${currentQty}" required />
          </div>
          <div class="edit-actions">
            <button type="button" class="btn-cancel">取消</button>
            <button type="submit" class="btn-save">保存</button>
          </div>
        </form>
      </div>
    `;

    document.body.appendChild(modal);

    modal.querySelector('.btn-cancel').addEventListener('click', () => modal.remove());
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });

    modal.querySelector('#edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPrice = parseFloat((document.getElementById('edit-price') as HTMLInputElement).value);
      const newQty = parseFloat((document.getElementById('edit-quantity') as HTMLInputElement).value);
      const newSellPrice = type === 'sell' ? parseFloat((document.getElementById('edit-sell-price') as HTMLInputElement).value) : null;

      try {
        const result = await apiRequest(`/api/trading/transaction?id=${id}`, {
          method: 'PUT',
          body: JSON.stringify({
            price: newPrice,
            quantity: newQty,
            actualSellPrice: newSellPrice
          })
        });

        if (result.success) {
          modal.remove();
          loadDashboard();
        } else {
          alert(result.error || '更新失败');
        }
      } catch (error) {
        console.error('Update failed:', error);
        alert('更新失败');
      }
    });
  }

  async function deleteAlert(id) {
    try {
      const result = await apiRequest(`/api/trading/alert?id=${id}`, { method: 'DELETE' });
      if (result.success) {
        loadAlerts();
      }
    } catch (error) {
      console.error('Delete alert failed:', error);
    }
  }

  document.getElementById('trading-toggle-pwd')?.addEventListener('click', () => {
    const input = document.getElementById('trading-password') as HTMLInputElement;
    const btn = document.getElementById('trading-toggle-pwd');
    const eyeOpen = btn?.querySelector('.eye-open');
    const eyeClosed = btn?.querySelector('.eye-closed');

    if (input?.type === 'password') {
      input.type = 'text';
      eyeOpen?.classList.add('hidden');
      eyeClosed?.classList.remove('hidden');
    } else {
      input.type = 'password';
      eyeOpen?.classList.remove('hidden');
      eyeClosed?.classList.add('hidden');
    }
  });

  loginForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('trading-login-btn');
    const btnText = btn?.querySelector('.btn-text');
    const btnLoading = btn?.querySelector('.btn-loading');

    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    (btn as HTMLButtonElement).disabled = true;

    try {
      const formData = new FormData(loginForm as HTMLFormElement);
      const username = formData.get('username') as string;
      const password = formData.get('password') as string;
      
      console.log('Attempting login with username:', username);
      
      const result = await apiRequest('/api/trading/login', {
        method: 'POST',
        body: JSON.stringify({ username, password })
      });

      console.log('Login result:', result);

      if (result.success) {
        authToken = result.token;
        localStorage.setItem('trading_token', authToken);
        console.log('Login successful, showing dashboard');
        showDashboard();
      } else {
        console.error('Login failed:', result.error);
        alert(result.error || '登录失败');
      }
    } catch (error) {
      console.error('Login failed:', error);
      alert('登录失败');
    } finally {
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  function updateBuyTotal() {
    const price = parseFloat((document.getElementById('buy-price') as HTMLInputElement)?.value) || 0;
    const quantity = parseFloat((document.getElementById('buy-quantity') as HTMLInputElement)?.value) || 0;
    const total = price * quantity;
    (document.getElementById('buy-total') as HTMLElement).textContent = formatCurrency(total);
  }

  function updateSellTotal() {
    const price = parseFloat((document.getElementById('sell-price') as HTMLInputElement)?.value) || 0;
    const quantity = parseFloat((document.getElementById('sell-quantity') as HTMLInputElement)?.value) || 0;
    const total = price * quantity;
    (document.getElementById('sell-total') as HTMLElement).textContent = formatCurrency(total);
  }

  document.getElementById('buy-price')?.addEventListener('input', updateBuyTotal);
  document.getElementById('buy-quantity')?.addEventListener('input', updateBuyTotal);
  document.getElementById('sell-price')?.addEventListener('input', updateSellTotal);
  document.getElementById('sell-quantity')?.addEventListener('input', updateSellTotal);

  buyForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const price = parseFloat((document.getElementById('buy-price') as HTMLInputElement)?.value);
    const quantity = parseFloat((document.getElementById('buy-quantity') as HTMLInputElement)?.value);
    const notes = (document.getElementById('buy-notes') as HTMLInputElement)?.value;

    try {
      const result = await apiRequest('/api/trading/buy', {
        method: 'POST',
        body: JSON.stringify({ price, quantity, notes })
      });

      if (result.success) {
        (buyForm as HTMLFormElement).reset();
        (document.getElementById('buy-total') as HTMLElement).textContent = '¥0.00';
        loadDashboard();
        alert('买入记录已保存');
      } else {
        alert(result.error || '保存失败');
      }
    } catch (error) {
      console.error('Buy failed:', error);
      alert('保存失败');
    }
  });

  sellForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const price = parseFloat((document.getElementById('sell-price') as HTMLInputElement)?.value);
    const quantity = parseFloat((document.getElementById('sell-quantity') as HTMLInputElement)?.value);
    const notes = (document.getElementById('sell-notes') as HTMLInputElement)?.value;

    try {
      const result = await apiRequest('/api/trading/sell', {
        method: 'POST',
        body: JSON.stringify({ actualSellPrice: price, quantity, notes })
      });

      if (result.success) {
        (sellForm as HTMLFormElement).reset();
        (document.getElementById('sell-total') as HTMLElement).textContent = '¥0.00';
        loadDashboard();
        alert('卖出记录已保存');
      } else {
        alert(result.error || '保存失败');
      }
    } catch (error) {
      console.error('Sell failed:', error);
      alert('保存失败');
    }
  });

  alertForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const alertType = (document.querySelector('input[name="alert-type"]:checked') as HTMLInputElement)?.value || 'buy';
    const targetPrice = parseFloat((document.getElementById('alert-price') as HTMLInputElement)?.value);

    if (!targetPrice) {
      alert('请输入目标价格');
      return;
    }

    try {
      const result = await apiRequest('/api/trading/alert', {
        method: 'POST',
        body: JSON.stringify({ alertType, targetPrice })
      });

      if (result.success) {
        (document.getElementById('alert-price') as HTMLInputElement).value = '';
        loadAlerts();
        alert('预警已设置');
      } else {
        alert(result.error || '设置失败');
      }
    } catch (error) {
      console.error('Alert creation failed:', error);
      alert('设置失败');
    }
  });

  document.getElementById('logout-btn')?.addEventListener('click', () => {
    localStorage.removeItem('trading_token');
    authToken = '';
    showLogin();
  });

  document.getElementById('filter-type')?.addEventListener('change', () => loadTransactions(1));
  document.getElementById('filter-sort')?.addEventListener('change', () => loadTransactions(1));

  (window as any).loadTransactions = loadTransactions;
  (window as any).deleteTransaction = deleteTransaction;
  (window as any).editTransaction = editTransaction;
  (window as any).deleteAlert = deleteAlert;

  checkAuth();
</script>
