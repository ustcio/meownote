---
import Layout from '@layouts/Layout.astro';

const API_BASE = 'https://api.ustc.dev';
const JWT_SECRET = import.meta.env.JWT_SECRET;

let isAuthenticated = false;
let authUser = null;

const cookieHeader = Astro.request.headers.get('Cookie') || '';
const cookies = cookieHeader.split(';').map(c => c.trim());
const tokenCookie = cookies.find(c => c.startsWith('trading_token='));

if (tokenCookie && JWT_SECRET) {
  const token = tokenCookie.substring('trading_token='.length);
  
  try {
    const parts = token.split('.');
    if (parts.length === 3) {
      const [header, body, sig] = parts;
      const payload = JSON.parse(atob(body));
      
      if (payload.exp && payload.exp > Date.now()) {
        const key = await crypto.subtle.importKey(
          'raw',
          new TextEncoder().encode(JWT_SECRET),
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['verify']
        );
        
        const signatureBuffer = Uint8Array.from(atob(sig), c => c.charCodeAt(0));
        const isValid = await crypto.subtle.verify(
          'HMAC',
          key,
          signatureBuffer,
          new TextEncoder().encode(`${header}.${body}`)
        );
        
        if (isValid) {
          isAuthenticated = true;
          authUser = payload;
        }
      }
    }
  } catch (e) {
    isAuthenticated = false;
  }
}
---

<Layout 
  title="ÈªÑÈáë‰∫§ÊòìÁÆ°ÁêÜ - Meow Note"
  description="ÈªÑÈáë‰∫§ÊòìÁÆ°ÁêÜ‰∏éÊî∂ÁõäÂàÜÊûê"
>
  <section class="trading" id="trading-app">
    {!isAuthenticated && (
    <div class="trading-login" id="login-section">
      <div class="login-card">
        <div class="login-icon">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
            <circle cx="32" cy="32" r="28" stroke="url(#lockGradient)" stroke-width="3" fill="none"/>
            <rect x="20" y="28" width="24" height="20" rx="3" fill="url(#lockGradient)"/>
            <path d="M24 28V24C24 19.5817 27.5817 16 32 16C36.4183 16 40 19.5817 40 24V28" stroke="url(#lockGradient)" stroke-width="3" fill="none"/>
            <circle cx="32" cy="38" r="3" fill="white"/>
            <rect x="31" y="40" width="2" height="5" fill="white"/>
            <defs>
              <linearGradient id="lockGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#64d2ff"/>
                <stop offset="100%" style="stop-color:#bf5af2"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <h1 class="login-title">Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò</h1>
        <p class="login-subtitle">ÁôªÂΩï‰ª•ËÆøÈóÆ‰∫§ÊòìÁÆ°ÁêÜÁ≥ªÁªü</p>
        
        <form class="login-form" id="trading-login-form">
          <div class="form-group">
            <label for="trading-username">Áî®Êà∑Âêç</label>
            <div class="input-wrapper password-wrapper">
              <input type="text" id="trading-username" name="username" required placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" />
            </div>
          </div>
          <div class="form-group">
            <label for="trading-password">ÂØÜÁ†Å</label>
            <div class="input-wrapper password-wrapper">
              <input type="password" id="trading-password" name="password" required placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" />
              <button type="button" class="toggle-password" id="trading-toggle-pwd" aria-label="ÂàáÊç¢ÂØÜÁ†ÅÂèØËßÅÊÄß">
                <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-closed hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="login-btn" id="trading-login-btn">
            <span class="btn-text">ÁôªÂΩï</span>
            <span class="btn-loading hidden">
              <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
              </svg>
            </span>
          </button>
        </form>
      </div>
    </div>
    )}

    {isAuthenticated && (
    <div class="trading-dashboard" id="dashboard-section">
      <div class="dashboard-header">
        <div class="header-left">
          <h1 class="dashboard-title">ÈªÑÈáë‰∫§ÊòìÁÆ°ÁêÜ</h1>
          <p class="dashboard-subtitle">ÂÆûÊó∂ÁõëÊéßÈáë‰ª∑ÔºåÊô∫ËÉΩÁÆ°ÁêÜ‰∫§Êòì</p>
        </div>
        <div class="header-right">
          <div class="current-price-card">
            <span class="price-label">ÂΩìÂâçÈáë‰ª∑</span>
            <span class="price-value" id="current-gold-price">--</span>
            <span class="price-unit">ÂÖÉ/ÂÖã</span>
          </div>
          <button class="logout-btn" id="logout-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>ÈÄÄÂá∫</span>
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card profit">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-total-profit">¬•0.00</span>
            <span class="stat-label">Á¥ØËÆ°Êî∂Áõä</span>
          </div>
        </div>
        <div class="stat-card month">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-month-profit">¬•0.00</span>
            <span class="stat-label">Êú¨ÊúàÊî∂Áõä</span>
          </div>
        </div>
        <div class="stat-card week">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-week-profit">¬•0.00</span>
            <span class="stat-label">Êú¨Âë®Êî∂Áõä</span>
          </div>
        </div>
        <div class="stat-card quantity">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-total-quantity">0g</span>
            <span class="stat-label">ÊåÅ‰ªìÂÖãÊï∞</span>
          </div>
        </div>
      </div>

      <div class="main-grid">
        <div class="panel buy-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              ‰π∞ÂÖ•ËÆæÁΩÆ
            </h2>
          </div>
          <form class="panel-form" id="buy-form">
            <div class="form-row">
              <div class="form-group">
                <label>‰π∞ÂÖ•Èáë‰ª∑</label>
                <div class="input-with-unit">
                  <input type="number" id="buy-price" step="0.01" min="0" placeholder="0.00" required />
                  <span class="unit">ÂÖÉ/ÂÖã</span>
                </div>
              </div>
              <div class="form-group">
                <label>‰π∞ÂÖ•ÂÖãÊï∞</label>
                <div class="input-with-unit">
                  <input type="number" id="buy-quantity" step="0.001" min="0.001" placeholder="0.000" required />
                  <span class="unit">g</span>
                </div>
              </div>
            </div>
            <div class="calculated-row">
              <span class="calc-label">‰π∞ÂÖ•ÊÄªÈ¢ù</span>
              <span class="calc-value" id="buy-total">¬•0.00</span>
            </div>
            <div class="form-group">
              <label>Â§áÊ≥®</label>
              <input type="text" id="buy-notes" placeholder="ÂèØÈÄâÂ§áÊ≥®" />
            </div>
            <button type="submit" class="submit-btn buy">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Á°ÆËÆ§‰π∞ÂÖ•
            </button>
          </form>
        </div>

        <div class="panel sell-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              ÂçñÂá∫ËÆæÁΩÆ
            </h2>
          </div>
          <form class="panel-form" id="sell-form">
            <div class="form-row">
              <div class="form-group">
                <label>ÂçñÂá∫‰ª∑Ê†º</label>
                <div class="input-with-unit">
                  <input type="number" id="sell-price" step="0.01" min="0" placeholder="0.00" required />
                  <span class="unit">ÂÖÉ/ÂÖã</span>
                </div>
              </div>
              <div class="form-group">
                <label>ÂçñÂá∫ÂÖãÊï∞</label>
                <div class="input-with-unit">
                  <input type="number" id="sell-quantity" step="0.001" min="0.001" placeholder="0.000" required />
                  <span class="unit">g</span>
                </div>
              </div>
            </div>
            <div class="calculated-row">
              <span class="calc-label">ÂçñÂá∫ÊÄªÈ¢ù</span>
              <span class="calc-value" id="sell-total">¬•0.00</span>
            </div>
            <div class="form-group">
              <label>Â§áÊ≥®</label>
              <input type="text" id="sell-notes" placeholder="ÂèØÈÄâÂ§áÊ≥®" />
            </div>
            <button type="submit" class="submit-btn sell">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Á°ÆËÆ§ÂçñÂá∫
            </button>
          </form>
        </div>

        <div class="panel alert-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              ‰ª∑Ê†ºÈ¢ÑË≠¶
            </h2>
          </div>

          <div class="tolerance-settings" id="tolerance-settings">
            <div class="tolerance-header">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              <span>ÂÆπÈîôÈòàÂÄºËÆæÁΩÆ</span>
              <span class="tolerance-status" id="tolerance-status">Âä†ËΩΩ‰∏≠...</span>
            </div>
            <form class="tolerance-form" id="tolerance-form">
              <div class="tolerance-row">
                <div class="tolerance-input-group">
                  <label class="tolerance-label">
                    <span class="tolerance-icon buy">üü¢</span>
                    ‰π∞ÂÖ•ÂÆπÈîô
                  </label>
                  <div class="input-with-unit">
                    <input type="number" id="buy-tolerance" step="0.1" min="0.1" max="100" value="2.0" required />
                    <span class="unit">ÂÖÉ</span>
                  </div>
                  <span class="tolerance-hint">ÂΩì‰ª∑Ê†ºËøõÂÖ•ÁõÆÊ†á¬±Ê≠§ËåÉÂõ¥ÂÜÖÊó∂Êé®ÈÄÅ</span>
                </div>
                <div class="tolerance-input-group">
                  <label class="tolerance-label">
                    <span class="tolerance-icon sell">üî¥</span>
                    ÂçñÂá∫ÂÆπÈîô
                  </label>
                  <div class="input-with-unit">
                    <input type="number" id="sell-tolerance" step="0.1" min="0.1" max="100" value="2.0" required />
                    <span class="unit">ÂÖÉ</span>
                  </div>
                  <span class="tolerance-hint">ÂΩì‰ª∑Ê†ºËøõÂÖ•ÁõÆÊ†á¬±Ê≠§ËåÉÂõ¥ÂÜÖÊó∂Êé®ÈÄÅ</span>
                </div>
              </div>
              <button type="submit" class="tolerance-save-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                ‰øùÂ≠òËÆæÁΩÆ
              </button>
            </form>
          </div>

          <form class="panel-form" id="alert-form">
            <div class="alert-type-row">
              <label class="alert-type-label">
                <input type="radio" name="alert-type" value="buy" checked />
                <span class="alert-type-btn buy">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  ‰π∞ÂÖ•ÊèêÈÜí
                </span>
              </label>
              <label class="alert-type-label">
                <input type="radio" name="alert-type" value="sell" />
                <span class="alert-type-btn sell">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  ÂçñÂá∫ÊèêÈÜí
                </span>
              </label>
            </div>
            <div class="form-group">
              <label>ÁõÆÊ†á‰ª∑Ê†º</label>
              <div class="input-with-unit">
                <input type="number" id="alert-price" step="0.01" min="0" placeholder="0.00" required />
                <span class="unit">ÂÖÉ/ÂÖã</span>
              </div>
            </div>
            <button type="submit" class="submit-btn alert">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              Ê∑ªÂä†È¢ÑË≠¶
            </button>
          </form>
          <div class="alert-list" id="alert-list"></div>
        </div>
      </div>

      <div class="transactions-section" id="transactions-section">
        <div class="section-header">
          <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            ‰∫§ÊòìËÆ∞ÂΩï
          </h2>
          <div class="filter-row">
            <select id="filter-type">
              <option value="">ÂÖ®ÈÉ®Á±ªÂûã</option>
              <option value="buy">‰π∞ÂÖ•</option>
              <option value="sell">ÂçñÂá∫</option>
            </select>
            <select id="filter-sort">
              <option value="desc">ÊúÄÊñ∞‰ºòÂÖà</option>
              <option value="asc">ÊúÄÊó©‰ºòÂÖà</option>
            </select>
          </div>
        </div>
        <div class="transactions-cards-container" id="transactions-list"></div>
        <div class="pagination" id="pagination"></div>
      </div>

      <div class="charts-section">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">ÊØèÂë®Êî∂Áõä</h3>
            <div class="chart-legend">
              <span class="legend-item"><span class="legend-dot buy"></span>‰π∞ÂÖ•</span>
              <span class="legend-item"><span class="legend-dot sell"></span>ÂçñÂá∫</span>
            </div>
          </div>
          <div class="chart-container" id="weekly-chart"></div>
          <div class="chart-tooltip" id="weekly-tooltip"></div>
          <div class="chart-loading" id="weekly-loading">
            <div class="loading-spinner"></div>
            <span>Âä†ËΩΩ‰∏≠...</span>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">ÊúàÂ∫¶Êî∂Áõä</h3>
            <span class="chart-subtitle">ÊúÄËøë4Âë®ÂÆåÊï¥Êï∞ÊçÆ</span>
          </div>
          <div class="chart-container" id="monthly-chart"></div>
          <div class="chart-tooltip" id="monthly-tooltip"></div>
          <div class="chart-loading" id="monthly-loading">
            <div class="loading-spinner"></div>
            <span>Âä†ËΩΩ‰∏≠...</span>
          </div>
        </div>
      </div>
    </div>
    )}
  </section>
</Layout>

<style>
  .trading {
    min-height: 100vh;
    padding: calc(var(--header-total-height) + var(--space-4)) var(--space-4) var(--space-12);
  }

  .hidden {
    display: none !important;
  }

  .trading-login {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - var(--header-total-height) - var(--space-16));
  }

  .login-card {
    width: 100%;
    max-width: 400px;
    padding: var(--space-8);
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    text-align: center;
  }

  .login-icon {
    margin-bottom: var(--space-6);
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .login-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .login-subtitle {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    margin-bottom: var(--space-6);
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    text-align: left;
  }

  .form-group label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
  }

  .input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .input-wrapper.password-wrapper input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    padding-right: 44px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .input-wrapper input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
    box-shadow: 0 0 0 3px rgba(100, 210, 255, 0.15);
    background: var(--bg-primary);
  }

  .toggle-password {
    position: absolute;
    right: var(--space-2);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-tertiary);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .toggle-password:hover {
    color: var(--text-secondary);
    background: var(--bg-secondary);
  }

  .toggle-password .hidden {
    display: none;
  }

  .login-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    margin-top: var(--space-2);
    background: linear-gradient(135deg, var(--color-accent-blue), var(--color-accent-purple));
    color: white;
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .login-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(100, 210, 255, 0.3);
  }

  .login-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
  }

  .dashboard-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
  }

  .dashboard-subtitle {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .current-price-card {
    display: flex;
    flex-direction: column;
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: var(--radius-xl);
    text-align: center;
  }

  .price-label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .price-value {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: #ffd700;
  }

  .price-unit {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .logout-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    color: var(--text-secondary);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .logout-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  @media (max-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
    .dashboard-header {
      flex-direction: column;
    }
    .header-right {
      width: 100%;
      justify-content: space-between;
    }
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .stat-card .stat-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: var(--radius-xl);
    flex-shrink: 0;
  }

  .stat-card.profit .stat-icon {
    background: rgba(48, 209, 88, 0.15);
    color: #30d158;
  }

  .stat-card.month .stat-icon {
    background: rgba(100, 210, 255, 0.15);
    color: #64d2ff;
  }

  .stat-card.week .stat-icon {
    background: rgba(191, 90, 242, 0.15);
    color: #bf5af2;
  }

  .stat-card.quantity .stat-icon {
    background: rgba(255, 159, 10, 0.15);
    color: #ff9f0a;
  }

  .stat-card .stat-content {
    display: flex;
    flex-direction: column;
  }

  .stat-card .stat-value {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
  }

  .stat-card .stat-label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .main-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  @media (max-width: 1024px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
  }

  .panel {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
  }

  .panel-header {
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--border-primary);
  }

  .panel-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .panel-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
  }

  @media (max-width: 480px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .input-with-unit {
    position: relative;
    display: flex;
    align-items: center;
  }

  .input-with-unit input {
    width: 100%;
    padding: var(--space-3);
    padding-right: 60px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .input-with-unit input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
    box-shadow: 0 0 0 3px rgba(100, 210, 255, 0.15);
  }

  .input-with-unit .unit {
    position: absolute;
    right: var(--space-3);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .calculated-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
  }

  .calc-label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
  }

  .calc-value {
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    color: var(--text-primary);
  }

  .submit-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .submit-btn.buy {
    background: linear-gradient(135deg, #30d158, #34c759);
    color: white;
  }

  .submit-btn.sell {
    background: linear-gradient(135deg, #ff375f, #ff453a);
    color: white;
  }

  .submit-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .alert-panel {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
  }

  .tolerance-settings {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
    border: 2px solid var(--accent-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-4);
    box-shadow: 0 2px 8px rgba(100, 210, 255, 0.1);
  }

  .tolerance-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .tolerance-header svg {
    color: var(--accent-primary);
  }

  .tolerance-status {
    margin-left: auto;
    font-size: var(--text-xs);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-weight: var(--font-medium);
  }

  .tolerance-status.saved {
    background: rgba(48, 209, 88, 0.1);
    color: #30d158;
  }

  .tolerance-status.unsaved {
    background: rgba(255, 149, 0, 0.1);
    color: #ff9500;
  }

  .tolerance-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .tolerance-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
  }

  .tolerance-input-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .tolerance-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
  }

  .tolerance-icon {
    font-size: var(--text-base);
  }

  .tolerance-input-group .input-with-unit {
    display: flex;
    align-items: center;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--duration-fast) var(--ease-default);
  }

  .tolerance-input-group .input-with-unit:focus-within {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(100, 210, 255, 0.1);
  }

  .tolerance-input-group input {
    flex: 1;
    padding: var(--space-2) var(--space-3);
    border: none;
    background: transparent;
    font-size: var(--text-base);
    font-family: var(--font-number);
    color: var(--text-primary);
    outline: none;
  }

  .tolerance-input-group .unit {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    border-left: 1px solid var(--border-primary);
    background: var(--bg-secondary);
  }

  .tolerance-hint {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .tolerance-save-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--accent-primary);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    align-self: flex-start;
  }

  .tolerance-save-btn:hover {
    background: var(--accent-secondary);
    transform: translateY(-1px);
  }

  .tolerance-save-btn:active {
    transform: translateY(0);
  }

  .tolerance-save-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .alert-type-row {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .alert-type-label {
    flex: 1;
    cursor: pointer;
  }

  .alert-type-label input {
    display: none;
  }

  .alert-type-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: var(--bg-secondary);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .alert-type-btn.buy:hover,
  .alert-type-label input:checked + .alert-type-btn.buy {
    border-color: #30d158;
    background: rgba(48, 209, 88, 0.1);
    color: #30d158;
  }

  .alert-type-btn.sell:hover,
  .alert-type-label input:checked + .alert-type-btn.sell {
    border-color: #ff375f;
    background: rgba(255, 55, 95, 0.1);
    color: #ff375f;
  }

  .submit-btn.alert {
    background: linear-gradient(135deg, #bf5af2 0%, #5e5ce6 100%);
  }

  .submit-btn.alert:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(191, 90, 242, 0.3);
  }

  .alert-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-top: var(--space-4);
    max-height: 400px;
    overflow-y: auto;
  }

  .alert-empty {
    text-align: center;
    padding: var(--space-6);
    color: var(--text-tertiary);
    font-size: var(--text-sm);
  }

  .alert-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .alert-section.triggered {
    border-color: rgba(100, 210, 255, 0.3);
    background: rgba(100, 210, 255, 0.05);
  }

  .alert-section-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-primary);
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
  }

  .alert-section-icon {
    font-size: var(--text-base);
  }

  .alert-section-title {
    color: var(--text-primary);
  }

  .alert-section-content {
    padding: var(--space-2);
  }

  .alert-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3);
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-2);
    transition: all var(--duration-fast) var(--ease-default);
    border: 1px solid transparent;
  }

  .alert-item:last-child {
    margin-bottom: 0;
  }

  .alert-item:hover {
    border-color: var(--border-primary);
    transform: translateX(4px);
  }

  .alert-item.triggered {
    background: rgba(100, 210, 255, 0.1);
    border-color: rgba(100, 210, 255, 0.2);
  }

  .alert-item.inactive {
    opacity: 0.6;
  }

  .alert-main {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .alert-type-badge {
    padding: 4px 10px;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    border: 1px solid transparent;
  }

  .alert-type-badge.buy {
    background: rgba(48, 209, 88, 0.1);
    color: #30d158;
    border-color: rgba(48, 209, 88, 0.2);
  }

  .alert-type-badge.sell {
    background: rgba(255, 55, 95, 0.1);
    color: #ff375f;
    border-color: rgba(255, 55, 95, 0.2);
  }

  .alert-price {
    display: flex;
    align-items: baseline;
    gap: 2px;
  }

  .alert-price-value {
    font-family: var(--font-number);
    font-weight: var(--font-bold);
    font-size: var(--text-base);
    color: var(--text-primary);
  }

  .alert-price-unit {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .alert-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
  }

  .alert-status {
    font-size: var(--text-xs);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-weight: var(--font-medium);
  }

  .alert-status.active {
    background: rgba(48, 209, 88, 0.1);
    color: #30d158;
  }

  .alert-status.triggered {
    background: rgba(100, 210, 255, 0.1);
    color: #64d2ff;
  }

  .alert-status.inactive {
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
  }

  .alert-time {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-family: var(--font-mono);
  }

  .delete-alert-btn {
    color: var(--text-tertiary);
    transition: all var(--duration-fast) var(--ease-default);
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-md);
    margin-left: var(--space-2);
  }

  .delete-alert-btn:hover {
    color: #ff375f;
    background: rgba(255, 55, 95, 0.1);
  }

  .alert-actions {
    display: flex;
    justify-content: center;
    padding: var(--space-3);
    border-top: 1px solid var(--border-primary);
    margin-top: var(--space-2);
  }

  .alert-action-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    border: 1px solid transparent;
  }

  .alert-action-btn.delete-all {
    color: #ff375f;
    background: rgba(255, 55, 95, 0.1);
    border-color: rgba(255, 55, 95, 0.2);
  }

  .alert-action-btn.delete-all:hover {
    background: rgba(255, 55, 95, 0.2);
  }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateX(120%);
    transition: transform 0.3s ease;
    z-index: 9999;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification.success {
    background: rgba(48, 209, 88, 0.95);
    color: white;
  }

  .notification.error {
    background: rgba(255, 55, 95, 0.95);
    color: white;
  }

  .notification.info {
    background: rgba(100, 210, 255, 0.95);
    color: white;
  }

  .notification-icon {
    font-weight: var(--font-bold);
  }

  .transactions-section {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    margin-bottom: var(--space-6);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    gap: var(--space-3);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    padding-bottom: var(--space-3);
    border-bottom: 2px solid var(--color-primary);
  }

  .section-title svg {
    color: var(--color-primary);
  }

  .filter-row {
    display: flex;
    gap: var(--space-3);
  }

  .filter-row select {
    padding: var(--space-2) var(--space-4);
    background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .filter-row select:hover {
    border-color: var(--color-primary);
    box-shadow: 0 2px 8px rgba(0, 113, 227, 0.15);
  }

  .filter-row select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
  }

  .transactions-cards-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .tx-skeleton {
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    border: 1px solid var(--border-primary);
    animation: skeleton-pulse 1.5s ease-in-out infinite;
  }

  .tx-skeleton-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
  }

  .tx-skeleton-badge {
    width: 60px;
    height: 24px;
    background: var(--border-primary);
    border-radius: var(--radius-full);
  }

  .tx-skeleton-status {
    width: 48px;
    height: 20px;
    background: var(--border-primary);
    border-radius: var(--radius-full);
  }

  .tx-skeleton-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3);
  }

  .tx-skeleton-item {
    height: 40px;
    background: var(--border-primary);
    border-radius: var(--radius-md);
  }

  @keyframes skeleton-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .tx-card {
    position: relative;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    transition: all var(--duration-normal) var(--ease-default);
    overflow: hidden;
  }

  .tx-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-accent-blue), var(--color-accent-purple));
    opacity: 0;
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .tx-card:hover {
    border-color: var(--border-hover);
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }

  .tx-card:hover::before {
    opacity: 1;
  }

  .tx-card.buy::before {
    background: linear-gradient(90deg, #30d158, #34c759);
  }

  .tx-card.sell::before {
    background: linear-gradient(90deg, #ff375f, #ff453a);
  }

  .tx-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-4);
  }

  .tx-card-left {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .tx-sequence {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-full);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    color: var(--text-tertiary);
    letter-spacing: 0.02em;
  }

  .tx-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border: 1px solid transparent;
  }

  .tx-type-badge.buy {
    background: linear-gradient(135deg, rgba(48, 209, 88, 0.15) 0%, rgba(48, 209, 88, 0.05) 100%);
    color: #30d158;
    border-color: rgba(48, 209, 88, 0.3);
  }

  .tx-type-badge.sell {
    background: linear-gradient(135deg, rgba(255, 55, 95, 0.15) 0%, rgba(255, 55, 95, 0.05) 100%);
    color: #ff375f;
    border-color: rgba(255, 55, 95, 0.3);
  }

  .tx-type-badge svg {
    width: 14px;
    height: 14px;
  }

  .tx-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
  }

  .tx-status-badge.open {
    background: rgba(48, 209, 88, 0.1);
    color: #30d158;
    border: 1px solid rgba(48, 209, 88, 0.2);
  }

  .tx-status-badge.partial {
    background: rgba(255, 159, 10, 0.1);
    color: #ff9f0a;
    border: 1px solid rgba(255, 159, 10, 0.2);
  }

  .tx-status-badge.closed {
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
    border: 1px solid var(--border-primary);
  }

  .tx-status-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
  }

  .tx-card-body {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-4);
  }

  .tx-data-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .tx-data-label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-weight: var(--font-medium);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .tx-data-value {
    font-family: var(--font-number);
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
  }

  .tx-data-value.price {
    color: var(--text-primary);
  }

  .tx-data-value.profit {
    transition: color var(--duration-fast) var(--ease-default);
  }

  .tx-data-value.profit.positive {
    color: #30d158;
  }

  .tx-data-value.profit.negative {
    color: #ff375f;
  }

  .tx-data-value.profit.neutral {
    color: var(--text-tertiary);
  }

  .tx-data-sub {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    margin-top: 2px;
  }

  .tx-data-sub.sell-price {
    color: #ff375f;
  }

  .tx-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-3);
    border-top: 1px solid var(--border-primary);
  }

  .tx-time {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-family: var(--font-mono);
  }

  .tx-time svg {
    width: 14px;
    height: 14px;
    opacity: 0.6;
  }

  .tx-actions {
    display: flex;
    gap: var(--space-2);
  }

  .tx-action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-lg);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    border: 1px solid var(--border-primary);
    background: var(--bg-primary);
    color: var(--text-secondary);
  }

  .tx-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }

  .tx-action-btn.edit {
    border-color: rgba(100, 210, 255, 0.3);
    color: #64d2ff;
  }

  .tx-action-btn.edit:hover {
    background: rgba(100, 210, 255, 0.1);
    border-color: #64d2ff;
  }

  .tx-action-btn.sell {
    border-color: rgba(255, 55, 95, 0.3);
    color: #ff375f;
  }

  .tx-action-btn.sell:hover {
    background: rgba(255, 55, 95, 0.1);
    border-color: #ff375f;
  }

  .tx-action-btn.delete {
    border-color: rgba(255, 55, 95, 0.2);
    color: var(--text-tertiary);
  }

  .tx-action-btn.delete:hover {
    background: rgba(255, 55, 95, 0.1);
    border-color: #ff375f;
    color: #ff375f;
  }

  .tx-action-btn svg {
    width: 14px;
    height: 14px;
  }

  .tx-sell-panel {
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-primary);
    animation: slideDown var(--duration-normal) var(--ease-default);
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .tx-sell-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
  }

  .tx-sell-panel-title {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .tx-sell-panel-title svg {
    color: #ff375f;
  }

  .tx-sell-close {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
  }

  .tx-sell-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .tx-sell-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .tx-sell-field {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .tx-sell-field label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-weight: var(--font-medium);
  }

  .tx-sell-field input {
    padding: var(--space-2) var(--space-3);
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: var(--font-number);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .tx-sell-field input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
    box-shadow: 0 0 0 3px rgba(100, 210, 255, 0.15);
  }

  .tx-sell-preview {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    margin-bottom: var(--space-3);
  }

  .tx-sell-preview-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .tx-sell-preview-label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .tx-sell-preview-value {
    font-family: var(--font-number);
    font-size: var(--text-base);
    font-weight: var(--font-bold);
  }

  .tx-sell-preview-value.profit {
    transition: color var(--duration-fast) var(--ease-default);
  }

  .tx-sell-preview-value.profit.positive {
    color: #30d158;
  }

  .tx-sell-preview-value.profit.negative {
    color: #ff375f;
  }

  .tx-sell-submit {
    width: 100%;
    padding: var(--space-3);
    background: linear-gradient(135deg, #ff375f, #ff453a);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
  }

  .tx-sell-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 55, 95, 0.3);
  }

  .tx-sell-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .tx-edit-inline {
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-primary);
    animation: slideDown var(--duration-normal) var(--ease-default);
  }

  .tx-edit-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .tx-edit-field {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .tx-edit-field label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-weight: var(--font-medium);
  }

  .tx-edit-field input {
    padding: var(--space-2) var(--space-3);
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: var(--font-number);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .tx-edit-field input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
    box-shadow: 0 0 0 3px rgba(100, 210, 255, 0.15);
  }

  .tx-edit-actions {
    display: flex;
    gap: var(--space-2);
  }

  .tx-edit-btn {
    flex: 1;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
  }

  .tx-edit-btn.cancel {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
  }

  .tx-edit-btn.cancel:hover {
    background: var(--bg-secondary);
    border-color: var(--border-hover);
  }

  .tx-edit-btn.save {
    background: linear-gradient(135deg, var(--color-accent-blue), var(--color-accent-purple));
    border: none;
    color: white;
  }

  .tx-edit-btn.save:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(100, 210, 255, 0.3);
  }

  .tx-edit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .tx-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-12) var(--space-8);
    text-align: center;
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    border: 2px dashed var(--border-primary);
  }

  .tx-empty-icon {
    width: 64px;
    height: 64px;
    margin-bottom: var(--space-4);
    color: var(--text-quaternary);
    opacity: 0.5;
  }

  .tx-empty-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .tx-empty-desc {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    max-width: 280px;
  }

  .tx-profit-flash {
    animation: profitFlash 0.6s ease-out;
  }

  @keyframes profitFlash {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .tx-profit-positive {
    animation: profitPulse 1s ease-out;
  }

  @keyframes profitPulse {
    0% { box-shadow: 0 0 0 0 rgba(48, 209, 88, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(48, 209, 88, 0); }
    100% { box-shadow: 0 0 0 0 rgba(48, 209, 88, 0); }
  }

  .tx-number-animate {
    display: inline-block;
    transition: transform 0.3s ease-out;
  }

  .tx-number-animate.updating {
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .tx-card-body {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }

    .tx-data-item:last-child {
      grid-column: span 2;
    }

    .tx-card-footer {
      flex-direction: column;
      gap: var(--space-3);
      align-items: stretch;
    }

    .tx-actions {
      justify-content: flex-end;
    }

    .tx-sell-form,
    .tx-edit-grid {
      grid-template-columns: 1fr;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .filter-row {
      width: 100%;
    }

    .filter-row select {
      flex: 1;
    }
  }

  @media (max-width: 480px) {
    .tx-card {
      padding: var(--space-4);
    }

    .tx-card-body {
      grid-template-columns: 1fr;
    }

    .tx-data-item:last-child {
      grid-column: span 1;
    }

    .tx-data-value {
      font-size: var(--text-base);
    }

    .tx-action-btn {
      padding: var(--space-2);
    }

    .tx-action-btn span {
      display: none;
    }
  }

  .pagination {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-4);
  }

  .pagination button {
    padding: var(--space-2) var(--space-3);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .pagination button:hover:not(:disabled) {
    background: var(--bg-secondary);
    border-color: var(--border-hover);
  }

  .pagination button.active {
    background: var(--color-accent-blue);
    border-color: var(--color-accent-blue);
    color: white;
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .charts-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  @media (max-width: 768px) {
    .charts-section {
      grid-template-columns: 1fr;
    }
  }

  .chart-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    position: relative;
    min-height: 320px;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .chart-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .chart-subtitle {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .chart-legend {
    display: flex;
    gap: var(--space-3);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-xs);
    color: var(--text-secondary);
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .legend-dot.buy {
    background: #30d158;
    box-shadow: 0 0 4px #30d158;
  }

  .legend-dot.sell {
    background: #ff375f;
    box-shadow: 0 0 4px #ff375f;
  }

  .chart-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    color: var(--text-tertiary);
    font-size: var(--text-sm);
  }

  .chart-loading.hidden {
    display: none;
  }

  .loading-spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border-primary);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .chart-container {
    height: 220px;
    display: flex;
    align-items: flex-end;
    gap: 6px;
    padding: var(--space-4) 0;
    position: relative;
  }

  .chart-bar-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    justify-content: flex-end;
    position: relative;
  }

  .chart-bar-group {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    width: 100%;
    justify-content: center;
    flex: 1;
  }

  .chart-bar {
    width: 16px;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    min-height: 4px;
    transition: all var(--duration-fast) var(--ease-default);
    position: relative;
    cursor: pointer;
  }

  .chart-bar:hover {
    opacity: 0.85;
    transform: scaleY(1.02);
  }

  .chart-bar.buy {
    background: linear-gradient(180deg, #30d158, #30d15880);
  }

  .chart-bar.sell {
    background: linear-gradient(180deg, #ff375f, #ff375f80);
  }

  .chart-bar.profit {
    background: linear-gradient(180deg, var(--color-accent-blue), var(--color-accent-purple));
  }

  .chart-bar.negative {
    background: linear-gradient(180deg, #ff375f, #ff453a);
  }

  .chart-bar::after {
    content: attr(data-value);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    white-space: nowrap;
    opacity: 0;
    transition: opacity var(--duration-fast) var(--ease-default);
    background: var(--bg-elevated);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-primary);
    z-index: 10;
  }

  .chart-bar:hover::after {
    opacity: 1;
  }

  .chart-bar-label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    margin-top: var(--space-2);
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .chart-tooltip {
    position: absolute;
    background: var(--bg-elevated);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-3);
    box-shadow: var(--shadow-lg);
    z-index: 100;
    min-width: 150px;
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .chart-tooltip.visible {
    opacity: 1;
  }

  .tooltip-title {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
    border-bottom: 1px solid var(--border-primary);
    padding-bottom: var(--space-1);
  }

  .tooltip-row {
    display: flex;
    justify-content: space-between;
    font-size: var(--text-xs);
    margin: var(--space-1) 0;
  }

  .tooltip-label {
    color: var(--text-tertiary);
  }

  .tooltip-value {
    font-weight: var(--font-medium);
    font-family: var(--font-number);
  }

  .tooltip-value.buy {
    color: #30d158;
  }

  .tooltip-value.sell {
    color: #ff375f;
  }

  .monthly-chart-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-primary);
    transition: all var(--duration-fast) var(--ease-default);
    cursor: pointer;
    min-width: 100px;
  }

  .monthly-chart-item:hover {
    border-color: var(--color-primary);
    box-shadow: 0 4px 12px rgba(0, 113, 227, 0.15);
    transform: translateY(-2px);
  }

  .monthly-week-label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    font-weight: var(--font-medium);
  }

  .monthly-profit {
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    font-family: var(--font-number);
  }

  .monthly-profit.positive {
    color: #30d158;
  }

  .monthly-profit.negative {
    color: #ff375f;
  }

  .monthly-stats {
    display: flex;
    gap: var(--space-3);
    font-size: var(--text-xs);
  }

  .monthly-stat {
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .monthly-stat.buy {
    color: #30d158;
  }

  .monthly-stat.sell {
    color: #ff375f;
  }

  .chart-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-tertiary);
    gap: var(--space-2);
  }

  .chart-empty svg {
    opacity: 0.5;
  }

  .chart-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--color-error);
    gap: var(--space-2);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-12) var(--space-8);
    color: var(--text-tertiary);
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    border: 2px dashed var(--border-primary);
    margin: var(--space-4);
  }

  .empty-state svg {
    margin-bottom: var(--space-4);
    opacity: 0.4;
    color: var(--text-tertiary);
  }

  .empty-state p {
    font-size: var(--text-base);
    font-weight: var(--font-medium);
  }
</style>

<script define:vars={{ isAuthenticated }}>
  const API_BASE = 'https://api.ustc.dev';
  const serverAuthenticated = isAuthenticated;

  const loginSection = document.getElementById('login-section');
  const dashboardSection = document.getElementById('dashboard-section');
  const loginForm = document.getElementById('trading-login-form');
  const buyForm = document.getElementById('buy-form');
  const sellForm = document.getElementById('sell-form');
  const alertForm = document.getElementById('alert-form');

  let currentPage = 1;
  let totalPages = 1;

  function formatCurrency(value) {
    const num = parseFloat(value) || 0;
    return `¬•${num.toFixed(2)}`;
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('zh-CN', {
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  async function apiRequest(endpoint, options = {}) {
    try {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        }
      });
      
      if (!response.ok) {
        return { success: false, error: `HTTP Error: ${response.status}` };
      }
      
      const text = await response.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        return { success: false, error: 'Invalid JSON response' };
      }
    } catch (error) {
      return { success: false, error: error.message || 'Network error' };
    }
  }

  async function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('trading-username').value;
    const password = document.getElementById('trading-password').value;
    const loginBtn = document.getElementById('trading-login-btn');
    const btnText = loginBtn.querySelector('.btn-text');
    const btnLoading = loginBtn.querySelector('.btn-loading');
    
    if (!username || !password) {
      alert('ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
      return;
    }
    
    btnText.classList.add('hidden');
    btnLoading.classList.remove('hidden');
    loginBtn.disabled = true;
    
    try {
      const result = await apiRequest('/api/trading/login', {
        method: 'POST',
        body: JSON.stringify({ username, password })
      });
      
      if (result.success) {
        showDashboard();
      } else {
        alert(result.error || 'ÁôªÂΩïÂ§±Ë¥•');
      }
    } catch (error) {
      alert('ÁôªÂΩïËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message);
    } finally {
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
      loginBtn.disabled = false;
    }
  }

  if (loginForm) {
    loginForm.addEventListener('submit', handleLogin);
  }

  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      try {
        await apiRequest('/api/trading/logout', { method: 'POST' });
        window.location.reload();
      } catch (error) {
        window.location.reload();
      }
    });
  }

  function showLogin() {
    loginSection?.classList.remove('hidden');
    dashboardSection?.classList.add('hidden');
  }

  function showDashboard() {
    loginSection?.classList.add('hidden');
    dashboardSection?.classList.remove('hidden');
    loadDashboard();
  }

  async function loadDashboard() {
    await Promise.all([
      loadGoldPrice(),
      loadStats(),
      loadTransactions(),
      loadAlerts(),
      loadToleranceSettings()
    ]);
  }

  async function loadGoldPrice() {
    try {
      const result = await apiRequest('/api/gold');
      if (result.success && result.data?.domestic?.price) {
        document.getElementById('current-gold-price').textContent = result.data.domestic.price.toFixed(2);
      }
    } catch (error) {
    }
  }

  function validateStatsData(stats) {
    if (!stats) return false;
    
    const requiredFields = ['total', 'week', 'month', 'weekly', 'monthly'];
    for (const field of requiredFields) {
      if (stats[field] === undefined) {
        return false;
      }
    }

    if (stats.total) {
      const totalFields = ['buy', 'sell', 'profit', 'quantityBought', 'quantitySold'];
      for (const field of totalFields) {
        if (typeof stats.total[field] !== 'number') {
          return false;
        }
      }
    }

    return true;
  }

  async function loadStats() {
    const weeklyLoading = document.getElementById('weekly-loading');
    const monthlyLoading = document.getElementById('monthly-loading');
    const weeklyChart = document.getElementById('weekly-chart');
    const monthlyChart = document.getElementById('monthly-chart');

    try {
      if (weeklyLoading) weeklyLoading.classList.remove('hidden');
      if (monthlyLoading) monthlyLoading.classList.remove('hidden');
      
      const result = await apiRequest('/api/trading/stats');
      if (result.success) {
        const stats = result.stats;
        
        if (!validateStatsData(stats)) {
          throw new Error('Êï∞ÊçÆÈ™åËØÅÂ§±Ë¥•');
        }

        document.getElementById('stat-total-profit').textContent = formatCurrency(stats.total.profit);
        document.getElementById('stat-month-profit').textContent = formatCurrency(stats.month.profit);
        document.getElementById('stat-week-profit').textContent = formatCurrency(stats.week.profit);
        
        const holdings = stats.total.quantityBought - stats.total.quantitySold;
        document.getElementById('stat-total-quantity').textContent = `${holdings.toFixed(3)}g`;

        renderCharts(stats);
      }
    } catch (error) {
      if (weeklyChart) {
        weeklyChart.innerHTML = `
          <div class="chart-error">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span>Âä†ËΩΩÂ§±Ë¥•</span>
          </div>
        `;
      }
      if (monthlyChart) {
        monthlyChart.innerHTML = `
          <div class="chart-error">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span>Âä†ËΩΩÂ§±Ë¥•</span>
          </div>
        `;
      }
    } finally {
      if (weeklyLoading) weeklyLoading.classList.add('hidden');
      if (monthlyLoading) monthlyLoading.classList.add('hidden');
    }
  }

  function renderCharts(stats) {
    const weeklyChart = document.getElementById('weekly-chart');
    const monthlyChart = document.getElementById('monthly-chart');

    renderWeeklyChart(weeklyChart, stats.weekly || []);
    renderMonthlyChart(monthlyChart, stats.monthly || []);
  }

  function renderWeeklyChart(container, weeklyData) {
    if (!container) return;

    if (!weeklyData || weeklyData.length === 0) {
      container.innerHTML = `
        <div class="chart-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
          <span>ÊöÇÊó†Êú¨Âë®Êï∞ÊçÆ</span>
        </div>
      `;
      return;
    }

    const reversedData = [...weeklyData].reverse();
    const maxAmount = Math.max(
      ...reversedData.flatMap(d => [Math.abs(d.buy_amount || 0), Math.abs(d.sell_amount || 0)]),
      1
    );

    container.innerHTML = reversedData.map(d => {
      const buyHeight = ((d.buy_amount || 0) / maxAmount) * 160;
      const sellHeight = ((d.sell_amount || 0) / maxAmount) * 160;
      const dateLabel = d.date ? new Date(d.date).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }) : '';
      
      return `
        <div class="chart-bar-wrapper">
          <div class="chart-bar-group">
            <div class="chart-bar buy" style="height: ${Math.max(buyHeight, 4)}px" 
                 data-value="‰π∞ÂÖ•: ${formatCurrency(d.buy_amount || 0)}"
                 data-info='${JSON.stringify({ date: dateLabel, buy: d.buy_amount || 0, sell: d.sell_amount || 0, profit: d.profit || 0 })}'></div>
            <div class="chart-bar sell" style="height: ${Math.max(sellHeight, 4)}px"
                 data-value="ÂçñÂá∫: ${formatCurrency(d.sell_amount || 0)}"
                 data-info='${JSON.stringify({ date: dateLabel, buy: d.buy_amount || 0, sell: d.sell_amount || 0, profit: d.profit || 0 })}'></div>
          </div>
          <div class="chart-bar-label">${dateLabel}</div>
        </div>
      `;
    }).join('');

    container.querySelectorAll('.chart-bar').forEach(bar => {
      bar.addEventListener('mouseenter', showWeeklyTooltip);
      bar.addEventListener('mouseleave', hideTooltip);
    });
  }

  function showWeeklyTooltip(event) {
    const info = event.target.dataset.info ? JSON.parse(event.target.dataset.info) : {};
    const tooltip = document.getElementById('weekly-tooltip');
    if (!tooltip) return;

    tooltip.innerHTML = `
      <div class="tooltip-title">${info.date || '-'}</div>
      <div class="tooltip-row">
        <span class="tooltip-label">‰π∞ÂÖ•ÈáëÈ¢ù</span>
        <span class="tooltip-value buy">${formatCurrency(info.buy || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">ÂçñÂá∫ÈáëÈ¢ù</span>
        <span class="tooltip-value sell">${formatCurrency(info.sell || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">Êî∂Áõä</span>
        <span class="tooltip-value ${(info.profit || 0) >= 0 ? 'buy' : 'sell'}">${formatCurrency(info.profit || 0)}</span>
      </div>
    `;
    
    const rect = event.target.getBoundingClientRect();
    const container = document.getElementById('weekly-chart').getBoundingClientRect();
    tooltip.style.left = `${rect.left - container.left + rect.width / 2}px`;
    tooltip.style.top = `${rect.top - container.top - 10}px`;
    tooltip.style.transform = 'translate(-50%, -100%)';
    tooltip.classList.add('visible');
  }

  function renderMonthlyChart(container, monthlyData) {
    if (!container) return;

    if (!monthlyData || monthlyData.length === 0) {
      container.innerHTML = `
        <div class="chart-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span>ÊöÇÊó†ÊúàÂ∫¶Êï∞ÊçÆ</span>
        </div>
      `;
      return;
    }

    const reversedData = [...monthlyData].reverse();

    container.innerHTML = `
      <div style="display: flex; gap: 12px; justify-content: space-around; width: 100%; align-items: flex-end;">
        ${reversedData.map(d => {
          const profit = d.profit || 0;
          const profitClass = profit >= 0 ? 'positive' : 'negative';
          const weekLabel = `Á¨¨${d.week}Âë®`;
          const dateRange = d.week_start ? `${new Date(d.week_start).getMonth() + 1}/${new Date(d.week_start).getDate()}` : '';
          
          return `
            <div class="monthly-chart-item" data-info='${JSON.stringify(d)}'>
              <span class="monthly-week-label">${weekLabel}</span>
              <span class="monthly-profit ${profitClass}">${formatCurrency(profit)}</span>
              <div class="monthly-stats">
                <span class="monthly-stat buy">‚Üë ${d.buy_count || 0}</span>
                <span class="monthly-stat sell">‚Üì ${d.sell_count || 0}</span>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;

    container.querySelectorAll('.monthly-chart-item').forEach(item => {
      item.addEventListener('mouseenter', showMonthlyTooltip);
      item.addEventListener('mouseleave', hideTooltip);
    });
  }

  function showMonthlyTooltip(event) {
    const info = event.currentTarget.dataset.info ? JSON.parse(event.currentTarget.dataset.info) : {};
    const tooltip = document.getElementById('monthly-tooltip');
    if (!tooltip) return;

    tooltip.innerHTML = `
      <div class="tooltip-title">Á¨¨${info.week}Âë® (${info.week_start || '-'})</div>
      <div class="tooltip-row">
        <span class="tooltip-label">‰π∞ÂÖ•ÈáëÈ¢ù</span>
        <span class="tooltip-value buy">${formatCurrency(info.buy_amount || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">ÂçñÂá∫ÈáëÈ¢ù</span>
        <span class="tooltip-value sell">${formatCurrency(info.sell_amount || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">Êî∂Áõä</span>
        <span class="tooltip-value ${(info.profit || 0) >= 0 ? 'buy' : 'sell'}">${formatCurrency(info.profit || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">‰π∞ÂÖ•Ê¨°Êï∞</span>
        <span class="tooltip-value">${info.buy_count || 0}Ê¨°</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">ÂçñÂá∫Ê¨°Êï∞</span>
        <span class="tooltip-value">${info.sell_count || 0}Ê¨°</span>
      </div>
    `;
    
    const rect = event.currentTarget.getBoundingClientRect();
    const container = document.getElementById('monthly-chart').getBoundingClientRect();
    tooltip.style.left = `${rect.left - container.left + rect.width / 2}px`;
    tooltip.style.top = `${rect.top - container.top - 10}px`;
    tooltip.style.transform = 'translate(-50%, -100%)';
    tooltip.classList.add('visible');
  }

  function hideTooltip() {
    document.querySelectorAll('.chart-tooltip').forEach(t => t.classList.remove('visible'));
  }

  let totalTransactionCount = 0;

  async function loadTransactions(page = 1) {
    const list = document.getElementById('transactions-list');
    const pagination = document.getElementById('pagination');

    if (list) {
      list.innerHTML = `
        <div class="tx-skeleton">
          <div class="tx-skeleton-header">
            <div class="tx-skeleton-badge"></div>
            <div class="tx-skeleton-status"></div>
          </div>
          <div class="tx-skeleton-grid">
            <div class="tx-skeleton-item"></div>
            <div class="tx-skeleton-item"></div>
            <div class="tx-skeleton-item"></div>
            <div class="tx-skeleton-item"></div>
          </div>
        </div>
      `;
    }
    if (pagination) pagination.innerHTML = '';

    try {
      const type = document.getElementById('filter-type')?.value || '';
      const sort = document.getElementById('filter-sort')?.value || 'desc';

      let url = `/api/trading/transactions?page=${page}&limit=10&sortOrder=${sort}`;
      if (type) url += `&type=${type}`;

      const result = await apiRequest(url);
      if (result.success) {
        totalTransactionCount = result.pagination?.total || 0;
        renderTransactions(result.transactions, page);
        renderPagination(result.pagination);
      } else {
        if (list) {
          list.innerHTML = `
            <div class="tx-empty-state">
              <svg class="tx-empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <div class="tx-empty-title">Âä†ËΩΩÂ§±Ë¥•</div>
              <div class="tx-empty-desc">${result.error || 'Êú™Áü•ÈîôËØØ'}</div>
              <button onclick="loadTransactions(${page})" style="margin-top: var(--space-4); padding: var(--space-2) var(--space-4); background: var(--color-primary); color: white; border-radius: var(--radius-lg); border: none; cursor: pointer;">ÈáçËØï</button>
            </div>
          `;
        }
      }
    } catch (error) {
      if (list) {
        list.innerHTML = `
          <div class="tx-empty-state">
            <svg class="tx-empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <div class="tx-empty-title">ÁΩëÁªúÈîôËØØ</div>
            <div class="tx-empty-desc">ËØ∑Ê£ÄÊü•ËøûÊé•ÂêéÈáçËØï</div>
            <button onclick="loadTransactions(${page})" style="margin-top: var(--space-4); padding: var(--space-2) var(--space-4); background: var(--color-primary); color: white; border-radius: var(--radius-lg); border: none; cursor: pointer;">ÈáçËØï</button>
          </div>
        `;
      }
    }
  }

  function calculateSequence(index, page) {
    const itemsPerPage = 10;
    const globalIndex = (page - 1) * itemsPerPage + index + 1;
    return `#${String(globalIndex).padStart(3, '0')}`;
  }

  function getTransactionStatus(t) {
    if (t.type === 'sell') {
      return 'closed';
    }
    if (t.remaining_quantity !== undefined && t.remaining_quantity < t.quantity && t.remaining_quantity > 0) {
      return 'partial';
    }
    if (t.remaining_quantity === 0) {
      return 'closed';
    }
    return 'open';
  }

  function getStatusLabel(status) {
    const labels = {
      open: 'ÊåÅ‰ªì‰∏≠',
      partial: 'ÈÉ®ÂàÜÂçñÂá∫',
      closed: 'Â∑≤Âπ≥‰ªì'
    };
    return labels[status] || status;
  }

  function renderTransactions(transactions, page = 1) {
    const list = document.getElementById('transactions-list');
    if (!list) return;

    if (!transactions?.length) {
      list.innerHTML = `
        <div class="tx-empty-state">
          <svg class="tx-empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
          <div class="tx-empty-title">ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï</div>
          <div class="tx-empty-desc">ÂºÄÂßãËÆ∞ÂΩïÊÇ®ÁöÑÁ¨¨‰∏ÄÁ¨î‰∫§ÊòìÂêß</div>
        </div>
      `;
      return;
    }

    list.innerHTML = transactions.map((t, index) => {
      const isBuy = t.type === 'buy';
      const profitValue = parseFloat(t.profit) || 0;
      const profitClass = profitValue > 0 ? 'positive' : profitValue < 0 ? 'negative' : 'neutral';
      const sequence = calculateSequence(index, page);
      const status = getTransactionStatus(t);
      const statusLabel = getStatusLabel(status);
      const showSellBtn = isBuy && status !== 'closed';

      return `
        <div class="tx-card ${t.type}" data-id="${t.id}" data-index="${index}">
          <div class="tx-card-header">
            <div class="tx-card-left">
              <span class="tx-sequence">${sequence}</span>
              <span class="tx-type-badge ${t.type}">
                ${isBuy ? `
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                ` : `
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                `}
                ${isBuy ? '‰π∞ÂÖ•' : 'ÂçñÂá∫'}
              </span>
            </div>
            <span class="tx-status-badge ${status}">${statusLabel}</span>
          </div>
          
          <div class="tx-card-body">
            <div class="tx-data-item">
              <span class="tx-data-label">${isBuy ? '‰π∞ÂÖ•‰ª∑Ê†º' : 'ÂçñÂá∫‰ª∑Ê†º'}</span>
              <span class="tx-data-value price">¬•${t.price.toFixed(2)}</span>
              ${!isBuy && t.actual_sell_price ? `<span class="tx-data-sub sell-price">‰π∞ÂÖ•: ¬•${t.price.toFixed(2)}</span>` : ''}
            </div>
            <div class="tx-data-item">
              <span class="tx-data-label">Êï∞Èáè</span>
              <span class="tx-data-value">${t.quantity.toFixed(3)} g</span>
            </div>
            <div class="tx-data-item">
              <span class="tx-data-label">ÊÄªÈ¢ù</span>
              <span class="tx-data-value">¬•${(t.total_amount || t.price * t.quantity).toFixed(2)}</span>
            </div>
            <div class="tx-data-item">
              <span class="tx-data-label">Êî∂Áõä</span>
              <span class="tx-data-value profit ${profitClass} tx-number-animate" data-profit="${profitValue}">
                ${isBuy ? '-' : formatCurrency(t.profit)}
              </span>
            </div>
          </div>
          
          <div class="tx-card-footer">
            <div class="tx-time">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              ${formatDate(t.created_at)}
            </div>
            <div class="tx-actions">
              <button class="tx-action-btn edit" onclick="toggleEditPanel(${t.id})" data-id="${t.id}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                <span>ÁºñËæë</span>
              </button>
              ${showSellBtn ? `
                <button class="tx-action-btn sell" onclick="toggleSellPanel(${t.id})" data-id="${t.id}">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  <span>ÂçñÂá∫</span>
                </button>
              ` : ''}
              <button class="tx-action-btn delete" onclick="deleteTransaction(${t.id})">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a