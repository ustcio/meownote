---
import Layout from '@layouts/Layout.astro';

const API_BASE = 'https://api.ustc.dev';
---

<Layout 
  title="黄金交易管理 - USTC Dev"
  description="黄金交易管理与收益分析"
>
  <section class="trading" id="trading-app">
    <div class="trading-login" id="login-section">
      <div class="login-card">
        <div class="login-icon">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
            <circle cx="32" cy="32" r="28" stroke="url(#lockGradient)" stroke-width="3" fill="none"/>
            <rect x="20" y="28" width="24" height="20" rx="3" fill="url(#lockGradient)"/>
            <path d="M24 28V24C24 19.5817 27.5817 16 32 16C36.4183 16 40 19.5817 40 24V28" stroke="url(#lockGradient)" stroke-width="3" fill="none"/>
            <circle cx="32" cy="38" r="3" fill="white"/>
            <rect x="31" y="40" width="2" height="5" fill="white"/>
            <defs>
              <linearGradient id="lockGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#64d2ff"/>
                <stop offset="100%" style="stop-color:#bf5af2"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <h1 class="login-title">超级管理员</h1>
        <p class="login-subtitle">登录以访问交易管理系统</p>

        <form class="login-form" id="trading-login-form">
          <div class="form-group">
            <label for="trading-username">用户名</label>
            <div class="input-wrapper">
              <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <input type="text" id="trading-username" name="username" required placeholder="请输入用户名" />
            </div>
          </div>
          <div class="form-group">
            <label for="trading-password">密码</label>
            <div class="input-wrapper">
              <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              <input type="password" id="trading-password" name="password" required placeholder="请输入密码" />
              <button type="button" class="toggle-password" id="trading-toggle-pwd">
                <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-closed hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="login-btn" id="trading-login-btn">
            <span class="btn-text">登录</span>
            <span class="btn-loading hidden">
              <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
              </svg>
            </span>
          </button>
        </form>
      </div>
    </div>

    <div class="trading-dashboard hidden" id="dashboard-section">
      <div class="dashboard-header">
        <div class="header-left">
          <h1 class="dashboard-title">黄金交易管理</h1>
          <p class="dashboard-subtitle">实时监控金价，智能管理交易</p>
        </div>
        <div class="header-actions">
          <div class="gold-price-widget" id="price-card">
            <div class="gold-price-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v12M8 10h8M8 14h8"></path>
              </svg>
            </div>
            <div class="gold-price-content">
              <span class="gold-price-label">实时金价</span>
              <div class="gold-price-value-row">
                <span class="gold-price-value loading" id="current-gold-price">--</span>
                <span class="gold-price-unit">元/克</span>
              </div>
              <span class="gold-price-time" id="price-update-time">--</span>
            </div>
            <div class="gold-price-indicator">
              <span class="pulse-dot"></span>
            </div>
          </div>
          <button class="action-btn logout-btn" id="logout-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>退出</span>
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card profit">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-total-profit">¥0.00</span>
            <span class="stat-label">累计收益</span>
          </div>
        </div>
        <div class="stat-card month">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-month-profit">¥0.00</span>
            <span class="stat-label">本月收益</span>
          </div>
        </div>
        <div class="stat-card week">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-week-profit">¥0.00</span>
            <span class="stat-label">本周收益</span>
          </div>
        </div>
        <div class="stat-card quantity">
          <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="stat-total-quantity">0g</span>
            <span class="stat-label">持仓克数</span>
          </div>
        </div>
      </div>

      <div class="main-grid">
        <div class="panel buy-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              买入设置
            </h2>
          </div>
          <form class="panel-form" id="buy-form">
            <div class="form-row">
              <div class="form-group">
                <label>买入金价</label>
                <div class="input-with-unit">
                  <input type="number" id="buy-price" step="0.01" min="0" placeholder="0.00" required />
                  <span class="unit">元/克</span>
                </div>
              </div>
              <div class="form-group">
                <label>买入克数</label>
                <div class="input-with-unit">
                  <input type="number" id="buy-quantity" step="0.001" min="0.001" placeholder="0.000" required />
                  <span class="unit">g</span>
                </div>
              </div>
            </div>
            <div class="calculated-row">
              <span class="calc-label">买入总额</span>
              <span class="calc-value" id="buy-total">¥0.00</span>
            </div>
            <div class="form-group">
              <label>备注</label>
              <input type="text" id="buy-notes" placeholder="可选备注" />
            </div>
            <button type="submit" class="submit-btn buy">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              确认买入
            </button>
          </form>
        </div>

        <div class="panel sell-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              卖出设置
            </h2>
          </div>
          <form class="panel-form" id="sell-form">
            <div class="form-row">
              <div class="form-group">
                <label>卖出价格</label>
                <div class="input-with-unit">
                  <input type="number" id="sell-price" step="0.01" min="0" placeholder="0.00" required />
                  <span class="unit">元/克</span>
                </div>
              </div>
              <div class="form-group">
                <label>卖出克数</label>
                <div class="input-with-unit">
                  <input type="number" id="sell-quantity" step="0.001" min="0.001" placeholder="0.000" required />
                  <span class="unit">g</span>
                </div>
              </div>
            </div>
            <div class="calculated-row">
              <span class="calc-label">卖出总额</span>
              <span class="calc-value" id="sell-total">¥0.00</span>
            </div>
            <div class="form-group">
              <label>备注</label>
              <input type="text" id="sell-notes" placeholder="可选备注" />
            </div>
            <button type="submit" class="submit-btn sell">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              确认卖出
            </button>
          </form>
        </div>

        <div class="panel alert-panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              价格预警
            </h2>
          </div>
          <form class="panel-form" id="alert-form">
            <div class="alert-type-row">
              <label class="alert-type-label">
                <input type="radio" name="alert-type" value="buy" checked />
                <span class="alert-type-btn buy">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  买入提醒
                </span>
              </label>
              <label class="alert-type-label">
                <input type="radio" name="alert-type" value="sell" />
                <span class="alert-type-btn sell">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  卖出提醒
                </span>
              </label>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>目标价格</label>
                <div class="input-with-unit">
                  <input type="number" id="alert-price" step="0.01" min="0" placeholder="0.00" required />
                  <span class="unit">元/克</span>
                </div>
              </div>
              <div class="form-group">
                <label>容错范围</label>
                <div class="input-with-unit">
                  <input type="number" id="alert-tolerance" step="0.01" min="0" max="50" placeholder="1.00" value="1.00" />
                  <span class="unit">元/克</span>
                </div>
              </div>
            </div>
            <div class="tolerance-hint">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              <span id="tolerance-hint-text">当价格在目标价格 ±1.00 元范围内时发送提醒</span>
            </div>
            <button type="submit" class="submit-btn alert">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              添加预警
            </button>
          </form>
          <div class="alert-list" id="alert-list"></div>
        </div>
      </div>

      <div class="transactions-section" id="transactions-section">
        <div class="tx-section-header">
          <h2 class="tx-section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            交易记录
          </h2>
          <button class="add-transaction-btn" id="add-transaction-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>增加记录</span>
          </button>
        </div>
        <div class="filter-bar">
          <div class="filter-segment-control" id="filter-type-segment">
            <button class="segment-btn active" data-value="">全部</button>
            <button class="segment-btn" data-value="buy">买入</button>
            <button class="segment-btn" data-value="sell">卖出</button>
          </div>
          <div class="filter-sort-wrapper">
            <span class="sort-label">排序</span>
            <select class="sort-select" id="sort-order">
              <option value="desc">最新优先</option>
              <option value="asc">最早优先</option>
            </select>
          </div>
        </div>
        <div class="transactions-list-container" id="transactions-list"></div>
        <div class="pagination" id="pagination"></div>
      </div>
      
      <div class="delete-confirm-modal hidden" id="delete-confirm-modal">
        <div class="delete-modal-backdrop" id="delete-modal-backdrop"></div>
        <div class="delete-modal-content">
          <div class="delete-modal-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <h3 class="delete-modal-title">确认删除</h3>
          <p class="delete-modal-desc">确定要删除这条交易记录吗？此操作无法撤销。</p>
          <div class="delete-modal-actions">
            <button class="delete-modal-btn cancel" id="delete-cancel-btn">取消</button>
            <button class="delete-modal-btn confirm" id="delete-confirm-btn">删除</button>
          </div>
        </div>
      </div>
      
      <div class="edit-transaction-modal hidden" id="edit-transaction-modal">
        <div class="edit-modal-backdrop" id="edit-modal-backdrop"></div>
        <div class="edit-modal-content">
          <div class="edit-modal-header">
            <h3>编辑交易记录</h3>
            <button class="modal-close" id="edit-modal-close">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <form id="edit-transaction-form">
            <input type="hidden" id="edit-tx-id" />
            <input type="hidden" id="edit-tx-type" />
            <div class="edit-form-grid">
              <div class="edit-form-group">
                <label>交易时间</label>
                <input type="datetime-local" id="edit-tx-date" required />
              </div>
              <div class="edit-form-group">
                <label>买入价格 (元/克)</label>
                <input type="number" id="edit-tx-buy-price" step="0.01" min="0" placeholder="0.00" />
              </div>
              <div class="edit-form-group">
                <label>买入数量 (克)</label>
                <input type="number" id="edit-tx-buy-qty" step="0.001" min="0" placeholder="0.000" />
              </div>
              <div class="edit-form-group">
                <label>卖出价格 (元/克)</label>
                <input type="number" id="edit-tx-sell-price" step="0.01" min="0" placeholder="0.00" />
              </div>
              <div class="edit-form-group">
                <label>卖出数量 (克)</label>
                <input type="number" id="edit-tx-sell-qty" step="0.001" min="0" placeholder="0.000" />
              </div>
              <div class="edit-form-group">
                <label>交易平台</label>
                <input type="text" id="edit-tx-platform" placeholder="例如：银行纸黄金" />
              </div>
            </div>
            <div class="edit-form-actions">
              <button type="button" class="edit-form-btn cancel" id="edit-cancel-btn">取消</button>
              <button type="submit" class="edit-form-btn save">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                保存更改
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="add-transaction-modal hidden" id="add-transaction-modal">
        <div class="modal-backdrop" id="add-modal-backdrop"></div>
        <div class="modal-content">
          <div class="modal-header">
            <h3>新增交易记录</h3>
            <button class="modal-close" id="add-modal-close">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <form id="add-transaction-form">
            <div class="form-row">
              <div class="form-group">
                <label>交易类型</label>
                <div class="type-toggle">
                  <button type="button" class="type-btn active" data-type="buy">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    买入
                  </button>
                  <button type="button" class="type-btn" data-type="sell">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    卖出
                  </button>
                </div>
                <input type="hidden" id="add-type" name="type" value="buy" />
              </div>
              <div class="form-group">
                <label>交易时间</label>
                <input type="datetime-local" id="add-date" name="date" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" id="buy-price-group">
                <label>买入价格 (元/克) <span class="required-hint">*</span></label>
                <input type="number" id="add-buy-price" name="buyPrice" step="0.01" min="0" placeholder="例如：580.00" />
              </div>
              <div class="form-group" id="sell-price-group">
                <label>卖出价格 (元/克)</label>
                <input type="number" id="add-sell-price" name="sellPrice" step="0.01" min="0" placeholder="卖出时填写" />
              </div>
            </div>
            <div class="form-group">
              <label>数量 (克) <span class="required-hint">*</span></label>
              <input type="number" id="add-quantity" name="quantity" step="0.001" min="0" placeholder="例如：1.000" required />
            </div>
            <div class="form-group">
              <label>交易平台</label>
              <input type="text" id="add-platform" name="platform" placeholder="例如：银行纸黄金" />
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel" id="add-cancel-btn">取消</button>
              <button type="submit" class="btn-submit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                保存
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="charts-section">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">每周收益</h3>
            <div class="chart-legend">
              <span class="legend-item"><span class="legend-dot buy"></span>买入</span>
              <span class="legend-item"><span class="legend-dot sell"></span>卖出</span>
            </div>
          </div>
          <div class="chart-container" id="weekly-chart"></div>
          <div class="chart-tooltip" id="weekly-tooltip"></div>
          <div class="chart-loading" id="weekly-loading">
            <div class="loading-spinner"></div>
            <span>加载中...</span>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">月度收益</h3>
            <span class="chart-subtitle">最近4周完整数据</span>
          </div>
          <div class="chart-container" id="monthly-chart"></div>
          <div class="chart-tooltip" id="monthly-tooltip"></div>
          <div class="chart-loading" id="monthly-loading">
            <div class="loading-spinner"></div>
            <span>加载中...</span>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style is:global>
  .trading {
    min-height: 100vh;
    padding: calc(var(--header-total-height) + var(--space-4)) var(--space-4) var(--space-12);
  }

  .hidden {
    display: none !important;
  }

  .trading-login {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - var(--header-total-height) - var(--space-16));
  }

  .login-card {
    width: 100%;
    max-width: 400px;
    padding: var(--space-8);
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    text-align: center;
  }

  .login-icon {
    margin-bottom: var(--space-6);
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .login-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .login-subtitle {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    margin-bottom: var(--space-6);
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    text-align: left;
  }

  .form-group label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
  }

  .input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .input-icon {
    position: absolute;
    left: var(--space-3);
    color: var(--text-tertiary);
    pointer-events: none;
  }

  .input-wrapper input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    padding-left: calc(var(--space-3) + 26px);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .input-wrapper input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
    box-shadow: 0 0 0 3px rgba(100, 210, 255, 0.15);
    background: var(--bg-primary);
  }

  .toggle-password {
    position: absolute;
    right: var(--space-3);
    color: var(--text-tertiary);
    transition: color var(--duration-fast) var(--ease-default);
  }

  .toggle-password:hover {
    color: var(--text-secondary);
  }

  .toggle-password .hidden {
    display: none;
  }

  .login-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    margin-top: var(--space-2);
    background: linear-gradient(135deg, var(--color-accent-blue), var(--color-accent-purple));
    color: white;
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .login-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(100, 210, 255, 0.3);
  }

  .login-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    padding: var(--space-5);
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-sm);
  }

  .dashboard-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
  }

  .dashboard-subtitle {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  /* Gold Price Widget - 统一设计 */
  .gold-price-widget {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(135deg, rgba(255, 184, 0, 0.08) 0%, rgba(255, 215, 0, 0.04) 100%);
    border: 1px solid rgba(255, 184, 0, 0.2);
    border-radius: var(--radius-xl);
    transition: all var(--duration-fast) var(--ease-default);
    position: relative;
    min-width: 180px;
  }

  .gold-price-widget:hover {
    border-color: rgba(255, 184, 0, 0.35);
    box-shadow: 0 2px 12px rgba(255, 184, 0, 0.12);
  }

  .gold-price-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, rgba(255, 184, 0, 0.15) 0%, rgba(255, 215, 0, 0.1) 100%);
    border-radius: var(--radius-lg);
    color: #ffb800;
    flex-shrink: 0;
  }

  .gold-price-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
    min-width: 0;
  }

  .gold-price-label {
    font-size: 11px;
    color: var(--text-tertiary);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .gold-price-value-row {
    display: flex;
    align-items: baseline;
    gap: 4px;
  }

  .gold-price-value {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: #ffb800;
    font-family: var(--font-number);
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.02em;
    line-height: 1.2;
  }

  .gold-price-value.loading {
    animation: shimmer 1.5s infinite;
    background: linear-gradient(90deg, #ffb800 25%, #ffd700 50%, #ffb800 75%);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .gold-price-value.error {
    color: var(--text-tertiary);
    font-size: var(--text-base);
  }

  .gold-price-unit {
    font-size: 11px;
    color: var(--text-quaternary);
    font-weight: var(--font-medium);
  }

  .gold-price-time {
    font-size: 10px;
    color: var(--text-quaternary);
    font-family: var(--font-mono);
  }

  .gold-price-indicator {
    display: flex;
    align-items: center;
    padding-left: var(--space-2);
    border-left: 1px solid var(--border-primary);
  }

  .pulse-dot {
    width: 8px;
    height: 8px;
    background: #30d158;
    border-radius: 50%;
    animation: pulse-dot 2s infinite;
    box-shadow: 0 0 0 0 rgba(48, 209, 88, 0.4);
  }

  @keyframes pulse-dot {
    0%, 100% { 
      opacity: 1; 
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(48, 209, 88, 0.4);
    }
    50% { 
      opacity: 0.8; 
      transform: scale(0.9);
      box-shadow: 0 0 0 4px rgba(48, 209, 88, 0);
    }
  }

  /* Action Button - 统一设计 */
  .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-xl);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    white-space: nowrap;
  }

  .logout-btn {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
  }

  .logout-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-hover);
    transform: translateY(-1px);
  }

  .logout-btn:active {
    transform: translateY(0);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  @media (max-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
    .dashboard-header {
      flex-direction: column;
      align-items: stretch;
    }
    .header-right {
      width: 100%;
      justify-content: space-between;
    }
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4) var(--space-5);
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    transition: all var(--duration-fast) var(--ease-default);
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-primary), var(--color-accent-purple));
    opacity: 0;
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--border-hover);
  }

  .stat-card:hover::before {
    opacity: 1;
  }

  .stat-card .stat-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: var(--radius-xl);
    flex-shrink: 0;
  }

  .stat-card.profit .stat-icon {
    background: rgba(48, 209, 88, 0.15);
    color: #30d158;
  }

  .stat-card.month .stat-icon {
    background: rgba(100, 210, 255, 0.15);
    color: #64d2ff;
  }

  .stat-card.week .stat-icon {
    background: rgba(191, 90, 242, 0.15);
    color: #bf5af2;
  }

  .stat-card.quantity .stat-icon {
    background: rgba(255, 159, 10, 0.15);
    color: #ff9f0a;
  }

  .stat-card .stat-content {
    display: flex;
    flex-direction: column;
  }

  .stat-card .stat-value {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
    font-family: var(--font-number);
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
  }

  .stat-card .stat-label {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-weight: var(--font-medium);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .main-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  @media (max-width: 1024px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
  }

  .panel {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    transition: all var(--duration-fast) var(--ease-default);
    position: relative;
    overflow: hidden;
  }

  .panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-primary), var(--color-accent-purple));
    opacity: 0;
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .panel:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--border-hover);
  }

  .panel:hover::before {
    opacity: 1;
  }

  .panel.buy-panel::before {
    background: linear-gradient(90deg, #30d158, #34c759);
  }

  .panel.sell-panel::before {
    background: linear-gradient(90deg, #ff375f, #ff453a);
  }

  .panel.alert-panel::before {
    background: linear-gradient(90deg, #ff9f0a, #ffcc00);
  }

  .panel-header {
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--border-primary);
  }

  .panel-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .panel-title svg {
    flex-shrink: 0;
  }

  .buy-panel .panel-title svg {
    color: #30d158;
  }

  .sell-panel .panel-title svg {
    color: #ff375f;
  }

  .alert-panel .panel-title svg {
    color: #ff9f0a;
  }

  .panel-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .form-group label {
    display: block;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
  }

  @media (max-width: 480px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .input-with-unit {
    position: relative;
    display: flex;
    align-items: center;
  }

  .input-with-unit input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    padding-right: 60px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    font-family: var(--font-number);
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
    transition: all var(--duration-fast) var(--ease-default);
  }

  .input-with-unit input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
  }

  .input-with-unit input::placeholder {
    color: var(--text-quaternary);
  }

  .input-with-unit .unit {
    position: absolute;
    right: var(--space-3);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-weight: var(--font-medium);
  }

  .calculated-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-primary);
  }

  .calc-label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
  }

  .calc-value {
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    color: var(--text-primary);
  }

  .submit-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border-radius: var(--radius-lg);
    transition: all var(--duration-fast) var(--ease-default);
    border: none;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .submit-btn.buy {
    background: linear-gradient(135deg, #30d158, #34c759);
    color: white;
    box-shadow: 0 2px 8px rgba(48, 209, 88, 0.3);
  }

  .submit-btn.sell {
    background: linear-gradient(135deg, #ff375f, #ff453a);
    color: white;
    box-shadow: 0 2px 8px rgba(255, 55, 95, 0.3);
  }

  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }

  .submit-btn:active {
    transform: translateY(0);
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .alert-panel {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
  }

  .alert-panel .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .alert-panel .form-group {
    margin-bottom: 0;
  }

  .alert-type-row {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .alert-type-label {
    flex: 1;
    cursor: pointer;
  }

  .alert-type-label input {
    display: none;
  }

  .alert-type-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: var(--bg-secondary);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .alert-type-btn:hover {
    transform: translateY(-1px);
  }

  .alert-type-btn.buy:hover,
  .alert-type-label input:checked + .alert-type-btn.buy {
    border-color: #30d158;
    background: rgba(48, 209, 88, 0.15);
    color: #30d158;
  }

  .alert-type-btn.sell:hover,
  .alert-type-label input:checked + .alert-type-btn.sell {
    border-color: #ff375f;
    background: rgba(255, 55, 95, 0.15);
    color: #ff375f;
  }

  .tolerance-hint {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: rgba(0, 113, 227, 0.08);
    border: 1px solid rgba(0, 113, 227, 0.15);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-4);
    font-size: var(--text-xs);
    color: var(--text-secondary);
  }

  .tolerance-hint svg {
    color: var(--color-primary);
    flex-shrink: 0;
  }

  .submit-btn.alert {
    background: linear-gradient(135deg, #bf5af2 0%, #5e5ce6 100%);
    box-shadow: 0 2px 8px rgba(191, 90, 242, 0.3);
  }

  .submit-btn.alert:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(191, 90, 242, 0.4);
  }

  .alert-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-top: var(--space-4);
    max-height: 200px;
    overflow-y: auto;
  }

  .alert-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
  }

  .alert-item .alert-info {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .alert-item .alert-price {
    font-weight: var(--font-medium);
    color: var(--text-primary);
  }

  .alert-item .alert-tolerance {
    font-size: 10px;
    color: var(--text-tertiary);
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
  }

  .alert-item .alert-type {
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
  }

  .alert-item .alert-type.buy {
    background: rgba(48, 209, 88, 0.15);
    color: #30d158;
  }

  .alert-item .alert-type.sell {
    background: rgba(255, 55, 95, 0.15);
    color: #ff375f;
  }

  .alert-item .delete-alert {
    color: var(--text-tertiary);
    transition: color var(--duration-fast) var(--ease-default);
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-1);
  }

  .alert-item .delete-alert:hover {
    color: #ff375f;
  }

  /* ============================================
     APPLE STYLE TRANSACTION RECORDS - NEW DESIGN
     ============================================ */

  /* Section Container */
  .transactions-section {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-5);
    margin-bottom: var(--space-5);
  }

  /* Section Header - 使用 tx- 前缀避免冲突 */
  .tx-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .tx-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    letter-spacing: -0.01em;
  }

  .tx-section-title svg {
    color: var(--color-primary);
    width: 20px;
    height: 20px;
  }

  /* Add Transaction Button */
  .add-transaction-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent-blue) 100%);
    border: none;
    border-radius: var(--radius-lg);
    color: white;
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    box-shadow: 0 2px 8px rgba(0, 113, 227, 0.25);
  }

  .add-transaction-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(0, 113, 227, 0.35);
  }

  .add-transaction-btn:active {
    transform: scale(0.98);
  }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding: 16px 20px;
    background: var(--bg-secondary);
    border-radius: 16px;
    border: 1px solid var(--border-primary);
    gap: 16px;
    flex-wrap: wrap;
  }

  .filter-segment-control {
    display: inline-flex;
    background: var(--bg-tertiary);
    border-radius: 10px;
    padding: 4px;
    gap: 2px;
  }

  .segment-btn {
    padding: 8px 16px;
    background: transparent;
    border: none;
    border-radius: 8px;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .segment-btn:hover {
    color: var(--text-primary);
  }

  .segment-btn.active {
    background: var(--bg-primary);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .filter-sort-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .sort-label {
    font-size: 13px;
    color: var(--text-tertiary);
    font-weight: 500;
  }

  .sort-select {
    padding: 8px 32px 8px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238e8e93' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
  }

  .sort-select:hover {
    border-color: var(--color-primary);
  }

  .sort-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
  }

  /* Transaction List Container */
  .transactions-list-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* Apple Style Transaction Card - 简洁版 */
  .tx-card {
    position: relative;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-xl);
    padding: var(--space-4);
    margin-bottom: var(--space-3);
    transition: all var(--duration-fast) var(--ease-default);
    overflow: hidden;
  }

  .tx-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-primary), var(--color-accent-purple));
    opacity: 0;
  }

  .tx-card:hover {
    border-color: var(--card-border-hover);
    box-shadow: var(--shadow-sm);
  }

  .tx-card:hover::before {
    opacity: 1;
  }

  .tx-card.buy::before {
    background: linear-gradient(90deg, var(--color-success), var(--color-success-light));
  }

  .tx-card.sell::before {
    background: linear-gradient(90deg, var(--color-danger), var(--color-danger-light));
  }

  .tx-card.editing {
    border-color: var(--color-primary);
  }

  .tx-card.editing::before {
    opacity: 1;
    background: linear-gradient(90deg, var(--color-primary), var(--color-accent-purple));
  }

  [data-theme="dark"] .tx-card {
    background: var(--card-bg);
    border-color: var(--card-border);
  }
  
  [data-theme="dark"] .tx-card:hover {
    border-color: var(--card-border-hover);
  }

  /* Card Header */
  .tx-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
  }

  .tx-card-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .tx-sequence {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 20px;
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-tertiary);
    letter-spacing: 0.02em;
  }

  .tx-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    border: 1px solid transparent;
    letter-spacing: -0.01em;
  }

  .tx-type-badge.buy {
    background: linear-gradient(135deg, rgba(48, 209, 88, 0.12) 0%, rgba(48, 209, 88, 0.05) 100%);
    color: #30d158;
    border-color: rgba(48, 209, 88, 0.25);
  }

  .tx-type-badge.sell {
    background: linear-gradient(135deg, rgba(255, 55, 95, 0.12) 0%, rgba(255, 55, 95, 0.05) 100%);
    color: #ff375f;
    border-color: rgba(255, 55, 95, 0.25);
  }

  .tx-type-badge svg {
    width: 14px;
    height: 14px;
  }

  /* Card Body - Row Layout */
  .tx-card-body {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 20px;
  }

  .tx-data-row {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    padding: var(--space-4) var(--space-5);
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-primary);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .tx-data-row:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-secondary);
  }

  .tx-data-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1;
    min-width: 120px;
  }

  .tx-data-item.full-width {
    flex: 0 0 100%;
  }

  .tx-data-label {
    font-size: 11px;
    color: var(--text-tertiary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-family: var(--font-sans);
  }

  .tx-data-value {
    font-family: var(--font-number);
    font-size: 17px;
    font-weight: 600;
    color: var(--text-primary);
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.01em;
  }

  .tx-data-value.profit.positive {
    color: #30d158;
  }

  .tx-data-value.profit.negative {
    color: #ff375f;
  }

  .tx-data-value.profit.neutral {
    color: var(--text-tertiary);
  }

  /* Clickable Cell Content */
  .tx-cell-content {
    font-family: var(--font-number);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    cursor: pointer;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-lg);
    background: var(--bg-tertiary);
    border: 1px solid transparent;
    transition: all var(--duration-fast) var(--ease-default);
    display: inline-block;
    min-width: 100px;
  }

  .tx-cell-content:hover {
    background: var(--bg-secondary);
    border-color: var(--border-primary);
  }

  /* Inline Edit Input */
  .tx-inline-edit {
    font-family: var(--font-number);
    font-size: var(--text-base);
    font-weight: var(--font-medium);
    color: var(--text-primary);
    background: var(--input-bg);
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-2) var(--space-3);
    width: 100%;
    min-width: 120px;
    transition: all var(--duration-fast) var(--ease-default);
    box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
  }

  .tx-inline-edit:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
  }

  .tx-inline-edit.tx-number {
    text-align: right;
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
  }

  /* Card Footer */
  .tx-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-primary);
    margin-top: var(--space-1);
  }

  .tx-time {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-family: var(--font-mono);
    font-weight: var(--font-medium);
  }

  .tx-time svg {
    width: 14px;
    height: 14px;
    opacity: 0.5;
  }

  .tx-actions {
    display: flex;
    gap: var(--space-2);
  }

  /* Action Buttons */
  .tx-action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    border: none;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    letter-spacing: -0.01em;
  }

  .tx-action-btn:hover {
    transform: scale(1.02);
    background: var(--bg-secondary);
  }

  .tx-action-btn:active {
    transform: scale(0.98);
  }

  .tx-action-btn.save {
    background: linear-gradient(135deg, rgba(48, 209, 88, 0.12), rgba(48, 209, 88, 0.05));
    color: var(--color-success);
  }

  .tx-action-btn.save:hover {
    background: linear-gradient(135deg, rgba(48, 209, 88, 0.2), rgba(48, 209, 88, 0.1));
    box-shadow: 0 2px 8px rgba(48, 209, 88, 0.2);
  }

  .tx-action-btn.delete {
    background: rgba(255, 55, 95, 0.08);
    color: var(--color-danger);
  }

  .tx-action-btn.delete:hover {
    background: rgba(255, 55, 95, 0.15);
    box-shadow: 0 2px 8px rgba(255, 55, 95, 0.15);
  }

  .tx-action-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Empty State */
  .tx-empty-table {
    padding: var(--space-16) var(--space-8);
    text-align: center;
    background: var(--bg-secondary);
    border-radius: var(--radius-2xl);
    border: 2px dashed var(--border-primary);
  }

  .tx-empty-table-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto var(--space-4);
    color: var(--text-quaternary);
    opacity: 0.5;
  }

  .tx-empty-table-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .tx-empty-table-desc {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }

  /* Skeleton Loading */
  .tx-skeleton {
    background: var(--bg-secondary);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    border: 1px solid var(--border-primary);
    animation: skeleton-pulse 1.5s ease-in-out infinite;
  }

  .tx-skeleton-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-5);
  }

  .tx-skeleton-badge {
    width: 60px;
    height: 24px;
    background: var(--border-primary);
    border-radius: 20px;
  }

  .tx-skeleton-status {
    width: 48px;
    height: 20px;
    background: var(--border-primary);
    border-radius: 20px;
  }

  .tx-skeleton-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .tx-skeleton-item {
    height: 40px;
    background: var(--border-primary);
    border-radius: var(--radius-lg);
  }

  @keyframes skeleton-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Delete Confirm Modal */
  .delete-confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1100;
    padding: var(--space-5);
  }

  .delete-confirm-modal.hidden {
    display: none;
  }

  .delete-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    animation: fadeIn var(--duration-fast) var(--ease-default);
  }

  .delete-modal-content {
    position: relative;
    width: 100%;
    max-width: 340px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-8);
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
  }

  .delete-modal-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto var(--space-4);
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 55, 95, 0.1);
    border-radius: 50%;
    color: var(--color-danger);
  }

  .delete-modal-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .delete-modal-desc {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: var(--space-6);
  }

  .delete-modal-actions {
    display: flex;
    gap: var(--space-3);
  }

  .delete-modal-btn {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    border: none;
  }

  .delete-modal-btn.cancel {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .delete-modal-btn.cancel:hover {
    background: var(--bg-secondary);
  }

  .delete-modal-btn.confirm {
    background: var(--color-danger);
    color: white;
  }

  .delete-modal-btn.confirm:hover {
    background: #ff453a;
    transform: translateY(-1px);
  }

  /* Edit Transaction Modal */
  .edit-transaction-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1100;
    padding: var(--space-5);
  }

  .edit-transaction-modal.hidden {
    display: none;
  }

  .edit-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    animation: fadeIn var(--duration-fast) var(--ease-default);
  }

  .edit-modal-content {
    position: relative;
    width: 100%;
    max-width: 480px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
    overflow: hidden;
  }

  .edit-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-5) var(--space-6);
    border-bottom: 1px solid var(--border-primary);
  }

  .edit-modal-header h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin: 0;
  }

  #edit-transaction-form {
    padding: var(--space-6);
  }

  .edit-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .edit-form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .edit-form-group label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
  }

  .edit-form-group input {
    padding: var(--space-3) var(--space-4);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: all var(--duration-fast) var(--ease-default);
  }

  .edit-form-group input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
  }

  .edit-form-actions {
    display: flex;
    gap: var(--space-3);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-primary);
  }

  .edit-form-btn {
    flex: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
    border: none;
  }

  .edit-form-btn.cancel {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .edit-form-btn.cancel:hover {
    background: var(--bg-secondary);
  }

  .edit-form-btn.save {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent-blue) 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
  }

  .edit-form-btn.save:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 113, 227, 0.4);
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-4);
      padding: var(--space-4);
    }

    .header-actions {
      width: 100%;
      flex-direction: column;
      gap: var(--space-3);
    }

    .gold-price-widget {
      width: 100%;
      min-width: unset;
    }

    .logout-btn {
      width: 100%;
      justify-content: center;
    }

    .transactions-section {
      padding: var(--space-5);
      border-radius: var(--radius-2xl);
    }

    .filter-bar {
      flex-direction: column;
      align-items: stretch;
      padding: var(--space-3) var(--space-4);
    }

    .filter-segment-control {
      width: 100%;
      justify-content: center;
    }

    .filter-sort-wrapper {
      width: 100%;
      justify-content: center;
    }

    .tx-card {
      padding: var(--space-4);
      border-radius: var(--radius-2xl);
    }

    .tx-data-row {
      padding: var(--space-3) var(--space-4);
    }

    .tx-card-footer {
      flex-direction: column;
      gap: var(--space-3);
      align-items: stretch;
    }

    .tx-actions {
      justify-content: flex-end;
    }

    .edit-form-grid {
      grid-template-columns: 1fr;
    }

    .tx-section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .add-transaction-btn span {
      display: none;
    }

    .add-transaction-btn {
      padding: var(--space-2);
    }
  }

  @media (max-width: 480px) {
    .tx-data-row {
      flex-direction: column;
      gap: var(--space-3);
    }

    .tx-data-item {
      min-width: 100%;
    }

    .tx-data-value,
    .tx-cell-content {
      font-size: var(--text-base);
    }

    .tx-action-btn {
      padding: var(--space-2) var(--space-3);
    }

    .tx-action-btn span {
      display: none;
    }
  }

  /* Add Transaction Modal */
  .add-transaction-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: var(--space-5);
  }

  .add-transaction-modal.hidden {
    display: none;
  }

  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    animation: fadeIn var(--duration-fast) var(--ease-default);
  }

  .modal-content {
    position: relative;
    width: 100%;
    max-width: 480px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-5) var(--space-6);
    border-bottom: 1px solid var(--border-primary);
  }

  .modal-header h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin: 0;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
  }

  .modal-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  #add-transaction-form {
    padding: var(--space-6);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
  }

  #add-transaction-form .form-group {
    margin-bottom: var(--space-4);
  }

  #add-transaction-form label {
    display: block;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
  }

  #add-transaction-form input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-base);
    transition: all var(--duration-fast) var(--ease-default);
  }

  #add-transaction-form input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
  }

  #add-transaction-form input::placeholder {
    color: var(--text-quaternary);
  }

  .required-hint {
    color: var(--color-danger);
    font-weight: var(--font-bold);
    margin-left: 2px;
  }

  .type-toggle {
    display: flex;
    gap: var(--space-2);
  }

  .type-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-secondary);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
  }

  .type-btn:hover {
    border-color: var(--text-tertiary);
  }

  .type-btn.active {
    border-color: var(--color-primary);
    background: rgba(0, 113, 227, 0.1);
    color: var(--color-primary);
  }

  .type-btn[data-type="buy"].active {
    border-color: var(--color-success);
    background: rgba(48, 209, 88, 0.1);
    color: var(--color-success);
  }

  .type-btn[data-type="sell"].active {
    border-color: var(--color-danger);
    background: rgba(255, 55, 95, 0.1);
    color: var(--color-danger);
  }

  .form-actions {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-6);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-primary);
  }

  .btn-cancel,
  .btn-submit {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-default);
  }

  .btn-cancel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
  }

  .btn-cancel:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .btn-submit {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent-blue) 100%);
    border: none;
    color: white;
    box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
  }

  .btn-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 113, 227, 0.4);
  }

  .btn-submit:active {
    transform: translateY(0);
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-6);
  }

  .pagination button {
    padding: var(--space-2) var(--space-3);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    transition: all var(--duration-fast) var(--ease-default);
    cursor: pointer;
  }

  .pagination button:hover:not(:disabled) {
    background: var(--bg-secondary);
    border-color: var(--border-hover);
  }

  .pagination button.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Charts Section */
  .charts-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
  }

  @media (max-width: 768px) {
    .charts-section {
      grid-template-columns: 1fr;
    }
  }

  .chart-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    transition: all var(--duration-fast) var(--ease-default);
    position: relative;
    overflow: hidden;
  }

  .chart-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-primary), var(--color-accent-purple));
    opacity: 0;
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .chart-card:hover {
    box-shadow: var(--shadow-sm);
    border-color: var(--border-hover);
  }

  .chart-card:hover::before {
    opacity: 1;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .chart-title {
    font-size: 17px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chart-subtitle {
    font-size: 12px;
    color: var(--text-tertiary);
  }

  .chart-legend {
    display: flex;
    gap: 16px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .legend-dot.buy {
    background: #30d158;
  }

  .legend-dot.sell {
    background: #ff375f;
  }

  .chart-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: var(--text-tertiary);
    font-size: 14px;
  }

  .chart-loading.hidden {
    display: none;
  }

  .loading-spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border-primary);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .chart-container {
    height: 220px;
    display: flex;
    align-items: flex-end;
    gap: 6px;
    padding: 16px 0;
    position: relative;
  }

  .chart-bar-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    justify-content: flex-end;
    position: relative;
  }

  .chart-bar-group {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    width: 100%;
    justify-content: center;
    flex: 1;
  }

  .chart-bar {
    width: 16px;
    border-radius: 4px 4px 0 0;
    min-height: 4px;
    transition: all 0.2s ease;
    position: relative;
    cursor: pointer;
  }

  .chart-bar:hover {
    opacity: 0.85;
  }

  .chart-bar.buy {
    background: linear-gradient(180deg, #30d158, #30d15880);
  }

  .chart-bar.sell {
    background: linear-gradient(180deg, #ff375f, #ff375f80);
  }

  .chart-bar.profit {
    background: linear-gradient(180deg, var(--color-accent-blue), var(--color-accent-purple));
  }

  .chart-bar.negative {
    background: linear-gradient(180deg, #ff375f, #ff453a);
  }

  .chart-bar-label {
    font-size: 11px;
    color: var(--text-tertiary);
    margin-top: 8px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .chart-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-tertiary);
    gap: 8px;
  }

  .chart-empty svg {
    opacity: 0.5;
  }

  .empty-state {
    text-align: center;
    padding: 48px 32px;
    color: var(--text-tertiary);
    background: var(--bg-secondary);
    border-radius: 20px;
    border: 2px dashed var(--border-primary);
    margin: 16px;
  }

  .empty-state svg {
    margin-bottom: 16px;
    opacity: 0.5;
    color: var(--text-tertiary);
  }

  .empty-state p {
    font-size: 15px;
    font-weight: 500;
  }
</style>

<script>
  const API_BASE = 'https://api.ustc.dev';

  // Client-side authentication check via localStorage (统一使用 localStorage)
  function getTradingToken() {
    return localStorage.getItem('trading_token');
  }

  function hasValidToken() {
    return !!getTradingToken();
  }

  function setTradingToken(token) {
    if (token) {
      localStorage.setItem('trading_token', token);
    } else {
      localStorage.removeItem('trading_token');
    }
  }

  async function verifyAuth() {
    try {
      const result = await apiRequest('/api/trading/stats');
      return result.success !== false && !result.needLogin;
    } catch (error) {
      console.error('[Auth] Verification failed:', error);
      return false;
    }
  }

  const loginSection = document.getElementById('login-section');
  const dashboardSection = document.getElementById('dashboard-section');
  const loginForm = document.getElementById('trading-login-form');
  const buyForm = document.getElementById('buy-form');
  const sellForm = document.getElementById('sell-form');
  const alertForm = document.getElementById('alert-form');

  let currentPage = 1;
  let totalPages = 1;

  function showLogin() {
    loginSection?.classList.remove('hidden');
    dashboardSection?.classList.add('hidden');
  }

  function showDashboard() {
    loginSection?.classList.add('hidden');
    dashboardSection?.classList.remove('hidden');
    loadDashboard();
  }

  async function initApp() {
    const hasToken = hasValidToken();
    
    if (hasToken) {
      const isValid = await verifyAuth();
      if (isValid) {
        showDashboard();
      } else {
        console.log('[Init] Token invalid or expired, showing login');
        showLogin();
      }
    } else {
      showLogin();
    }
  }

  function formatCurrency(value) {
    const num = parseFloat(value) || 0;
    return `¥${num.toFixed(2)}`;
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('zh-CN', {
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  async function apiRequest(endpoint, options = {}) {
    const url = `${API_BASE}${endpoint}`;
    console.log(`[API] ${options.method || 'GET'} ${url}`);
    if (options.body) {
      console.log(`[API] Request body:`, options.body);
    }
    
    const token = getTradingToken();
    const headers = {
      'Content-Type': 'application/json',
      ...options.headers
    };
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }
    
    try {
      const response = await fetch(url, {
        ...options,
        credentials: 'include',
        headers
      });
      
      console.log(`[API] Response status: ${response.status}`);
      
      const text = await response.text();
      console.log(`[API] Response body:`, text);
      
      if (!response.ok) {
        let errorMessage = `HTTP Error: ${response.status}`;
        try {
          const errorData = JSON.parse(text);
          if (errorData.error) {
            errorMessage = errorData.error;
          }
        } catch (e) {
          // Not JSON, use default message
        }
        
        console.error(`[API] Error:`, errorMessage);
        
        if (response.status === 401) {
          return { success: false, error: '登录已过期，请重新登录', needLogin: true };
        }
        
        return { success: false, error: errorMessage };
      }
      
      try {
        const data = JSON.parse(text);
        return data;
      } catch (e) {
        console.error(`[API] Invalid JSON response:`, text);
        return { success: false, error: 'Invalid JSON response' };
      }
    } catch (error) {
      console.error(`[API] Network error:`, error);
      return { success: false, error: error.message || 'Network error' };
    }
  }

  async function loadDashboard() {
    await Promise.all([
      loadStats(),
      loadTransactions(),
      loadAlerts()
    ]);
    // Start gold price auto-refresh separately
    startGoldPriceAutoRefresh();
  }

  let goldPriceInterval = null;
  let lastGoldPrice = null;

  async function loadGoldPrice() {
    const priceEl = document.getElementById('current-gold-price');
    const timeEl = document.getElementById('price-update-time');
    
    if (priceEl) {
      priceEl.classList.add('loading');
    }
    
    try {
      const timestamp = Date.now();
      const url = `${API_BASE}/api/gold?t=${timestamp}`;
      
      console.log('[Gold Price] Fetching from:', url);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      
      const response = await fetch(url, {
        headers: { 
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        },
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const result = await response.json();
      console.log('[Gold Price] API response:', result);
      
      let price = null;
      let source = '';
      
      if (result.success) {
        if (result.domestic?.price && result.domestic.price > 0) {
          price = result.domestic.price.toFixed(2);
          source = 'sge';
        } else if (result.international?.price && result.international.price > 0 && result.exchangeRate) {
          const cnyPrice = result.international.price * result.exchangeRate / 31.1035;
          price = cnyPrice.toFixed(2);
          source = 'international';
        }
        
        if (timeEl && result.timestamp) {
          const updateTime = new Date(result.timestamp);
          timeEl.textContent = updateTime.toLocaleTimeString('zh-CN', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
          });
        }
      }
      
      if (!price) {
        console.log('[Gold Price] Primary API failed, trying backup...');
        try {
          const backupResponse = await fetch('https://hq.sinajs.cn/list=hf_GC', {
            headers: { 'Referer': 'https://finance.sina.com.cn' }
          });
          const text = await backupResponse.text();
          const match = text.match(/"([^"]+)"/);
          if (match) {
            const data = match[1].split(',');
            const usdPrice = parseFloat(data[0]);
            if (usdPrice > 0) {
              price = (usdPrice * 7.2 / 31.1035).toFixed(2);
              source = 'sina';
            }
          }
        } catch (e) {
          console.log('[Gold Price] Backup API failed:', e);
        }
      }
      
      if (price && priceEl) {
        if (lastGoldPrice !== null && lastGoldPrice !== price) {
          priceEl.style.transform = 'scale(1.05)';
          priceEl.style.color = parseFloat(price) > parseFloat(lastGoldPrice) ? '#30d158' : '#ff375f';
          setTimeout(() => {
            priceEl.style.transform = 'scale(1)';
            priceEl.style.color = '#ffb800';
          }, 500);
        }
        
        lastGoldPrice = price;
        priceEl.textContent = price;
        priceEl.classList.remove('loading', 'error');
        
        console.log(`[Gold Price] Loaded from ${source}: ¥${price}`);
      } else {
        throw new Error('No price data available');
      }
    } catch (error) {
      console.error('[Gold Price] Failed to load:', error);
      if (priceEl) {
        if (lastGoldPrice) {
          priceEl.textContent = lastGoldPrice;
          console.log('[Gold Price] Using cached price:', lastGoldPrice);
        } else {
          priceEl.textContent = '获取失败';
          priceEl.classList.add('error');
        }
        priceEl.classList.remove('loading');
      }
    }
  }

  function startGoldPriceAutoRefresh() {
    // Load immediately
    loadGoldPrice();
    
    // Refresh every 10 seconds
    if (goldPriceInterval) {
      clearInterval(goldPriceInterval);
    }
    goldPriceInterval = setInterval(loadGoldPrice, 10000);
  }

  function stopGoldPriceAutoRefresh() {
    if (goldPriceInterval) {
      clearInterval(goldPriceInterval);
      goldPriceInterval = null;
    }
  }

  function validateStatsData(stats) {
    if (!stats) return { valid: false, reason: 'stats is null or undefined' };
    
    const requiredFields = ['total', 'week', 'month', 'weekly', 'monthly'];
    for (const field of requiredFields) {
      if (stats[field] === undefined) {
        return { valid: false, reason: `missing field: ${field}` };
      }
    }

    if (stats.total) {
      const totalFields = ['buy', 'sell', 'profit', 'quantityBought', 'quantitySold'];
      for (const field of totalFields) {
        if (typeof stats.total[field] !== 'number') {
          return { valid: false, reason: `invalid total.${field}: expected number, got ${typeof stats.total[field]}` };
        }
      }
    }

    return { valid: true };
  }

  function renderEmptyStats() {
    document.getElementById('stat-total-profit').textContent = '¥0.00';
    document.getElementById('stat-month-profit').textContent = '¥0.00';
    document.getElementById('stat-week-profit').textContent = '¥0.00';
    document.getElementById('stat-total-quantity').textContent = '0.000g';
  }

  async function loadStats() {
    const weeklyLoading = document.getElementById('weekly-loading');
    const monthlyLoading = document.getElementById('monthly-loading');
    const weeklyChart = document.getElementById('weekly-chart');
    const monthlyChart = document.getElementById('monthly-chart');

    try {
      if (weeklyLoading) weeklyLoading.classList.remove('hidden');
      if (monthlyLoading) monthlyLoading.classList.remove('hidden');
      
      const result = await apiRequest('/api/trading/stats');
      
      if (!result.success) {
        const errorMsg = result.error || 'Unknown error';
        console.error('[loadStats] API returned error:', errorMsg);
        
        if (result.needLogin || errorMsg.includes('登录') || errorMsg.includes('Token') || errorMsg.includes('auth')) {
          console.warn('[loadStats] Authentication error, redirecting to login...');
          showLogin();
          return;
        }
        
        renderEmptyStats();
        renderCharts({ total: { profit: 0, buy: 0, sell: 0, quantityBought: 0, quantitySold: 0 }, week: { profit: 0 }, month: { profit: 0 }, weekly: [], monthly: [] });
        return;
      }
      
      const stats = result.stats;
      const validation = validateStatsData(stats);
      
      if (!validation.valid) {
        console.warn('[loadStats] Data validation failed:', validation.reason);
        console.warn('[loadStats] Received stats:', JSON.stringify(stats, null, 2));
        renderEmptyStats();
        renderCharts({ total: { profit: 0, buy: 0, sell: 0, quantityBought: 0, quantitySold: 0 }, week: { profit: 0 }, month: { profit: 0 }, weekly: [], monthly: [] });
        return;
      }

      document.getElementById('stat-total-profit').textContent = formatCurrency(stats.total.profit);
      document.getElementById('stat-month-profit').textContent = formatCurrency(stats.month.profit);
      document.getElementById('stat-week-profit').textContent = formatCurrency(stats.week.profit);
      
      const holdings = stats.total.quantityBought - stats.total.quantitySold;
      document.getElementById('stat-total-quantity').textContent = `${holdings.toFixed(3)}g`;

      renderCharts(stats);
    } catch (error) {
      console.error('[loadStats] Exception:', error);
      renderEmptyStats();
      const emptyStats = { total: { profit: 0, buy: 0, sell: 0, quantityBought: 0, quantitySold: 0 }, week: { profit: 0 }, month: { profit: 0 }, weekly: [], monthly: [] };
      renderCharts(emptyStats);
    } finally {
      if (weeklyLoading) weeklyLoading.classList.add('hidden');
      if (monthlyLoading) monthlyLoading.classList.add('hidden');
    }
  }

  function renderCharts(stats) {
    const weeklyChart = document.getElementById('weekly-chart');
    const monthlyChart = document.getElementById('monthly-chart');

    renderWeeklyChart(weeklyChart, stats.weekly || []);
    renderMonthlyChart(monthlyChart, stats.monthly || []);
  }

  function renderWeeklyChart(container, weeklyData) {
    if (!container) return;

    if (!weeklyData || weeklyData.length === 0) {
      const emptyMsg = '暂无本周数据';
      container.innerHTML = `
        <div class="chart-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
          <span>${emptyMsg}</span>
        </div>
      `;
      return;
    }

    const reversedData = [...weeklyData].reverse();
    const maxAmount = Math.max(
      ...reversedData.flatMap(d => [Math.abs(d.buy_amount || 0), Math.abs(d.sell_amount || 0)]),
      1
    );

    container.innerHTML = reversedData.map(d => {
      const buyHeight = ((d.buy_amount || 0) / maxAmount) * 160;
      const sellHeight = ((d.sell_amount || 0) / maxAmount) * 160;
      const dateLabel = d.date ? new Date(d.date).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }) : '';
      const buyLabel = '买入';
      const sellLabel = '卖出';
      
      return `
        <div class="chart-bar-wrapper">
          <div class="chart-bar-group">
            <div class="chart-bar buy" style="height: ${Math.max(buyHeight, 4)}px" 
                 data-value="${buyLabel}: ${formatCurrency(d.buy_amount || 0)}"
                 data-info='${JSON.stringify({ date: dateLabel, buy: d.buy_amount || 0, sell: d.sell_amount || 0, profit: d.profit || 0 })}'></div>
            <div class="chart-bar sell" style="height: ${Math.max(sellHeight, 4)}px"
                 data-value="${sellLabel}: ${formatCurrency(d.sell_amount || 0)}"
                 data-info='${JSON.stringify({ date: dateLabel, buy: d.buy_amount || 0, sell: d.sell_amount || 0, profit: d.profit || 0 })}'></div>
          </div>
          <div class="chart-bar-label">${dateLabel}</div>
        </div>
      `;
    }).join('');

    container.querySelectorAll('.chart-bar').forEach(bar => {
      bar.addEventListener('mouseenter', showWeeklyTooltip);
      bar.addEventListener('mouseleave', hideTooltip);
    });
  }

  function showWeeklyTooltip(event) {
    const info = event.target.dataset.info ? JSON.parse(event.target.dataset.info) : {};
    const tooltip = document.getElementById('weekly-tooltip');
    if (!tooltip) return;

    const buyLabel = '买入金额';
    const sellLabel = '卖出金额';
    const profitLabel = '收益';

    tooltip.innerHTML = `
      <div class="tooltip-title">${info.date || '-'}</div>
      <div class="tooltip-row">
        <span class="tooltip-label">${buyLabel}</span>
        <span class="tooltip-value buy">${formatCurrency(info.buy || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">${sellLabel}</span>
        <span class="tooltip-value sell">${formatCurrency(info.sell || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">${profitLabel}</span>
        <span class="tooltip-value ${(info.profit || 0) >= 0 ? 'buy' : 'sell'}">${formatCurrency(info.profit || 0)}</span>
      </div>
    `;
    
    const rect = event.target.getBoundingClientRect();
    const container = document.getElementById('weekly-chart').getBoundingClientRect();
    tooltip.style.left = `${rect.left - container.left + rect.width / 2}px`;
    tooltip.style.top = `${rect.top - container.top - 10}px`;
    tooltip.style.transform = 'translate(-50%, -100%)';
    tooltip.classList.add('visible');
  }

  function renderMonthlyChart(container, monthlyData) {
    if (!container) return;

    if (!monthlyData || monthlyData.length === 0) {
      const emptyMsg = '暂无月度数据';
      container.innerHTML = `
        <div class="chart-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span>${emptyMsg}</span>
        </div>
      `;
      return;
    }

    const reversedData = [...monthlyData].reverse();

    container.innerHTML = `
      <div style="display: flex; gap: 12px; justify-content: space-around; width: 100%; align-items: flex-end;">
        ${reversedData.map(d => {
          const profit = d.profit || 0;
          const profitClass = profit >= 0 ? 'positive' : 'negative';
          const weekLabel = `第${d.week}周`;
          const dateRange = d.week_start ? `${new Date(d.week_start).getMonth() + 1}/${new Date(d.week_start).getDate()}` : '';
          
          return `
            <div class="monthly-chart-item" data-info='${JSON.stringify(d)}'>
              <span class="monthly-week-label">${weekLabel}</span>
              <span class="monthly-profit ${profitClass}">${formatCurrency(profit)}</span>
              <div class="monthly-stats">
                <span class="monthly-stat buy">↑ ${d.buy_count || 0}</span>
                <span class="monthly-stat sell">↓ ${d.sell_count || 0}</span>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;

    container.querySelectorAll('.monthly-chart-item').forEach(item => {
      item.addEventListener('mouseenter', showMonthlyTooltip);
      item.addEventListener('mouseleave', hideTooltip);
    });
  }

  function showMonthlyTooltip(event) {
    const info = event.currentTarget.dataset.info ? JSON.parse(event.currentTarget.dataset.info) : {};
    const tooltip = document.getElementById('monthly-tooltip');
    if (!tooltip) return;

    const weekLabel = `第${info.week}周`;
    const buyLabel = '买入金额';
    const sellLabel = '卖出金额';
    const profitLabel = '收益';
    const buyCountLabel = '买入次数';
    const sellCountLabel = '卖出次数';
    const timesLabel = '次';

    tooltip.innerHTML = `
      <div class="tooltip-title">${weekLabel} (${info.week_start || '-'})</div>
      <div class="tooltip-row">
        <span class="tooltip-label">${buyLabel}</span>
        <span class="tooltip-value buy">${formatCurrency(info.buy_amount || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">${sellLabel}</span>
        <span class="tooltip-value sell">${formatCurrency(info.sell_amount || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">${profitLabel}</span>
        <span class="tooltip-value ${(info.profit || 0) >= 0 ? 'buy' : 'sell'}">${formatCurrency(info.profit || 0)}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">${buyCountLabel}</span>
        <span class="tooltip-value">${info.buy_count || 0}${timesLabel}</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">${sellCountLabel}</span>
        <span class="tooltip-value">${info.sell_count || 0}${timesLabel}</span>
      </div>
    `;
    
    const rect = event.currentTarget.getBoundingClientRect();
    const container = document.getElementById('monthly-chart').getBoundingClientRect();
    tooltip.style.left = `${rect.left - container.left + rect.width / 2}px`;
    tooltip.style.top = `${rect.top - container.top - 10}px`;
    tooltip.style.transform = 'translate(-50%, -100%)';
    tooltip.classList.add('visible');
  }

  function hideTooltip() {
    document.querySelectorAll('.chart-tooltip').forEach(t => t.classList.remove('visible'));
  }

  let totalTransactionCount = 0;
  let currentFilterType = '';
  let pendingDeleteId = null;

  async function loadTransactions(page = 1) {
    const list = document.getElementById('transactions-list');
    const pagination = document.getElementById('pagination');

    if (list) {
      list.innerHTML = Array(3).fill(0).map(() => `
        <div class="tx-skeleton">
          <div class="tx-skeleton-header">
            <div class="tx-skeleton-badge"></div>
            <div class="tx-skeleton-status"></div>
          </div>
          <div class="tx-skeleton-grid">
            ${Array(4).fill(0).map(() => `<div class="tx-skeleton-item"></div>`).join('')}
          </div>
        </div>
      `).join('');
    }
    if (pagination) pagination.innerHTML = '';

    try {
      const sort = document.getElementById('filter-sort')?.value || 'desc';

      let url = `/api/trading/transactions?page=${page}&limit=10&sortOrder=${sort}`;
      if (currentFilterType) url += `&type=${currentFilterType}`;

      const result = await apiRequest(url);
      if (result.success) {
        totalTransactionCount = result.pagination?.total || 0;
        renderTransactions(result.transactions, page);
        renderPagination(result.pagination);
      } else if (result.needLogin) {
        showLogin();
        return;
      } else {
        const errorMsg = '加载失败';
        if (list) {
          list.innerHTML = `
            <div class="tx-empty-table">
              <svg class="tx-empty-table-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <div class="tx-empty-table-title">${errorMsg}</div>
              <div class="tx-empty-table-desc">${result.error || '未知错误'}</div>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('Failed to load transactions:', error);
      const errorMsg = '网络错误';
      if (list) {
        list.innerHTML = `
          <div class="tx-empty-table">
            <svg class="tx-empty-table-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <div class="tx-empty-table-title">${errorMsg}</div>
            <div class="tx-empty-table-desc">请检查连接后重试</div>
          </div>
        `;
      }
    }
  }

  function calculateSequence(index, page) {
    const itemsPerPage = 10;
    const globalIndex = (page - 1) * itemsPerPage + index + 1;
    return `#${String(globalIndex).padStart(3, '0')}`;
  }

  function formatTableDate(dateStr) {
    const date = new Date(dateStr);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const min = String(date.getMinutes()).padStart(2, '0');
    return `${month}/${day} ${hour}:${min}`;
  }

  // Store editing state
  let editingRows = new Map();
  let editedValues = new Map();

  function renderTransactions(transactions, page = 1) {
    const list = document.getElementById('transactions-list');
    if (!list) return;

    if (!transactions?.length) {
      list.innerHTML = `
        <div class="tx-empty-table">
          <svg class="tx-empty-table-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
          <div class="tx-empty-table-title">暂无交易记录</div>
          <div class="tx-empty-table-desc">开始记录您的第一笔交易吧</div>
        </div>
      `;
      return;
    }

    list.innerHTML = transactions.map((t, index) => {
      const isBuy = t.type === 'buy';
      const profitValue = parseFloat(t.profit) || 0;
      const profitClass = profitValue > 0 ? 'positive' : profitValue < 0 ? 'negative' : 'neutral';
      const sequence = calculateSequence(index, page);
      
      const buyPrice = isBuy ? t.price : (t.original_buy_price || t.price);
      const buyQty = isBuy ? t.quantity : (t.original_quantity || t.quantity);
      const sellPrice = isBuy ? '-' : (t.actual_sell_price || t.price);
      const sellQty = isBuy ? '-' : t.quantity;
      const platform = t.notes || t.platform || '-';

      const isEditing = editingRows.has(t.id);

      return `
        <div class="tx-card ${t.type} ${isEditing ? 'editing' : ''}" data-id="${t.id}" data-index="${index}">
          <div class="tx-card-header">
            <div class="tx-card-left">
              <span class="tx-sequence">${sequence}</span>
              <span class="tx-type-badge ${t.type}">
                ${isBuy ? `
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                ` : `
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                `}
                ${isBuy ? '买入' : '卖出'}
              </span>
            </div>
          </div>
          
          <div class="tx-card-body">
            <!-- Row 1: Time -->
            <div class="tx-data-row">
              <div class="tx-data-item full-width">
                <span class="tx-data-label">交易时间</span>
                ${isEditing ? 
                  `<input type="datetime-local" class="tx-inline-edit" value="${formatDateTimeLocal(t.created_at)}" data-field="created_at" data-id="${t.id}">` :
                  `<span class="tx-cell-content" onclick="startInlineEdit(${t.id}, 'created_at')">${formatTableDate(t.created_at)}</span>`
                }
              </div>
            </div>
            
            <!-- Row 2: Buy Info -->
            <div class="tx-data-row">
              <div class="tx-data-item">
                <span class="tx-data-label">买入价格</span>
                ${isEditing ? 
                  `<input type="number" step="0.01" class="tx-inline-edit tx-number" value="${buyPrice !== '-' ? parseFloat(buyPrice).toFixed(2) : ''}" data-field="buy_price" data-id="${t.id}" placeholder="0.00">` :
                  `<span class="tx-cell-content" onclick="startInlineEdit(${t.id}, 'buy_price')">${isBuy ? `¥${t.price.toFixed(2)}` : (buyPrice !== '-' ? `¥${parseFloat(buyPrice).toFixed(2)}` : '-')}</span>`
                }
              </div>
              <div class="tx-data-item">
                <span class="tx-data-label">买入数量</span>
                ${isEditing ? 
                  `<input type="number" step="0.001" class="tx-inline-edit tx-number" value="${buyQty !== '-' ? parseFloat(buyQty).toFixed(3) : ''}" data-field="buy_qty" data-id="${t.id}" placeholder="0.000">` :
                  `<span class="tx-cell-content" onclick="startInlineEdit(${t.id}, 'buy_qty')">${buyQty !== '-' ? `${parseFloat(buyQty).toFixed(3)}g` : '-'}</span>`
                }
              </div>
            </div>
            
            <!-- Row 3: Sell Info -->
            ${!isBuy ? `
            <div class="tx-data-row">
              <div class="tx-data-item">
                <span class="tx-data-label">卖出价格</span>
                ${isEditing ? 
                  `<input type="number" step="0.01" class="tx-inline-edit tx-number" value="${sellPrice !== '-' ? parseFloat(sellPrice).toFixed(2) : ''}" data-field="sell_price" data-id="${t.id}" placeholder="0.00">` :
                  `<span class="tx-cell-content" onclick="startInlineEdit(${t.id}, 'sell_price')">${sellPrice !== '-' ? `¥${parseFloat(sellPrice).toFixed(2)}` : '-'}</span>`
                }
              </div>
              <div class="tx-data-item">
                <span class="tx-data-label">卖出数量</span>
                ${isEditing ? 
                  `<input type="number" step="0.001" class="tx-inline-edit tx-number" value="${sellQty !== '-' ? parseFloat(sellQty).toFixed(3) : ''}" data-field="sell_qty" data-id="${t.id}" placeholder="0.000">` :
                  `<span class="tx-cell-content" onclick="startInlineEdit(${t.id}, 'sell_qty')">${sellQty !== '-' ? `${parseFloat(sellQty).toFixed(3)}g` : '-'}</span>`
                }
              </div>
            </div>
            ` : ''}
            
            <!-- Row 4: Profit & Platform -->
            <div class="tx-data-row">
              <div class="tx-data-item">
                <span class="tx-data-label">收益</span>
                ${isEditing ? 
                  `<input type="number" step="0.01" class="tx-inline-edit tx-number" value="${!isBuy && t.profit ? parseFloat(t.profit).toFixed(2) : ''}" data-field="profit" data-id="${t.id}" placeholder="0.00">` :
                  `<span class="tx-data-value profit ${profitClass}" onclick="startInlineEdit(${t.id}, 'profit')">${isBuy ? '-' : formatCurrency(t.profit)}</span>`
                }
              </div>
              <div class="tx-data-item">
                <span class="tx-data-label">交易平台</span>
                ${isEditing ? 
                  `<input type="text" class="tx-inline-edit" value="${platform !== '-' ? platform : ''}" data-field="platform" data-id="${t.id}" placeholder="平台">` :
                  `<span class="tx-cell-content" onclick="startInlineEdit(${t.id}, 'platform')" title="${platform}">${platform}</span>`
                }
              </div>
            </div>
          </div>
          
          <div class="tx-card-footer">
            <div class="tx-time">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              ${formatTableDate(t.created_at)}
            </div>
            <div class="tx-actions">
              ${isEditing ? `
                <button class="tx-action-btn save" onclick="saveInlineEdit(${t.id})" title="保存">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <span>保存</span>
                </button>
              ` : ''}
              <button class="tx-action-btn delete" onclick="openDeleteModal(${t.id})" title="删除">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                <span>删除</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Add event listeners to inputs
    document.querySelectorAll('.tx-inline-edit').forEach(input => {
      input.addEventListener('blur', handleInputBlur);
      input.addEventListener('keydown', handleInputKeydown);
    });
  }

  function formatDateTimeLocal(dateStr) {
    const date = new Date(dateStr);
    return date.toISOString().slice(0, 16);
  }

  function startInlineEdit(id, field) {
    // If already editing another card, cancel it first instead of saving
    if (editingRows.size > 0 && !editingRows.has(id)) {
      const currentEditingId = Array.from(editingRows.keys())[0];
      cancelInlineEdit(currentEditingId);
    }
    
    // If clicking on the same card that's already in edit mode, do nothing
    if (editingRows.has(id)) {
      return;
    }
    
    editingRows.set(id, field);
    // Reload current page to show edit mode
    loadTransactions(currentPage);
    
    // Focus the input after render
    setTimeout(() => {
      const input = document.querySelector(`.tx-card[data-id="${id}"] .tx-inline-edit[data-field="${field}"]`);
      if (input) {
        input.focus();
        input.select();
      }
    }, 10);
  }

  function handleInputBlur(e) {
    const input = e.target;
    const id = parseInt(input.dataset.id);
    const field = input.dataset.field;
    const value = input.value;
    
    // Store the edited value
    if (!editedValues.has(id)) {
      editedValues.set(id, {});
    }
    editedValues.get(id)[field] = value;
  }

  function handleInputKeydown(e) {
    const input = e.target;
    const id = parseInt(input.dataset.id);
    
    if (e.key === 'Enter') {
      e.preventDefault();
      saveInlineEdit(id);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelInlineEdit(id);
    }
  }

  function cancelInlineEdit(id) {
    editingRows.delete(id);
    editedValues.delete(id);
    loadTransactions(currentPage);
  }

  async function saveInlineEdit(id) {
    const card = document.querySelector(`.tx-card[data-id="${id}"]`);
    if (!card) return;

    const inputs = card.querySelectorAll('.tx-inline-edit');
    const updates = {};
    
    inputs.forEach(input => {
      const field = input.dataset.field;
      const value = input.value;
      
      if (field === 'created_at') {
        if (value) updates.createdAt = value;
      } else if (field === 'buy_price') {
        if (value) updates.price = parseFloat(value);
      } else if (field === 'buy_qty') {
        if (value) updates.quantity = parseFloat(value);
      } else if (field === 'sell_price') {
        if (value) updates.actualSellPrice = parseFloat(value);
      } else if (field === 'sell_qty') {
        if (value) updates.quantity = parseFloat(value);
      } else if (field === 'profit') {
        if (value) updates.profit = parseFloat(value);
      } else if (field === 'platform') {
        updates.notes = value || null;
      }
    });

    const saveBtn = card.querySelector('.tx-action-btn.save');
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.innerHTML = `<svg class="spinner" width="14" height="14" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg><span>保存中</span>`;
    }

    try {
      const result = await apiRequest(`/api/trading/transaction?id=${id}`, {
        method: 'PUT',
        body: JSON.stringify(updates)
      });

      if (result.success) {
        editingRows.delete(id);
        editedValues.delete(id);
        
        await loadTransactions(currentPage);
        
        if (updates.profit !== undefined) {
          await syncProfitToSummary();
        }
        
        await loadStats();
      } else {
        alert(result.error || '保存失败');
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg><span>保存</span>`;
        }
      }
    } catch (error) {
      console.error('Save failed:', error);
      alert('保存失败');
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg><span>保存</span>`;
      }
    }
  }

  async function syncProfitToSummary() {
    // Trigger stats reload to update profit summary
    await loadStats();
  }

  function openDeleteModal(id) {
    pendingDeleteId = id;
    const modal = document.getElementById('delete-confirm-modal');
    modal?.classList.remove('hidden');
  }

  function closeDeleteModal() {
    pendingDeleteId = null;
    const modal = document.getElementById('delete-confirm-modal');
    modal?.classList.add('hidden');
  }

  async function confirmDelete() {
    if (!pendingDeleteId) return;
    
    const confirmBtn = document.getElementById('delete-confirm-btn');
    if (confirmBtn) {
      (confirmBtn as HTMLButtonElement).disabled = true;
      confirmBtn.innerHTML = `<span class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>`;
    }

    try {
      const result = await apiRequest(`/api/trading/transaction?id=${pendingDeleteId}`, { method: 'DELETE' });
      if (result.success) {
        closeDeleteModal();
        loadDashboard();
      } else {
        alert(result.error || '删除失败');
      }
    } catch (error) {
      console.error('Delete failed:', error);
      alert('删除失败');
    } finally {
      if (confirmBtn) {
        (confirmBtn as HTMLButtonElement).disabled = false;
        confirmBtn.textContent = '删除';
      }
    }
  }

  let currentEditTransaction = null;

  async function openEditModal(id) {
    try {
      const result = await apiRequest(`/api/trading/transactions?page=1&limit=100`);
      if (result.success && result.transactions) {
        currentEditTransaction = result.transactions.find(t => t.id === id);
        if (currentEditTransaction) {
          const t = currentEditTransaction;
          const isBuy = t.type === 'buy';
          
          (document.getElementById('edit-tx-id') as HTMLInputElement).value = String(t.id);
          (document.getElementById('edit-tx-type') as HTMLInputElement).value = t.type;
          
          const date = new Date(t.created_at);
          (document.getElementById('edit-tx-date') as HTMLInputElement).value = date.toISOString().slice(0, 16);
          
          if (isBuy) {
            (document.getElementById('edit-tx-buy-price') as HTMLInputElement).value = String(t.price);
            (document.getElementById('edit-tx-buy-qty') as HTMLInputElement).value = String(t.quantity);
            (document.getElementById('edit-tx-sell-price') as HTMLInputElement).value = '';
            (document.getElementById('edit-tx-sell-qty') as HTMLInputElement).value = '';
          } else {
            (document.getElementById('edit-tx-buy-price') as HTMLInputElement).value = String(t.original_buy_price || t.price);
            (document.getElementById('edit-tx-buy-qty') as HTMLInputElement).value = String(t.original_quantity || t.quantity);
            (document.getElementById('edit-tx-sell-price') as HTMLInputElement).value = String(t.actual_sell_price || t.price);
            (document.getElementById('edit-tx-sell-qty') as HTMLInputElement).value = String(t.quantity);
          }
          (document.getElementById('edit-tx-platform') as HTMLInputElement).value = t.platform || '';
          
          const modal = document.getElementById('edit-transaction-modal');
          modal?.classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error('Failed to load transaction for edit:', error);
    }
  }

  function closeEditModal() {
    currentEditTransaction = null;
    const modal = document.getElementById('edit-transaction-modal');
    modal?.classList.add('hidden');
  }

  async function saveTransactionEdit(e) {
    e.preventDefault();
    
    const id = (document.getElementById('edit-tx-id') as HTMLInputElement).value;
    const type = (document.getElementById('edit-tx-type') as HTMLInputElement).value;
    const date = (document.getElementById('edit-tx-date') as HTMLInputElement).value;
    const buyPrice = parseFloat((document.getElementById('edit-tx-buy-price') as HTMLInputElement).value) || 0;
    const buyQty = parseFloat((document.getElementById('edit-tx-buy-qty') as HTMLInputElement).value) || 0;
    const sellPrice = parseFloat((document.getElementById('edit-tx-sell-price') as HTMLInputElement).value) || 0;
    const sellQty = parseFloat((document.getElementById('edit-tx-sell-qty') as HTMLInputElement).value) || 0;
    const platform = (document.getElementById('edit-tx-platform') as HTMLInputElement).value;

    const submitBtn = document.querySelector('.edit-form-btn.save') as HTMLButtonElement;
    const originalContent = submitBtn?.innerHTML;
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<span class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>`;
    }

    try {
      const payload: any = {
        date: new Date(date).toISOString(),
        platform
      };

      if (type === 'buy') {
        payload.price = buyPrice;
        payload.quantity = buyQty;
      } else {
        payload.price = buyPrice;
        payload.quantity = sellQty;
        payload.actualSellPrice = sellPrice;
      }

      const result = await apiRequest(`/api/trading/transaction?id=${id}`, {
        method: 'PUT',
        body: JSON.stringify(payload)
      });

      if (result.success) {
        closeEditModal();
        loadDashboard();
      } else {
        alert(result.error || '修改失败');
      }
    } catch (error) {
      console.error('Save edit failed:', error);
      alert('修改失败');
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
      }
    }
  }

  function renderPagination(pagination) {
    const container = document.getElementById('pagination');
    if (!container) return;

    currentPage = pagination.page;
    totalPages = pagination.totalPages;

    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = '';
    
    html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="loadTransactions(${currentPage - 1})">上一页</button>`;
    
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
        html += `<button class="${i === currentPage ? 'active' : ''}" onclick="loadTransactions(${i})">${i}</button>`;
      } else if (i === currentPage - 2 || i === currentPage + 2) {
        html += '<span>...</span>';
      }
    }

    html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="loadTransactions(${currentPage + 1})">下一页</button>`;

    container.innerHTML = html;
  }

  async function loadAlerts() {
    try {
      const result = await apiRequest('/api/trading/alerts');
      if (result.success) {
        renderAlerts(result.alerts);
      } else if (result.needLogin) {
        showLogin();
        return;
      }
    } catch (error) {
      console.error('Failed to load alerts:', error);
    }
  }

  function renderAlerts(alerts) {
    const list = document.getElementById('alert-list');
    if (!list) return;

    if (!alerts?.length) {
      list.innerHTML = '';
      return;
    }

    list.innerHTML = alerts.map(a => `
      <div class="alert-item" data-id="${a.id}">
        <div class="alert-info">
          <span class="alert-type ${a.alert_type}">${a.alert_type === 'buy' ? '买' : '卖'}</span>
          <span class="alert-price">¥${a.target_price}/g</span>
          ${a.tolerance ? `<span class="alert-tolerance">±${a.tolerance}</span>` : ''}
        </div>
        <button class="delete-alert" onclick="deleteAlert(${a.id})">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    `).join('');
  }

  async function deleteTransaction(id) {
    if (!confirm('确定删除此交易记录？')) return;

    try {
      const result = await apiRequest(`/api/trading/transaction?id=${id}`, { method: 'DELETE' });
      if (result.success) {
        loadDashboard();
      } else {
        alert(result.error || 'Delete failed');
      }
    } catch (error) {
      console.error('Delete failed:', error);
      alert('Delete failed');
    }
  }

  document.getElementById('add-transaction-btn')?.addEventListener('click', () => {
    const modal = document.getElementById('add-transaction-modal');
    modal?.classList.remove('hidden');
    document.getElementById('add-date').value = new Date().toISOString().slice(0, 16);
    document.getElementById('add-type').value = 'buy';
    document.querySelectorAll('.type-btn').forEach(btn => {
      btn.classList.toggle('active', btn.getAttribute('data-type') === 'buy');
    });
    document.getElementById('add-buy-price').value = '';
    document.getElementById('add-sell-price').value = '';
    document.getElementById('add-quantity').value = '';
    document.getElementById('add-platform').value = '';
  });

  document.getElementById('add-modal-close')?.addEventListener('click', () => {
    document.getElementById('add-transaction-modal')?.classList.add('hidden');
  });

  document.getElementById('add-modal-backdrop')?.addEventListener('click', () => {
    document.getElementById('add-transaction-modal')?.classList.add('hidden');
  });

  document.getElementById('add-cancel-btn')?.addEventListener('click', () => {
    document.getElementById('add-transaction-modal')?.classList.add('hidden');
  });

  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.getAttribute('data-type');
      document.getElementById('add-type').value = type;
      document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      const buyPriceGroup = document.getElementById('buy-price-group');
      const sellPriceGroup = document.getElementById('sell-price-group');
      const buyPriceLabel = buyPriceGroup?.querySelector('label');
      const sellPriceLabel = sellPriceGroup?.querySelector('label');
      
      if (type === 'buy') {
        if (buyPriceLabel) buyPriceLabel.innerHTML = '买入价格 (元/克) <span class="required-hint">*</span>';
        if (sellPriceLabel) sellPriceLabel.textContent = '卖出价格 (元/克)';
        (document.getElementById('add-sell-price') as HTMLInputElement).value = '';
      } else {
        if (buyPriceLabel) buyPriceLabel.textContent = '买入价格 (元/克)';
        if (sellPriceLabel) sellPriceLabel.innerHTML = '卖出价格 (元/克) <span class="required-hint">*</span>';
      }
    });
  });

  document.getElementById('add-transaction-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const type = document.getElementById('add-type').value;
    const date = document.getElementById('add-date').value;
    const buyPriceInput = document.getElementById('add-buy-price').value;
    const sellPriceInput = document.getElementById('add-sell-price').value;
    const quantityInput = document.getElementById('add-quantity').value;
    const platform = document.getElementById('add-platform').value;

    const buyPrice = parseFloat(buyPriceInput);
    const sellPrice = parseFloat(sellPriceInput);
    const quantity = parseFloat(quantityInput);

    if (!date) {
      alert('请选择交易时间');
      return;
    }

    if (!quantityInput || isNaN(quantity) || quantity <= 0) {
      alert('请输入有效的数量');
      return;
    }

    if (type === 'buy') {
      if (!buyPriceInput || isNaN(buyPrice) || buyPrice <= 0) {
        alert('请输入有效的买入价格');
        return;
      }
    } else {
      if (!sellPriceInput || isNaN(sellPrice) || sellPrice <= 0) {
        alert('请输入有效的卖出价格');
        return;
      }
    }

    const submitBtn = e.target.querySelector('.btn-submit');
    const originalText = submitBtn?.innerHTML;
    submitBtn.innerHTML = `<span class="loading-spinner" style="width: 16px; height: 16px;"></span>`;
    (submitBtn as HTMLButtonElement).disabled = true;

    try {
      let result;
      if (type === 'buy') {
        result = await apiRequest('/api/trading/buy', {
          method: 'POST',
          body: JSON.stringify({
            price: buyPrice,
            quantity: quantity,
            notes: platform || null
          })
        });
      } else {
        result = await apiRequest('/api/trading/sell', {
          method: 'POST',
          body: JSON.stringify({
            price: sellPrice,
            quantity: quantity,
            notes: platform || null
          })
        });
      }

      if (result.success) {
        document.getElementById('add-transaction-modal')?.classList.add('hidden');
        loadDashboard();
      } else {
        alert(result.error || '保存失败');
      }
    } catch (error) {
      console.error('Add transaction failed:', error);
      alert('保存失败');
    } finally {
      submitBtn.innerHTML = originalText;
      (submitBtn as HTMLButtonElement).disabled = false;
    }
  });

  (window as any).addTransaction = async function(type, date, buyPrice, sellPrice, quantity, platform) {
    try {
      const price = type === 'buy' ? parseFloat(buyPrice) : parseFloat(sellPrice);
      const qty = parseFloat(quantity);
      
      if (isNaN(price) || price <= 0) {
        return { success: false, error: '请输入有效的价格' };
      }
      if (isNaN(qty) || qty <= 0) {
        return { success: false, error: '请输入有效的数量' };
      }
      
      let result;
      if (type === 'buy') {
        result = await apiRequest('/api/trading/buy', {
          method: 'POST',
          body: JSON.stringify({
            price: price,
            quantity: qty,
            notes: platform || null
          })
        });
      } else {
        result = await apiRequest('/api/trading/sell', {
          method: 'POST',
          body: JSON.stringify({
            price: price,
            quantity: qty,
            notes: platform || null
          })
        });
      }

      return result;
    } catch (error) {
      console.error('Add transaction failed:', error);
      return { success: false, error: 'Add transaction failed' };
    }
  };

  async function deleteAlert(id) {
    try {
      const result = await apiRequest(`/api/trading/alert?id=${id}`, { method: 'DELETE' });
      if (result.success) {
        loadAlerts();
      }
    } catch (error) {
      console.error('Delete alert failed:', error);
    }
  }

  document.getElementById('trading-toggle-pwd')?.addEventListener('click', () => {
    const input = document.getElementById('trading-password') as HTMLInputElement;
    const btn = document.getElementById('trading-toggle-pwd');
    const eyeOpen = btn?.querySelector('.eye-open');
    const eyeClosed = btn?.querySelector('.eye-closed');

    if (input?.type === 'password') {
      input.type = 'text';
      eyeOpen?.classList.add('hidden');
      eyeClosed?.classList.remove('hidden');
    } else {
      input.type = 'password';
      eyeOpen?.classList.remove('hidden');
      eyeClosed?.classList.add('hidden');
    }
  });

  loginForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('trading-login-btn');
    const btnText = btn?.querySelector('.btn-text');
    const btnLoading = btn?.querySelector('.btn-loading');

    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    (btn as HTMLButtonElement).disabled = true;

    try {
      const formData = new FormData(loginForm as HTMLFormElement);
      const username = formData.get('username') as string;
      const password = formData.get('password') as string;

      if (!username || !password) {
        alert('请输入用户名和密码');
        return;
      }

      console.log('[Login] Attempting login for user:', username);
      
      const result = await apiRequest('/api/trading/login', {
        method: 'POST',
        body: JSON.stringify({ username, password })
      });

      console.log('[Login] API response:', result);

      if (result.success) {
        console.log('[Login] Login successful, saving token and showing dashboard...');
        // 保存 token 到 localStorage
        if (result.token) {
          setTradingToken(result.token);
        }
        showDashboard();
      } else {
        const errorMsg = result.error || '登录失败';
        console.error('[Login] Login failed:', errorMsg);
        alert(errorMsg);
      }
    } catch (error) {
      console.error('[Login] Exception:', error);
      alert('登录请求失败，请检查网络连接');
    } finally {
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  function updateBuyTotal() {
    const price = parseFloat((document.getElementById('buy-price') as HTMLInputElement)?.value) || 0;
    const quantity = parseFloat((document.getElementById('buy-quantity') as HTMLInputElement)?.value) || 0;
    const total = price * quantity;
    (document.getElementById('buy-total') as HTMLElement).textContent = formatCurrency(total);
  }

  function updateSellTotal() {
    const price = parseFloat((document.getElementById('sell-price') as HTMLInputElement)?.value) || 0;
    const quantity = parseFloat((document.getElementById('sell-quantity') as HTMLInputElement)?.value) || 0;
    const total = price * quantity;
    (document.getElementById('sell-total') as HTMLElement).textContent = formatCurrency(total);
  }

  document.getElementById('buy-price')?.addEventListener('input', updateBuyTotal);
  document.getElementById('buy-quantity')?.addEventListener('input', updateBuyTotal);
  document.getElementById('sell-price')?.addEventListener('input', updateSellTotal);
  document.getElementById('sell-quantity')?.addEventListener('input', updateSellTotal);

  buyForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const price = parseFloat((document.getElementById('buy-price') as HTMLInputElement)?.value);
    const quantity = parseFloat((document.getElementById('buy-quantity') as HTMLInputElement)?.value);
    const notes = (document.getElementById('buy-notes') as HTMLInputElement)?.value;

    try {
      const result = await apiRequest('/api/trading/buy', {
        method: 'POST',
        body: JSON.stringify({ price, quantity, notes })
      });

      if (result.success) {
        (buyForm as HTMLFormElement).reset();
        (document.getElementById('buy-total') as HTMLElement).textContent = '¥0.00';
        loadDashboard();
        alert('买入记录已保存');
      } else {
        alert(result.error || 'Failed to save');
      }
    } catch (error) {
      console.error('Buy failed:', error);
      alert('Failed to save');
    }
  });

  sellForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const price = parseFloat((document.getElementById('sell-price') as HTMLInputElement)?.value);
    const quantity = parseFloat((document.getElementById('sell-quantity') as HTMLInputElement)?.value);
    const notes = (document.getElementById('sell-notes') as HTMLInputElement)?.value;

    try {
      const result = await apiRequest('/api/trading/sell', {
        method: 'POST',
        body: JSON.stringify({ actualSellPrice: price, quantity, notes })
      });

      if (result.success) {
        (sellForm as HTMLFormElement).reset();
        (document.getElementById('sell-total') as HTMLElement).textContent = '¥0.00';
        loadDashboard();
        alert('卖出记录已保存');
      } else {
        alert(result.error || 'Failed to save');
      }
    } catch (error) {
      console.error('Sell failed:', error);
      alert('Failed to save');
    }
  });

  alertForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const alertType = (document.querySelector('input[name="alert-type"]:checked') as HTMLInputElement)?.value || 'buy';
    const targetPrice = parseFloat((document.getElementById('alert-price') as HTMLInputElement)?.value);
    const tolerance = parseFloat((document.getElementById('alert-tolerance') as HTMLInputElement)?.value) || 1.00;

    if (!targetPrice || isNaN(targetPrice) || targetPrice <= 0) {
      alert('请输入有效的目标价格');
      return;
    }

    if (isNaN(tolerance) || tolerance < 0) {
      alert('请输入有效的容错范围');
      return;
    }

    try {
      const result = await apiRequest('/api/trading/alert', {
        method: 'POST',
        body: JSON.stringify({ alertType, targetPrice, tolerance })
      });

      if (result.success) {
        (document.getElementById('alert-price') as HTMLInputElement).value = '';
        (document.getElementById('alert-tolerance') as HTMLInputElement).value = '1.00';
        loadAlerts();
        alert('预警已设置');
      } else {
        alert(result.error || 'Failed to create alert');
      }
    } catch (error) {
      console.error('Alert creation failed:', error);
      alert('Failed to create alert');
    }
  });

  document.getElementById('alert-tolerance')?.addEventListener('input', (e) => {
    const tolerance = parseFloat((e.target as HTMLInputElement).value) || 0;
    const hintText = document.getElementById('tolerance-hint-text');
    if (hintText) {
      hintText.textContent = `当价格在目标价格 ±${tolerance.toFixed(2)} 元范围内时发送提醒`;
    }
  });

  document.getElementById('alert-price')?.addEventListener('input', (e) => {
    const price = parseFloat((e.target as HTMLInputElement).value) || 0;
    const tolerance = parseFloat((document.getElementById('alert-tolerance') as HTMLInputElement)?.value) || 1.00;
    const hintText = document.getElementById('tolerance-hint-text');
    if (hintText && price > 0) {
      const minPrice = (price - tolerance).toFixed(2);
      const maxPrice = (price + tolerance).toFixed(2);
      hintText.textContent = `当价格在 ${minPrice} - ${maxPrice} 元范围内时发送提醒`;
    }
  });

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    try {
      await apiRequest('/api/trading/logout', { method: 'POST' });
    } catch (error) {
      console.error('[Logout] Error:', error);
    } finally {
      // 清除本地 token 并刷新页面
      setTradingToken(null);
      window.location.reload();
    }
  });

  document.querySelectorAll('.segment-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilterType = btn.getAttribute('data-value') || '';
      loadTransactions(1);
    });
  });

  document.getElementById('filter-sort')?.addEventListener('change', () => loadTransactions(1));

  document.getElementById('delete-modal-backdrop')?.addEventListener('click', closeDeleteModal);
  document.getElementById('delete-cancel-btn')?.addEventListener('click', closeDeleteModal);
  document.getElementById('delete-confirm-btn')?.addEventListener('click', confirmDelete);

  document.getElementById('edit-modal-backdrop')?.addEventListener('click', closeEditModal);
  document.getElementById('edit-modal-close')?.addEventListener('click', closeEditModal);
  document.getElementById('edit-cancel-btn')?.addEventListener('click', closeEditModal);
  document.getElementById('edit-transaction-form')?.addEventListener('submit', saveTransactionEdit);

  (window as any).loadTransactions = loadTransactions;
  (window as any).openDeleteModal = openDeleteModal;
  (window as any).openEditModal = openEditModal;
  (window as any).deleteAlert = deleteAlert;
  (window as any).startInlineEdit = startInlineEdit;
  (window as any).saveInlineEdit = saveInlineEdit;
  (window as any).cancelInlineEdit = cancelInlineEdit;

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    stopGoldPriceAutoRefresh();
  });

  // Initialize view - verify token before showing dashboard
  initApp();
</script>
