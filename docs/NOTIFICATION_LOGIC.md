# é‡‘ä»·é¢„è­¦é€šçŸ¥æ¨é€é€»è¾‘æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜é‡‘ä»·é¢„è­¦ç³»ç»Ÿçš„é€šçŸ¥æ¨é€é€»è¾‘ï¼ŒåŒ…æ‹¬ä¸‰ç«¯ï¼ˆEmailã€MeoWã€é£ä¹¦ï¼‰åŒæ­¥æ¨é€æœºåˆ¶ã€‚

---

## ğŸ”„ ç»Ÿä¸€é€šçŸ¥ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç»Ÿä¸€é€šçŸ¥ç³»ç»Ÿ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  è§¦å‘äº‹ä»¶        â”‚                                            â”‚
â”‚  â”‚  â€¢ ä»·æ ¼æ³¢åŠ¨      â”‚                                            â”‚
â”‚  â”‚  â€¢ åˆ†æä¿¡å·      â”‚                                            â”‚
â”‚  â”‚  â€¢ æ‰‹åŠ¨æµ‹è¯•      â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                     â”‚
â”‚           â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚          sendUnifiedNotification()                    â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚  1. å†·å´æœŸæ£€æŸ¥ (30åˆ†é’Ÿ)                          â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  2. æ¶ˆæ¯æ ¼å¼åŒ–                                   â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  3. å¹¶è¡Œå‘é€ä¸‰ç«¯é€šçŸ¥                              â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  4. ç»“æœè®°å½•                                     â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  5. æ›´æ–°å†·å´æ—¶é—´                                 â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                               â”‚
â”‚     â”‚           â”‚                                               â”‚
â”‚     â–¼           â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚Email â”‚   â”‚é£ä¹¦  â”‚   â”‚MeoW  â”‚                                â”‚
â”‚  â”‚      â”‚   â”‚      â”‚   â”‚      â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ¨é€è§¦å‘é€»è¾‘

### 1. ä»·æ ¼æ³¢åŠ¨é¢„è­¦æ¨é€

**è§¦å‘æ¡ä»¶**:
- æ»‘åŠ¨çª—å£æ£€æµ‹ï¼šæœ€è¿‘10ä¸ªé‡‡é›†ç‚¹å†…ï¼Œæœ€é«˜ä»·ä¸æœ€ä½ä»·å·®å€¼è¶…è¿‡é˜ˆå€¼
  - å›½å†…é»„é‡‘é˜ˆå€¼ï¼š1.5 å…ƒ/å…‹
  - å›½é™…é»„é‡‘é˜ˆå€¼ï¼š5.0 ç¾å…ƒ/ç›å¸
- çŸ­æœŸæ³¢åŠ¨æ£€æµ‹ï¼šå½“å‰ä»·æ ¼ä¸æœ€è¿‘30åˆ†é’Ÿå†…ä»·æ ¼åå·®è¶…è¿‡é˜ˆå€¼

**å†·å´æœŸ**: 30åˆ†é’Ÿ

**æ¨é€æ¸ é“**: Email + é£ä¹¦ + MeoWï¼ˆåŒæ­¥æ¨é€ï¼‰

**ä»£ç ä½ç½®**:
```javascript
// works.js:3284-3298
if (alerts.length > 0) {
  const result = await sendUnifiedNotification(alerts, env, {
    notificationType: 'price_movement',
    skipCooldown: false
  });
}
```

---

### 2. æ™ºèƒ½åˆ†æä¹°å…¥ä¿¡å·æ¨é€

**è§¦å‘æ¡ä»¶**:
- æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡è¶‹åŠ¿åˆ†æ
- æ£€æµ‹åˆ°ä¹°å…¥ä¿¡å·ï¼ˆRSI < 30 æˆ– MACDé‡‘å‰ + ä»·æ ¼è§¦åŠå¸ƒæ—å¸¦ä¸‹è½¨ï¼‰
- å›½å†…æˆ–å›½é™…é‡‘ä»·ä»»ä¸€æ»¡è¶³æ¡ä»¶

**å†·å´æœŸ**: 30åˆ†é’Ÿ

**æ¨é€æ¸ é“**: Email + é£ä¹¦ + MeoWï¼ˆåŒæ­¥æ¨é€ï¼‰

**ä»£ç ä½ç½®**:
```javascript
// works.js:1878-1887
if (shouldNotify) {
  const lastNotifyKey = 'last_analysis_notify';
  const lastNotify = await env.GOLD_PRICE_CACHE.get(lastNotifyKey);
  const now = Date.now();
  const COOLDOWN = 30 * 60 * 1000;
  
  if (!lastNotify || (now - parseInt(lastNotify)) > COOLDOWN) {
    await sendAnalysisNotification(result.analysis, env);
    await env.GOLD_PRICE_CACHE.put(lastNotifyKey, String(now), { expirationTtl: 3600 });
  }
}
```

---

### 3. AIæ™ºèƒ½åˆ†æä¿¡å·æ¨é€

**è§¦å‘æ¡ä»¶**:
- æ¯åˆ†é’Ÿæ‰§è¡ŒAIåˆ†æ
- AIæ¨¡å‹ï¼ˆé€šä¹‰åƒé—® + è±†åŒ…ï¼‰ç»™å‡ºä¹°å…¥/å–å‡ºå»ºè®®
- ç½®ä¿¡åº¦è¾¾åˆ°ä¸€å®šé˜ˆå€¼
- ç”¨æˆ·å·²è®¾ç½®ä»·æ ¼é¢„è­¦

**å†·å´æœŸ**: 15åˆ†é’Ÿ

**æ¨é€æ¸ é“**: Email + é£ä¹¦ + MeoWï¼ˆåŒæ­¥æ¨é€ï¼‰

**ä»£ç ä½ç½®**:
```javascript
// works.js:1783-1809
if (combinedAnalysis.hasValue && combinedAnalysis.signals) {
  const hasActiveAlerts = tradingParams.alerts && tradingParams.alerts.length > 0;
  if (hasActiveAlerts) {
    await sendAITradingSignal(env, combinedAnalysis, crawlResult.domestic?.price, tradingParams);
  }
}
```

---

### 4. æ‰‹åŠ¨æµ‹è¯•æ¨é€

**è§¦å‘æ¡ä»¶**:
- è°ƒç”¨æµ‹è¯•API: `/api/gold/alert/test?type=all`

**å†·å´æœŸ**: æ— ï¼ˆskipCooldown: trueï¼‰

**æ¨é€æ¸ é“**: Email + é£ä¹¦ + MeoWï¼ˆåŒæ­¥æ¨é€ï¼‰

**ä»£ç ä½ç½®**:
```javascript
// works.js:4592-4608
if (type === 'all') {
  const unifiedResult = await sendUnifiedNotification(testAlerts, env, {
    notificationType: 'test',
    skipCooldown: true
  });
}
```

---

## âš™ï¸ ç»Ÿä¸€é€šçŸ¥ç³»ç»Ÿé…ç½®

### é…ç½®å‚æ•°

```javascript
const NOTIFICATION_CONFIG = {
  COOLDOWN_MINUTES: 30,  // å†·å´æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  MAX_RETRIES: 3,        // æœ€å¤§é‡è¯•æ¬¡æ•°
  RETRY_DELAY: 1000,     // é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
};
```

### å†·å´æœŸé€»è¾‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å†·å´æœŸæ£€æŸ¥é€»è¾‘                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  1. è¯»å–ä¸Šæ¬¡é€šçŸ¥æ—¶é—´æˆ³                   â”‚
â”‚     Key: notification_cooldown:{type}   â”‚
â”‚                                         â”‚
â”‚  2. è®¡ç®—æ—¶é—´å·®                          â”‚
â”‚     elapsed = now - lastNotify          â”‚
â”‚                                         â”‚
â”‚  3. åˆ¤æ–­æ˜¯å¦åœ¨å†·å´æœŸ                     â”‚
â”‚     IF elapsed < 30åˆ†é’Ÿ:                â”‚
â”‚        â†’ è·³è¿‡æ¨é€                       â”‚
â”‚        â†’ è¿”å›å‰©ä½™æ—¶é—´                   â”‚
â”‚     ELSE:                               â”‚
â”‚        â†’ ç»§ç»­æ¨é€                       â”‚
â”‚        â†’ æ›´æ–°å†·å´æ—¶é—´æˆ³                 â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¨ ä¸‰ç«¯æ¨é€è¯¦æƒ…

### 1. Email æ¨é€

**é…ç½®è¦æ±‚**:
- `RESEND_API_KEY` - Resend APIå¯†é’¥

**æ¶ˆæ¯æ ¼å¼**:
- HTMLæ ¼å¼é‚®ä»¶
- åŒ…å«ä»·æ ¼è¡¨æ ¼å’Œå›¾è¡¨
- æ·±è‰²ä¸»é¢˜è®¾è®¡
- åŒ…å«é¢„è­¦è§„åˆ™è¯´æ˜

**æ¥æ”¶é‚®ç®±**:
- metanext@foxmail.com

**å‘é€å‡½æ•°**: `sendAlertEmailWithTracking()`

---

### 2. é£ä¹¦æ¨é€

**é…ç½®è¦æ±‚**ï¼ˆäºŒé€‰ä¸€ï¼‰:
- `FEISHU_WEBHOOK` - é£ä¹¦Webhookåœ°å€
- æˆ–åŒæ—¶é…ç½®ï¼š
  - `FEISHU_APP_ID`
  - `FEISHU_APP_SECRET`
  - `FEISHU_CHAT_ID`

**æ¶ˆæ¯æ ¼å¼**:
- äº¤äº’å¼å¡ç‰‡æ¶ˆæ¯
- åŒ…å«Emojiå›¾æ ‡
- æ”¯æŒMarkdownæ ¼å¼

**å‘é€å‡½æ•°**: `sendFeishuAlertWithTracking()`

---

### 3. MeoW æ¨é€

**é…ç½®è¦æ±‚**:
- `MEOW_USER_ID` - MeoWç”¨æˆ·IDï¼ˆé»˜è®¤ï¼š5bf48882ï¼‰

**æ¶ˆæ¯æ ¼å¼**:
- çº¯æ–‡æœ¬æ¶ˆæ¯
- åŒ…å«æ ‡é¢˜å’Œé“¾æ¥

**å‘é€å‡½æ•°**: `sendMeoWAlertWithTracking()`

---

## ğŸ”„ åŒæ­¥æ¨é€æœºåˆ¶

### å¹¶è¡Œå‘é€

```javascript
// ä½¿ç”¨ Promise.allSettled å¹¶è¡Œå‘é€
const results = await Promise.allSettled([
  sendAlertEmailWithTracking(alerts, env, messageContent),
  sendFeishuAlertWithTracking(alerts, env, messageContent),
  sendMeoWAlertWithTracking(alerts, env, messageContent)
]);
```

### é”™è¯¯å¤„ç†

- ä»»ä¸€æ¸ é“å¤±è´¥ä¸å½±å“å…¶ä»–æ¸ é“
- é”™è¯¯ä¼šè¢«è®°å½•åˆ°æ—¥å¿—
- è¿”å›æ¯ä¸ªæ¸ é“çš„ç‹¬ç«‹ç»“æœ

### ç»“æœæ ¼å¼

```json
{
  "success": true,
  "results": {
    "email": {
      "channel": "email",
      "success": true
    },
    "feishu": {
      "channel": "feishu",
      "success": true,
      "method": "webhook"
    },
    "meow": {
      "channel": "meow",
      "success": true
    }
  },
  "timestamp": 1771470883239
}
```

---

## ğŸ“Š é€šçŸ¥å†å²è®°å½•

### è®°å½•å†…å®¹

```javascript
{
  timestamp: Date.now(),
  type: 'price_alert',  // é€šçŸ¥ç±»å‹
  alertCount: 2,        // é¢„è­¦æ•°é‡
  results: {
    email: { success: true },
    feishu: { success: true, method: 'webhook' },
    meow: { success: true }
  }
}
```

### å­˜å‚¨ä½ç½®

- **KV Key**: `notification_history:{YYYY-MM-DD}`
- **ä¿ç•™æ—¶é—´**: 7å¤©
- **æœ€å¤§è®°å½•æ•°**: 100æ¡/å¤©

### æŸ¥è¯¢API

```javascript
// è·å–ä»Šæ—¥é€šçŸ¥å†å²
const history = await getNotificationHistory(env);

// è·å–æŒ‡å®šæ—¥æœŸé€šçŸ¥å†å²
const history = await getNotificationHistory(env, '2026-02-19');
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æµ‹è¯•æ‰€æœ‰æ¸ é“

```bash
curl "https://api.ustc.dev/api/gold/alert/test?type=all"
```

### æµ‹è¯•å•ä¸ªæ¸ é“

```bash
# æµ‹è¯•Email
curl "https://api.ustc.dev/api/gold/alert/test?type=email"

# æµ‹è¯•é£ä¹¦
curl "https://api.ustc.dev/api/gold/alert/test?type=feishu"

# æµ‹è¯•MeoW
curl "https://api.ustc.dev/api/gold/alert/test?type=meow"
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. ä¸ºä»€ä¹ˆåªæ”¶åˆ°éƒ¨åˆ†é€šçŸ¥ï¼Ÿ

**å¯èƒ½åŸå› **:
- æŸæ¸ é“çš„APIå¯†é’¥æœªé…ç½®
- æŸæ¸ é“çš„æœåŠ¡æš‚æ—¶ä¸å¯ç”¨
- æ£€æŸ¥æ—¥å¿—æŸ¥çœ‹å…·ä½“é”™è¯¯

**æ’æŸ¥æ–¹æ³•**:
```bash
# æŸ¥çœ‹Workeræ—¥å¿—
npx wrangler tail
```

### 2. é€šçŸ¥é¢‘ç‡å¤ªé«˜ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- è°ƒæ•´ `NOTIFICATION_CONFIG.COOLDOWN_MINUTES`
- ä¿®æ”¹ä»·æ ¼æ³¢åŠ¨é˜ˆå€¼
- å…³é—­æŸäº›ç±»å‹çš„é€šçŸ¥

### 3. å¦‚ä½•ä¸´æ—¶ç¦ç”¨æŸä¸ªæ¸ é“ï¼Ÿ

**æ–¹æ³•**:
- åˆ é™¤å¯¹åº”çš„ç¯å¢ƒå˜é‡
- æˆ–è®¾ç½®æ— æ•ˆçš„é…ç½®å€¼

---

## ğŸ”§ é…ç½®æ£€æŸ¥æ¸…å•

### å¿…éœ€é…ç½®

- [ ] `RESEND_API_KEY` - Emailé€šçŸ¥
- [ ] `FEISHU_WEBHOOK` æˆ– (`FEISHU_APP_ID` + `FEISHU_APP_SECRET` + `FEISHU_CHAT_ID`) - é£ä¹¦é€šçŸ¥
- [ ] `MEOW_USER_ID` - MeoWé€šçŸ¥ï¼ˆå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼ï¼‰

### éªŒè¯é…ç½®

```bash
# æ£€æŸ¥é…ç½®çŠ¶æ€
curl "https://api.ustc.dev/api/gold/alert/test?type=all"
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### æ¨é€æˆåŠŸç‡

```
æ¨é€æˆåŠŸç‡ = æˆåŠŸæ¨é€æ¬¡æ•° / æ€»æ¨é€æ¬¡æ•° Ã— 100%
```

### å„æ¸ é“å»¶è¿Ÿ

- Email: ~1-3ç§’
- é£ä¹¦: ~500ms-1ç§’
- MeoW: ~300ms-800ms

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2026-02-19
- âœ… ä¿®å¤ä¸‰ç«¯ä¸åŒæ­¥æ¨é€é—®é¢˜
- âœ… å®ç°ç»Ÿä¸€é€šçŸ¥ç³»ç»Ÿ
- âœ… æ·»åŠ é€šçŸ¥å†å²è®°å½•åŠŸèƒ½
- âœ… ä¼˜åŒ–å†·å´æœŸé€»è¾‘

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-02-19
