# 通知频率配置文档

## 📋 更新后的通知频率配置

### 当前配置（2026-02-19更新）

| 通知类型 | 触发频率 | 冷却期 | 推送渠道 |
|---------|---------|--------|---------|
| **价格波动预警** | 实时检测 | **1分钟** | Email + 飞书 + MeoW |
| **智能分析买入信号** | 每5分钟分析 | **5分钟** | Email + 飞书 + MeoW |
| **AI分析信号** | 每分钟分析 | **2分钟** | Email + 飞书 + MeoW |

---

## ⚙️ 详细配置

### 1. 价格波动预警

**检测频率**: 每分钟
**冷却期**: 1分钟
**触发条件**:
- 滑动窗口检测：最近10个采集点内波动超过阈值
  - 国内黄金：1.5 元/克
  - 国际黄金：5.0 美元/盎司
- 短期波动检测：30分钟内价格偏差超过阈值

**代码位置**:
```javascript
// works.js:3204
ALERT_CONFIG: {
  COOLDOWN_MINUTES: 1,  // 1分钟冷却期
  WINDOW_SIZE: 10,      // 滑动窗口大小
  SHORT_TERM_MINUTES: 30, // 短期检测时间范围
  DOMESTIC_THRESHOLD: 1.5,    // 国内阈值
  INTERNATIONAL_THRESHOLD: 5.0 // 国际阈值
}
```

---

### 2. 智能分析买入信号

**分析频率**: 每5分钟
**冷却期**: 5分钟
**触发条件**:
- RSI < 30（超卖）
- MACD金叉 + 价格触及布林带下轨
- 国内或国际金价任一满足条件

**代码位置**:
```javascript
// works.js:1879
const COOLDOWN = 5 * 60 * 1000; // 5分钟冷却期
```

---

### 3. AI分析信号

**分析频率**: 每分钟
**冷却期**: 2分钟
**触发条件**:
- 通义千问 + 豆包 AI模型给出交易建议
- 置信度达到一定阈值
- 用户已设置价格预警

**代码位置**:
```javascript
// works.js:1787
const COOLDOWN = 2 * 60 * 1000; // 2分钟冷却期
```

---

## 🔄 定时任务配置

```cron
*/1 * * * *  # 每分钟：金价爬取 + AI分析 + 价格波动检测
*/2 * * * *  # 每2分钟：（保留）
*/5 * * * *  # 每5分钟：趋势分析 + 智能分析买入信号检测
0 0 * * *    # 每日零点：数据清理
```

---

## 📊 通知触发流程

```
每分钟执行:
  ├─> 爬取金价数据
  ├─> 检测价格波动（1分钟冷却）
  └─> AI分析（2分钟冷却）
       └─> 如有信号 → 三端同步推送

每5分钟执行:
  └─> 趋势分析（5分钟冷却）
       └─> 如有买入信号 → 三端同步推送
```

---

## ⚠️ 注意事项

### 频率限制
- **通义千问API**: 每分钟最多20次调用
- **豆包API**: 每分钟最多20次调用
- 当前配置：1次/分钟，符合限制

### 防骚扰机制
- 即使满足触发条件，冷却期内不会重复发送
- 各通知类型有独立的冷却期计时器

### 测试方法
```bash
# 测试价格波动预警（1分钟冷却）
curl "https://api.ustc.dev/api/gold/alert/test?type=all"

# 查看通知历史
curl "https://api.ustc.dev/api/gold/ai-analysis"
```

---

## 🔧 修改历史

### 2026-02-19
- ✅ 价格波动预警冷却期：30分钟 → **1分钟**
- ✅ 智能分析买入信号冷却期：30分钟 → **5分钟**
- ✅ AI分析信号冷却期：15分钟 → **2分钟**

---

**文档版本**: v1.1  
**最后更新**: 2026-02-19
